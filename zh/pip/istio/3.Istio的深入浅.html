<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://isKcount/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html"><meta property="og:site_name" content="æ–‡æ¡£æ¼”ç¤º"><meta property="og:title" content="Istioç”±æµ…å…¥æ·±"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-10-11T17:30:38.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:published_time" content="2022-04-01T13:59:49.000Z"><meta property="article:modified_time" content="2022-10-11T17:30:38.000Z"><link rel="icon" href="/cicd/favicon.ico"><link rel="icon" href="/cicd/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/cicd/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/cicd/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/cicd/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/cicd/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/cicd/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/cicd/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Istioç”±æµ…å…¥æ·± | æ–‡æ¡£æ¼”ç¤º</title><meta name="description" content="vuepress-theme-hope çš„æ–‡æ¡£æ¼”ç¤º">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/cicd/assets/style.b0cf8135.css">
    <link rel="modulepreload" href="/cicd/assets/app.4cf02e25.js"><link rel="modulepreload" href="/cicd/assets/3.Istioçš„æ·±å…¥æµ….html.d60ecce2.js"><link rel="modulepreload" href="/cicd/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/cicd/assets/3.Istioçš„æ·±å…¥æµ….html.aff1e3cf.js"><link rel="prefetch" href="/cicd/assets/index.html.afb960cd.js"><link rel="prefetch" href="/cicd/assets/slides.html.75632ce0.js"><link rel="prefetch" href="/cicd/assets/disable.html.69aa87b2.js"><link rel="prefetch" href="/cicd/assets/encrypt.html.b6670895.js"><link rel="prefetch" href="/cicd/assets/markdown.html.b609aecf.js"><link rel="prefetch" href="/cicd/assets/page.html.54ab5bbb.js"><link rel="prefetch" href="/cicd/assets/index.html.45befc19.js"><link rel="prefetch" href="/cicd/assets/index.html.35bc4860.js"><link rel="prefetch" href="/cicd/assets/index.html.0bac633c.js"><link rel="prefetch" href="/cicd/assets/index.html.d697902a.js"><link rel="prefetch" href="/cicd/assets/baz.html.5f57b04e.js"><link rel="prefetch" href="/cicd/assets/index.html.6a953184.js"><link rel="prefetch" href="/cicd/assets/ray.html.e211c123.js"><link rel="prefetch" href="/cicd/assets/index.html.30154021.js"><link rel="prefetch" href="/cicd/assets/kaifa.html.1bb6461e.js"><link rel="prefetch" href="/cicd/assets/qukuailian.html.555b2023.js"><link rel="prefetch" href="/cicd/assets/index.html.430b7fe5.js"><link rel="prefetch" href="/cicd/assets/yunwei.html.64158b4e.js"><link rel="prefetch" href="/cicd/assets/CKA.html.0957d054.js"><link rel="prefetch" href="/cicd/assets/CKS.html.bd413494.js"><link rel="prefetch" href="/cicd/assets/index.html.ceda1bd4.js"><link rel="prefetch" href="/cicd/assets/è½¯ä»¶è®¾è®¡å¸ˆ.html.c5d81eaa.js"><link rel="prefetch" href="/cicd/assets/Goå¼€å‘.html.9a880fcf.js"><link rel="prefetch" href="/cicd/assets/Javaå¼€å‘.html.d877b9be.js"><link rel="prefetch" href="/cicd/assets/index.html.4068cd31.js"><link rel="prefetch" href="/cicd/assets/Ajax.html.dd9a85f6.js"><link rel="prefetch" href="/cicd/assets/CSS3.html.91a2e19a.js"><link rel="prefetch" href="/cicd/assets/HTML5.html.d4b38488.js"><link rel="prefetch" href="/cicd/assets/JavaScript DOM.html.9eaa65d5.js"><link rel="prefetch" href="/cicd/assets/JavaScriptå¼€ç¯‡.html.f60fb2e1.js"><link rel="prefetch" href="/cicd/assets/JavaScripté¢å‘å¯¹è±¡.html.da218289.js"><link rel="prefetch" href="/cicd/assets/JQuery.html.ae656a54.js"><link rel="prefetch" href="/cicd/assets/index.html.4e9fd026.js"><link rel="prefetch" href="/cicd/assets/Vue.html.3596c5e3.js"><link rel="prefetch" href="/cicd/assets/1.Gitlab-CIå…¥é—¨é…ç½®.html.8757c890.js"><link rel="prefetch" href="/cicd/assets/2.Gitlab-Runerè¿æ¥K8S.html.ceb7ae20.js"><link rel="prefetch" href="/cicd/assets/3.GitLab-CI _ Harbor _ Kubernetes.html.b7ec02df.js"><link rel="prefetch" href="/cicd/assets/4.Gitea_K8s-Jenkins-master-slave(webhooké’©å­).html.01e740cd.js"><link rel="prefetch" href="/cicd/assets/index.html.080ddb9c.js"><link rel="prefetch" href="/cicd/assets/1.Istioæ¦‚è¿°.html.9ddaefd7.js"><link rel="prefetch" href="/cicd/assets/2.Istioå®‰è£….html.0bd57f85.js"><link rel="prefetch" href="/cicd/assets/4.Istioç»ƒä¹ é¢˜.html.8fd3b51c.js"><link rel="prefetch" href="/cicd/assets/index.html.293eb095.js"><link rel="prefetch" href="/cicd/assets/1.æ·±å…¥ç†è§£Operator.html.1f267c48.js"><link rel="prefetch" href="/cicd/assets/2.RESTclientåŸç†.html.18487112.js"><link rel="prefetch" href="/cicd/assets/3.è®¿é—®Kubernetes API.html.da101cae.js"><link rel="prefetch" href="/cicd/assets/4.ä¸€æ–‡ææ‡‚CRD.html.392b012e.js"><link rel="prefetch" href="/cicd/assets/index.html.0f03a0a3.js"><link rel="prefetch" href="/cicd/assets/1.å¸¸ç”¨Gitå‘½ä»¤æ¸…å•.html.2cb1df75.js"><link rel="prefetch" href="/cicd/assets/10.Gitåˆ†æ”¯-å˜åŸº.html.b947479b.js"><link rel="prefetch" href="/cicd/assets/11.Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬.html.10aa9bfe.js"><link rel="prefetch" href="/cicd/assets/12.Gitå·¥å…·-äº¤äº’å¼æš‚å­˜.html.48884ded.js"><link rel="prefetch" href="/cicd/assets/13.Gitå·¥å…·-é‡å†™å†å².html.5d5eaa80.js"><link rel="prefetch" href="/cicd/assets/14.Gitå·¥å…·-é‡ç½®æ­å¯†.html.6633ce8a.js"><link rel="prefetch" href="/cicd/assets/2.Gitå˜åŸºåˆå¹¶.html.fa3da0d8.js"><link rel="prefetch" href="/cicd/assets/3.Gitå‘½ä»¤æ€ç»´å¯¼å›¾.html.15c6e161.js"><link rel="prefetch" href="/cicd/assets/4.GitåŸºç¡€ä¸å‘½ä»¤.html.73f55f94.js"><link rel="prefetch" href="/cicd/assets/5.Gitåˆ†æ”¯-åˆ†æ”¯åŸç†.html.3ec450a8.js"><link rel="prefetch" href="/cicd/assets/6.Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ.html.014f3285.js"><link rel="prefetch" href="/cicd/assets/7.Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯.html.675bcb4c.js"><link rel="prefetch" href="/cicd/assets/8.Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ.html.d8b4cc3b.js"><link rel="prefetch" href="/cicd/assets/9.Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯.html.84949e28.js"><link rel="prefetch" href="/cicd/assets/index.html.600de791.js"><link rel="prefetch" href="/cicd/assets/01.åˆè¯†Kubernetes.html.eaa4f1ed.js"><link rel="prefetch" href="/cicd/assets/02.Kuberneteséƒ¨ç½².html.87861ae6.js"><link rel="prefetch" href="/cicd/assets/03.Containerdæ­å»ºKubernets.html.bc40478f.js"><link rel="prefetch" href="/cicd/assets/04.kubernetesåŸºæœ¬æ“ä½œ.html.7561f03f.js"><link rel="prefetch" href="/cicd/assets/05.Kubernetesç›‘æ§ä¸æ—¥å¿—ç®¡ç†.html.b39e53f4.js"><link rel="prefetch" href="/cicd/assets/06.Kubernetesåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç†.html.e31aed57.js"><link rel="prefetch" href="/cicd/assets/07.Kubernetesè°ƒåº¦.html.78a978fa.js"><link rel="prefetch" href="/cicd/assets/08.Kubernetesç½‘ç»œ.html.cde7916b.js"><link rel="prefetch" href="/cicd/assets/09.Kuberneteså­˜å‚¨.html.a76219a7.js"><link rel="prefetch" href="/cicd/assets/10.Kuberneteså®‰å…¨.html.a097f54b.js"><link rel="prefetch" href="/cicd/assets/11.Kubernetesé›†ç¾¤ç»´æŠ¤.html.d71c9de0.js"><link rel="prefetch" href="/cicd/assets/12.Kubernetesé›†ç¾¤æ•…éšœæ’æŸ¥.html.8c63d7cb.js"><link rel="prefetch" href="/cicd/assets/13.Helm.html.9b520a1c.js"><link rel="prefetch" href="/cicd/assets/14.é«˜çº§è¿ç»´.html.6fd84512.js"><link rel="prefetch" href="/cicd/assets/15.NFSåšK8Såç«¯å­˜å‚¨.html.fad20088.js"><link rel="prefetch" href="/cicd/assets/16.Glusterfså¯¹æ¥K8S.html.ed2e5510.js"><link rel="prefetch" href="/cicd/assets/17.Cephå¯¹æ¥K8Så­˜å‚¨(RBD).html.5e02a595.js"><link rel="prefetch" href="/cicd/assets/18.Rookæ„å»ºCephäº‘åŸç”Ÿå­˜å‚¨.html.9ba766b8.js"><link rel="prefetch" href="/cicd/assets/19.Kubectlå¤šé›†ç¾¤é…ç½®.html.33834959.js"><link rel="prefetch" href="/cicd/assets/20.ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™è®¡ç®—èµ„æº.html.8e9298af.js"><link rel="prefetch" href="/cicd/assets/21.Helmæ­å»ºEFKæ—¥å¿—ç³»ç»Ÿ.html.4edbf6a4.js"><link rel="prefetch" href="/cicd/assets/22.Kubernetesçš„client-Python.html.c60456d9.js"><link rel="prefetch" href="/cicd/assets/23.kubectlå‘½ä»¤.html.8b18dbe9.js"><link rel="prefetch" href="/cicd/assets/01.é›†ç¾¤éƒ¨ç½²ä¸å®‰å…¨é…ç½®.html.b6b4f70f.js"><link rel="prefetch" href="/cicd/assets/02.é›†ç¾¤å¼ºåŒ–.html.fad18f43.js"><link rel="prefetch" href="/cicd/assets/03.å®¹å™¨è¿è¡Œç¯å¢ƒå®‰å…¨åŠ å›º.html.053ca706.js"><link rel="prefetch" href="/cicd/assets/04.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´.html.7b3b9ade.js"><link rel="prefetch" href="/cicd/assets/05.ä¾›åº”é“¾å®‰å…¨.html.a0900434.js"><link rel="prefetch" href="/cicd/assets/06.ç›‘æ§ã€å®¡è®¡å’Œè¿è¡Œæ—¶å®‰å…¨.html.7e2ba24b.js"><link rel="prefetch" href="/cicd/assets/index.html.c616b064.js"><link rel="prefetch" href="/cicd/assets/index.html.15eb079a.js"><link rel="prefetch" href="/cicd/assets/index.html.94ea93f5.js"><link rel="prefetch" href="/cicd/assets/index.html.079b2772.js"><link rel="prefetch" href="/cicd/assets/index.html.df3f4c13.js"><link rel="prefetch" href="/cicd/assets/index.html.0e6fd612.js"><link rel="prefetch" href="/cicd/assets/01.Cephéƒ¨ç½².html.c7edc1a7.js"><link rel="prefetch" href="/cicd/assets/01.Elasticsearchæ•™ç¨‹.html.c70bc6f4.js"><link rel="prefetch" href="/cicd/assets/02.SpringBootæ•´åˆES.html.58d48662.js"><link rel="prefetch" href="/cicd/assets/01.NginxåŸºç¡€.html.cf2f1274.js"><link rel="prefetch" href="/cicd/assets/02.Nginxåå‘ä»£ç†.html.5c1d75f4.js"><link rel="prefetch" href="/cicd/assets/03.Nginxè´Ÿè½½å‡è¡¡.html.01375d35.js"><link rel="prefetch" href="/cicd/assets/04.NginxåŠ¨é™åˆ†ç¦».html.567ee358.js"><link rel="prefetch" href="/cicd/assets/05.Nginxé«˜å¯ç”¨.html.e6a3ddc7.js"><link rel="prefetch" href="/cicd/assets/01.MySQLå®‰è£….html.a857908f.js"><link rel="prefetch" href="/cicd/assets/02.MySQLæ¦‚è¿°.html.215c677f.js"><link rel="prefetch" href="/cicd/assets/03.MySQLçš„SQLè¯¦è§£.html.b436424d.js"><link rel="prefetch" href="/cicd/assets/04.MySQLçš„å‡½æ•°.html.f2d51481.js"><link rel="prefetch" href="/cicd/assets/05.MySQLçš„çº¦æŸ.html.bad191da.js"><link rel="prefetch" href="/cicd/assets/06.MySQLå¤šè¡¨æŸ¥è¯¢.html.36361e11.js"><link rel="prefetch" href="/cicd/assets/07.MySQLçš„äº‹åŠ¡.html.9cb08bc8.js"><link rel="prefetch" href="/cicd/assets/08.MySQLç´¢å¼•.html.a88e7348.js"><link rel="prefetch" href="/cicd/assets/01.Redisè¯¦è§£.html.74500c58.js"><link rel="prefetch" href="/cicd/assets/02.SpringBootæ•´åˆRedis.html.469f0ecc.js"><link rel="prefetch" href="/cicd/assets/1.html.51ad6998.js"><link rel="prefetch" href="/cicd/assets/10.html.9f9ea17a.js"><link rel="prefetch" href="/cicd/assets/2.html.b10c281c.js"><link rel="prefetch" href="/cicd/assets/3.html.e9f1871a.js"><link rel="prefetch" href="/cicd/assets/4.html.1fff6eef.js"><link rel="prefetch" href="/cicd/assets/5.html.97811964.js"><link rel="prefetch" href="/cicd/assets/6.html.8b926579.js"><link rel="prefetch" href="/cicd/assets/7.html.46240a78.js"><link rel="prefetch" href="/cicd/assets/8.html.8a1b2295.js"><link rel="prefetch" href="/cicd/assets/9.html.4409806f.js"><link rel="prefetch" href="/cicd/assets/1.html.9af07abf.js"><link rel="prefetch" href="/cicd/assets/2.html.2fcadf0b.js"><link rel="prefetch" href="/cicd/assets/3.html.f030d923.js"><link rel="prefetch" href="/cicd/assets/4.html.470bb9d1.js"><link rel="prefetch" href="/cicd/assets/5.html.f01a11dd.js"><link rel="prefetch" href="/cicd/assets/6.html.8186092c.js"><link rel="prefetch" href="/cicd/assets/7.html.6fc24329.js"><link rel="prefetch" href="/cicd/assets/8.html.10ead5f0.js"><link rel="prefetch" href="/cicd/assets/9.html.41d3dbca.js"><link rel="prefetch" href="/cicd/assets/10.html.4cebe03d.js"><link rel="prefetch" href="/cicd/assets/11.html.8f240263.js"><link rel="prefetch" href="/cicd/assets/2.html.5569587e.js"><link rel="prefetch" href="/cicd/assets/3.html.9a65d44c.js"><link rel="prefetch" href="/cicd/assets/4.html.75bbb016.js"><link rel="prefetch" href="/cicd/assets/5.html.d4539629.js"><link rel="prefetch" href="/cicd/assets/6.html.36bd59fc.js"><link rel="prefetch" href="/cicd/assets/7.html.4486fb3b.js"><link rel="prefetch" href="/cicd/assets/8.html.0197b422.js"><link rel="prefetch" href="/cicd/assets/9.html.6884113c.js"><link rel="prefetch" href="/cicd/assets/awk.html.f6d4fea2.js"><link rel="prefetch" href="/cicd/assets/01.Javaç¯å¢ƒé…ç½®.html.9a82b76a.js"><link rel="prefetch" href="/cicd/assets/02.JavaåŸºç¡€æ¦‚å¿µ.html.371f29d8.js"><link rel="prefetch" href="/cicd/assets/03.Javaè¿ç®—ç¬¦.html.aaf325c2.js"><link rel="prefetch" href="/cicd/assets/04.Javaå¾ªç¯å’Œåˆ¤æ–­.html.167b49db.js"><link rel="prefetch" href="/cicd/assets/05.Javaå¾ªç¯é«˜çº§å’Œæ•°ç»„.html.ee86ed78.js"><link rel="prefetch" href="/cicd/assets/06.Javaæ–¹æ³•.html.b0098a64.js"><link rel="prefetch" href="/cicd/assets/07.Javaé¢å‘å¯¹è±¡.html.3e5a2e10.js"><link rel="prefetch" href="/cicd/assets/08.Javaå­—ç¬¦ä¸².html.226000a4.js"><link rel="prefetch" href="/cicd/assets/00.Javaé¢å¯¹å¯¹è±¡è¿›é˜¶.html.89001477.js"><link rel="prefetch" href="/cicd/assets/01.æ—¥æœŸå’Œæ—¶é—´.html.1fa0d266.js"><link rel="prefetch" href="/cicd/assets/02.æ­£åˆ™è¡¨è¾¾å¼.html.692fb7f2.js"><link rel="prefetch" href="/cicd/assets/03.é›†åˆ.html.7aef52e6.js"><link rel="prefetch" href="/cicd/assets/04.Streamæµ.html.22c04447.js"><link rel="prefetch" href="/cicd/assets/05.å¼‚å¸¸å¤„ç†.html.0bcfd771.js"><link rel="prefetch" href="/cicd/assets/06.æ—¥å¿—æ¡†æ¶.html.7c3b687d.js"><link rel="prefetch" href="/cicd/assets/07.Fileç±»ã€IOæµ.html.95b3fdca.js"><link rel="prefetch" href="/cicd/assets/08.IOæµè¿›é˜¶.html.b0ff2a19.js"><link rel="prefetch" href="/cicd/assets/09.å¤šçº¿ç¨‹.html.36474e00.js"><link rel="prefetch" href="/cicd/assets/10.ç½‘ç»œç¼–ç¨‹.html.00117829.js"><link rel="prefetch" href="/cicd/assets/11.å•å…ƒæµ‹è¯•å’Œåå°„.html.0c2e7d58.js"><link rel="prefetch" href="/cicd/assets/12.æ³¨è§£å’ŒåŠ¨æ€ä»£ç†.html.3f4f6fc8.js"><link rel="prefetch" href="/cicd/assets/13.XMLå’Œè®¾è®¡æ¨¡å¼.html.15865193.js"><link rel="prefetch" href="/cicd/assets/01.SpringBootå¿«é€Ÿå…¥é—¨.html.36346b67.js"><link rel="prefetch" href="/cicd/assets/02.SpringBooté…ç½®æ–‡ä»¶.html.faa01534.js"><link rel="prefetch" href="/cicd/assets/03.æ•´åˆJunitå’ŒMybatis.html.8df025df.js"><link rel="prefetch" href="/cicd/assets/04.SpringBootæ—¥å¿—.html.0753c3c2.js"><link rel="prefetch" href="/cicd/assets/05.SpringBootå¸¸ç”¨æ³¨è§£.html.60025afe.js"><link rel="prefetch" href="/cicd/assets/06.SpringBootå¼€å‘é…ç½®.html.d06a3ecf.js"><link rel="prefetch" href="/cicd/assets/07.SpringBootæ•°æ®å±‚æ–¹æ¡ˆ.html.7249472a.js"><link rel="prefetch" href="/cicd/assets/08.SpringBootæ•´åˆç¬¬ä¸‰æ–¹æŠ€æœ¯.html.99e6c044.js"><link rel="prefetch" href="/cicd/assets/01.Springçš„IoCå’ŒDI.html.a9b2e188.js"><link rel="prefetch" href="/cicd/assets/02.IoCå’ŒDIæ³¨è§£å¼€å‘.html.d0c453d8.js"><link rel="prefetch" href="/cicd/assets/03.Springçš„MVCå…¥é—¨.html.5697eb9d.js"><link rel="prefetch" href="/cicd/assets/04.SpringMVCçš„è¯·æ±‚å’Œå“åº”.html.5c7a7c1c.js"><link rel="prefetch" href="/cicd/assets/05.Springæ•´åˆJdbc.html.9902e59c.js"><link rel="prefetch" href="/cicd/assets/06.SpringMVCé¡¹ç›®çš„å¸¸ç”¨é…ç½®.html.df7d7078.js"><link rel="prefetch" href="/cicd/assets/07.SpringMVCæ‹¦æˆªå™¨.html.a7993a74.js"><link rel="prefetch" href="/cicd/assets/08.Springçš„å¼‚å¸¸å¤„ç†.html.ec7b0c4b.js"><link rel="prefetch" href="/cicd/assets/09.Springçš„AOP.html.ee2e4e31.js"><link rel="prefetch" href="/cicd/assets/10.Springçš„äº‹åŠ¡ç®¡ç†.html.e0ef8186.js"><link rel="prefetch" href="/cicd/assets/11.Mybatiså…¥é—¨.html.a9e5f73e.js"><link rel="prefetch" href="/cicd/assets/12.Mybatiså¤šè¡¨æŸ¥è¯¢.html.a4eb2c6e.js"><link rel="prefetch" href="/cicd/assets/13.Mybatisæ³¨è§£å¼€å‘.html.0724863a.js"><link rel="prefetch" href="/cicd/assets/14.MyBatisPlus.html.3ee508f1.js"><link rel="prefetch" href="/cicd/assets/404.html.982bee40.js"><link rel="prefetch" href="/cicd/assets/index.html.a2a1c31f.js"><link rel="prefetch" href="/cicd/assets/slides.html.6bbddf5e.js"><link rel="prefetch" href="/cicd/assets/disable.html.95e3aa74.js"><link rel="prefetch" href="/cicd/assets/encrypt.html.be1cd07d.js"><link rel="prefetch" href="/cicd/assets/markdown.html.07291620.js"><link rel="prefetch" href="/cicd/assets/page.html.efe64bc0.js"><link rel="prefetch" href="/cicd/assets/index.html.6daa34f0.js"><link rel="prefetch" href="/cicd/assets/index.html.13b82c1e.js"><link rel="prefetch" href="/cicd/assets/index.html.62d9f295.js"><link rel="prefetch" href="/cicd/assets/index.html.cdece030.js"><link rel="prefetch" href="/cicd/assets/baz.html.71f6f9c1.js"><link rel="prefetch" href="/cicd/assets/index.html.3c998f77.js"><link rel="prefetch" href="/cicd/assets/ray.html.c0ffbf8e.js"><link rel="prefetch" href="/cicd/assets/index.html.b9c72545.js"><link rel="prefetch" href="/cicd/assets/kaifa.html.e4e427e1.js"><link rel="prefetch" href="/cicd/assets/qukuailian.html.3a3f9161.js"><link rel="prefetch" href="/cicd/assets/index.html.4a3f7919.js"><link rel="prefetch" href="/cicd/assets/yunwei.html.b80da8e6.js"><link rel="prefetch" href="/cicd/assets/CKA.html.4fa6fe9b.js"><link rel="prefetch" href="/cicd/assets/CKS.html.70dc4199.js"><link rel="prefetch" href="/cicd/assets/index.html.22cb33eb.js"><link rel="prefetch" href="/cicd/assets/è½¯ä»¶è®¾è®¡å¸ˆ.html.acd3b108.js"><link rel="prefetch" href="/cicd/assets/Goå¼€å‘.html.0260ea94.js"><link rel="prefetch" href="/cicd/assets/Javaå¼€å‘.html.05229914.js"><link rel="prefetch" href="/cicd/assets/index.html.45da941e.js"><link rel="prefetch" href="/cicd/assets/Ajax.html.65ada00f.js"><link rel="prefetch" href="/cicd/assets/CSS3.html.a56db5bd.js"><link rel="prefetch" href="/cicd/assets/HTML5.html.178971c0.js"><link rel="prefetch" href="/cicd/assets/JavaScript DOM.html.4e057b6a.js"><link rel="prefetch" href="/cicd/assets/JavaScriptå¼€ç¯‡.html.e94d748e.js"><link rel="prefetch" href="/cicd/assets/JavaScripté¢å‘å¯¹è±¡.html.88b3d982.js"><link rel="prefetch" href="/cicd/assets/JQuery.html.8057b349.js"><link rel="prefetch" href="/cicd/assets/index.html.a6892502.js"><link rel="prefetch" href="/cicd/assets/Vue.html.64efef8c.js"><link rel="prefetch" href="/cicd/assets/1.Gitlab-CIå…¥é—¨é…ç½®.html.843f6524.js"><link rel="prefetch" href="/cicd/assets/2.Gitlab-Runerè¿æ¥K8S.html.94571695.js"><link rel="prefetch" href="/cicd/assets/3.GitLab-CI _ Harbor _ Kubernetes.html.62744790.js"><link rel="prefetch" href="/cicd/assets/4.Gitea_K8s-Jenkins-master-slave(webhooké’©å­).html.fb8fbb35.js"><link rel="prefetch" href="/cicd/assets/index.html.240d8ec8.js"><link rel="prefetch" href="/cicd/assets/1.Istioæ¦‚è¿°.html.0b22cafd.js"><link rel="prefetch" href="/cicd/assets/2.Istioå®‰è£….html.f6f954c2.js"><link rel="prefetch" href="/cicd/assets/4.Istioç»ƒä¹ é¢˜.html.e13d5263.js"><link rel="prefetch" href="/cicd/assets/index.html.e513eb42.js"><link rel="prefetch" href="/cicd/assets/1.æ·±å…¥ç†è§£Operator.html.f92497be.js"><link rel="prefetch" href="/cicd/assets/2.RESTclientåŸç†.html.e8ff63dd.js"><link rel="prefetch" href="/cicd/assets/3.è®¿é—®Kubernetes API.html.4e49043e.js"><link rel="prefetch" href="/cicd/assets/4.ä¸€æ–‡ææ‡‚CRD.html.76a67cd5.js"><link rel="prefetch" href="/cicd/assets/index.html.6a4fd79e.js"><link rel="prefetch" href="/cicd/assets/1.å¸¸ç”¨Gitå‘½ä»¤æ¸…å•.html.7ff17fa9.js"><link rel="prefetch" href="/cicd/assets/10.Gitåˆ†æ”¯-å˜åŸº.html.d9d5fc96.js"><link rel="prefetch" href="/cicd/assets/11.Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬.html.ea0c9522.js"><link rel="prefetch" href="/cicd/assets/12.Gitå·¥å…·-äº¤äº’å¼æš‚å­˜.html.71a1ebc3.js"><link rel="prefetch" href="/cicd/assets/13.Gitå·¥å…·-é‡å†™å†å².html.de8b88f9.js"><link rel="prefetch" href="/cicd/assets/14.Gitå·¥å…·-é‡ç½®æ­å¯†.html.3cd77c28.js"><link rel="prefetch" href="/cicd/assets/2.Gitå˜åŸºåˆå¹¶.html.213a717c.js"><link rel="prefetch" href="/cicd/assets/3.Gitå‘½ä»¤æ€ç»´å¯¼å›¾.html.038c27f5.js"><link rel="prefetch" href="/cicd/assets/4.GitåŸºç¡€ä¸å‘½ä»¤.html.60ed1571.js"><link rel="prefetch" href="/cicd/assets/5.Gitåˆ†æ”¯-åˆ†æ”¯åŸç†.html.b6cdc2db.js"><link rel="prefetch" href="/cicd/assets/6.Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ.html.f7495958.js"><link rel="prefetch" href="/cicd/assets/7.Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯.html.cbe5b302.js"><link rel="prefetch" href="/cicd/assets/8.Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ.html.a3773721.js"><link rel="prefetch" href="/cicd/assets/9.Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯.html.f02b650d.js"><link rel="prefetch" href="/cicd/assets/index.html.9430da9c.js"><link rel="prefetch" href="/cicd/assets/01.åˆè¯†Kubernetes.html.718e6748.js"><link rel="prefetch" href="/cicd/assets/02.Kuberneteséƒ¨ç½².html.23c2f087.js"><link rel="prefetch" href="/cicd/assets/03.Containerdæ­å»ºKubernets.html.e8dc2fb9.js"><link rel="prefetch" href="/cicd/assets/04.kubernetesåŸºæœ¬æ“ä½œ.html.0af76b6a.js"><link rel="prefetch" href="/cicd/assets/05.Kubernetesç›‘æ§ä¸æ—¥å¿—ç®¡ç†.html.a594c3c4.js"><link rel="prefetch" href="/cicd/assets/06.Kubernetesåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç†.html.200ffb58.js"><link rel="prefetch" href="/cicd/assets/07.Kubernetesè°ƒåº¦.html.14c32ccd.js"><link rel="prefetch" href="/cicd/assets/08.Kubernetesç½‘ç»œ.html.9c5c9140.js"><link rel="prefetch" href="/cicd/assets/09.Kuberneteså­˜å‚¨.html.3b313902.js"><link rel="prefetch" href="/cicd/assets/10.Kuberneteså®‰å…¨.html.2e9fe6b9.js"><link rel="prefetch" href="/cicd/assets/11.Kubernetesé›†ç¾¤ç»´æŠ¤.html.1acd8f93.js"><link rel="prefetch" href="/cicd/assets/12.Kubernetesé›†ç¾¤æ•…éšœæ’æŸ¥.html.8f29c4b0.js"><link rel="prefetch" href="/cicd/assets/13.Helm.html.26881fb7.js"><link rel="prefetch" href="/cicd/assets/14.é«˜çº§è¿ç»´.html.c7f0e1f0.js"><link rel="prefetch" href="/cicd/assets/15.NFSåšK8Såç«¯å­˜å‚¨.html.24ca6a24.js"><link rel="prefetch" href="/cicd/assets/16.Glusterfså¯¹æ¥K8S.html.ad02c1e8.js"><link rel="prefetch" href="/cicd/assets/17.Cephå¯¹æ¥K8Så­˜å‚¨(RBD).html.1d95bb20.js"><link rel="prefetch" href="/cicd/assets/18.Rookæ„å»ºCephäº‘åŸç”Ÿå­˜å‚¨.html.2ba920ae.js"><link rel="prefetch" href="/cicd/assets/19.Kubectlå¤šé›†ç¾¤é…ç½®.html.e8f8f7c4.js"><link rel="prefetch" href="/cicd/assets/20.ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹é¢„ç•™è®¡ç®—èµ„æº.html.b1949ea8.js"><link rel="prefetch" href="/cicd/assets/21.Helmæ­å»ºEFKæ—¥å¿—ç³»ç»Ÿ.html.ba0060b8.js"><link rel="prefetch" href="/cicd/assets/22.Kubernetesçš„client-Python.html.4c201fe0.js"><link rel="prefetch" href="/cicd/assets/23.kubectlå‘½ä»¤.html.7ee5462d.js"><link rel="prefetch" href="/cicd/assets/01.é›†ç¾¤éƒ¨ç½²ä¸å®‰å…¨é…ç½®.html.6cf2ea7f.js"><link rel="prefetch" href="/cicd/assets/02.é›†ç¾¤å¼ºåŒ–.html.c2fb1f15.js"><link rel="prefetch" href="/cicd/assets/03.å®¹å™¨è¿è¡Œç¯å¢ƒå®‰å…¨åŠ å›º.html.53af5d4e.js"><link rel="prefetch" href="/cicd/assets/04.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´.html.606e1d3f.js"><link rel="prefetch" href="/cicd/assets/05.ä¾›åº”é“¾å®‰å…¨.html.a66192c3.js"><link rel="prefetch" href="/cicd/assets/06.ç›‘æ§ã€å®¡è®¡å’Œè¿è¡Œæ—¶å®‰å…¨.html.2ea5babd.js"><link rel="prefetch" href="/cicd/assets/index.html.1b7f3e44.js"><link rel="prefetch" href="/cicd/assets/index.html.5b7c881b.js"><link rel="prefetch" href="/cicd/assets/index.html.26cf0adf.js"><link rel="prefetch" href="/cicd/assets/index.html.b5915dba.js"><link rel="prefetch" href="/cicd/assets/index.html.41d43bd1.js"><link rel="prefetch" href="/cicd/assets/index.html.b13345ab.js"><link rel="prefetch" href="/cicd/assets/01.Cephéƒ¨ç½².html.79418d50.js"><link rel="prefetch" href="/cicd/assets/01.Elasticsearchæ•™ç¨‹.html.ef061c1a.js"><link rel="prefetch" href="/cicd/assets/02.SpringBootæ•´åˆES.html.a6432d91.js"><link rel="prefetch" href="/cicd/assets/01.NginxåŸºç¡€.html.bc28dbaf.js"><link rel="prefetch" href="/cicd/assets/02.Nginxåå‘ä»£ç†.html.a20c2185.js"><link rel="prefetch" href="/cicd/assets/03.Nginxè´Ÿè½½å‡è¡¡.html.3475fc9a.js"><link rel="prefetch" href="/cicd/assets/04.NginxåŠ¨é™åˆ†ç¦».html.bbca1346.js"><link rel="prefetch" href="/cicd/assets/05.Nginxé«˜å¯ç”¨.html.3ff4556a.js"><link rel="prefetch" href="/cicd/assets/01.MySQLå®‰è£….html.c8b7a632.js"><link rel="prefetch" href="/cicd/assets/02.MySQLæ¦‚è¿°.html.bc85cfe8.js"><link rel="prefetch" href="/cicd/assets/03.MySQLçš„SQLè¯¦è§£.html.94db624e.js"><link rel="prefetch" href="/cicd/assets/04.MySQLçš„å‡½æ•°.html.7ac6b66e.js"><link rel="prefetch" href="/cicd/assets/05.MySQLçš„çº¦æŸ.html.346ce6fc.js"><link rel="prefetch" href="/cicd/assets/06.MySQLå¤šè¡¨æŸ¥è¯¢.html.42d44f24.js"><link rel="prefetch" href="/cicd/assets/07.MySQLçš„äº‹åŠ¡.html.4ca4e973.js"><link rel="prefetch" href="/cicd/assets/08.MySQLç´¢å¼•.html.d4f9419f.js"><link rel="prefetch" href="/cicd/assets/01.Redisè¯¦è§£.html.11673a0c.js"><link rel="prefetch" href="/cicd/assets/02.SpringBootæ•´åˆRedis.html.017384ad.js"><link rel="prefetch" href="/cicd/assets/1.html.10321f45.js"><link rel="prefetch" href="/cicd/assets/10.html.d41b1bac.js"><link rel="prefetch" href="/cicd/assets/2.html.3a698947.js"><link rel="prefetch" href="/cicd/assets/3.html.826870e0.js"><link rel="prefetch" href="/cicd/assets/4.html.cf3356c9.js"><link rel="prefetch" href="/cicd/assets/5.html.2797d83f.js"><link rel="prefetch" href="/cicd/assets/6.html.2945720d.js"><link rel="prefetch" href="/cicd/assets/7.html.345f6876.js"><link rel="prefetch" href="/cicd/assets/8.html.22eeaf17.js"><link rel="prefetch" href="/cicd/assets/9.html.fb97463e.js"><link rel="prefetch" href="/cicd/assets/1.html.1bc685b4.js"><link rel="prefetch" href="/cicd/assets/2.html.cece9490.js"><link rel="prefetch" href="/cicd/assets/3.html.0f468b41.js"><link rel="prefetch" href="/cicd/assets/4.html.f146419f.js"><link rel="prefetch" href="/cicd/assets/5.html.3d122983.js"><link rel="prefetch" href="/cicd/assets/6.html.c878bea8.js"><link rel="prefetch" href="/cicd/assets/7.html.d8066882.js"><link rel="prefetch" href="/cicd/assets/8.html.6a7ca4b4.js"><link rel="prefetch" href="/cicd/assets/9.html.1977ed66.js"><link rel="prefetch" href="/cicd/assets/10.html.70e5e391.js"><link rel="prefetch" href="/cicd/assets/11.html.fde4ea88.js"><link rel="prefetch" href="/cicd/assets/2.html.a4c229e2.js"><link rel="prefetch" href="/cicd/assets/3.html.1f1466b3.js"><link rel="prefetch" href="/cicd/assets/4.html.bbe498e7.js"><link rel="prefetch" href="/cicd/assets/5.html.ef61f3b0.js"><link rel="prefetch" href="/cicd/assets/6.html.2c8d703e.js"><link rel="prefetch" href="/cicd/assets/7.html.24541ac0.js"><link rel="prefetch" href="/cicd/assets/8.html.6fc3bd96.js"><link rel="prefetch" href="/cicd/assets/9.html.f6352ede.js"><link rel="prefetch" href="/cicd/assets/awk.html.b95e15bc.js"><link rel="prefetch" href="/cicd/assets/01.Javaç¯å¢ƒé…ç½®.html.844b0dea.js"><link rel="prefetch" href="/cicd/assets/02.JavaåŸºç¡€æ¦‚å¿µ.html.b108d44e.js"><link rel="prefetch" href="/cicd/assets/03.Javaè¿ç®—ç¬¦.html.bd2cfbfa.js"><link rel="prefetch" href="/cicd/assets/04.Javaå¾ªç¯å’Œåˆ¤æ–­.html.5338a35d.js"><link rel="prefetch" href="/cicd/assets/05.Javaå¾ªç¯é«˜çº§å’Œæ•°ç»„.html.e00599ce.js"><link rel="prefetch" href="/cicd/assets/06.Javaæ–¹æ³•.html.7bb52ddb.js"><link rel="prefetch" href="/cicd/assets/07.Javaé¢å‘å¯¹è±¡.html.1079eb2b.js"><link rel="prefetch" href="/cicd/assets/08.Javaå­—ç¬¦ä¸².html.b901cbca.js"><link rel="prefetch" href="/cicd/assets/00.Javaé¢å¯¹å¯¹è±¡è¿›é˜¶.html.8918d3ae.js"><link rel="prefetch" href="/cicd/assets/01.æ—¥æœŸå’Œæ—¶é—´.html.348c00bd.js"><link rel="prefetch" href="/cicd/assets/02.æ­£åˆ™è¡¨è¾¾å¼.html.50ebd968.js"><link rel="prefetch" href="/cicd/assets/03.é›†åˆ.html.49082e37.js"><link rel="prefetch" href="/cicd/assets/04.Streamæµ.html.68f40f0d.js"><link rel="prefetch" href="/cicd/assets/05.å¼‚å¸¸å¤„ç†.html.29a650ed.js"><link rel="prefetch" href="/cicd/assets/06.æ—¥å¿—æ¡†æ¶.html.3ba2ce90.js"><link rel="prefetch" href="/cicd/assets/07.Fileç±»ã€IOæµ.html.6004e11e.js"><link rel="prefetch" href="/cicd/assets/08.IOæµè¿›é˜¶.html.93d298d8.js"><link rel="prefetch" href="/cicd/assets/09.å¤šçº¿ç¨‹.html.db4ffd29.js"><link rel="prefetch" href="/cicd/assets/10.ç½‘ç»œç¼–ç¨‹.html.f919c8a9.js"><link rel="prefetch" href="/cicd/assets/11.å•å…ƒæµ‹è¯•å’Œåå°„.html.afdbe08a.js"><link rel="prefetch" href="/cicd/assets/12.æ³¨è§£å’ŒåŠ¨æ€ä»£ç†.html.2c795104.js"><link rel="prefetch" href="/cicd/assets/13.XMLå’Œè®¾è®¡æ¨¡å¼.html.3d0c311c.js"><link rel="prefetch" href="/cicd/assets/01.SpringBootå¿«é€Ÿå…¥é—¨.html.b15e5cee.js"><link rel="prefetch" href="/cicd/assets/02.SpringBooté…ç½®æ–‡ä»¶.html.a51b7c4d.js"><link rel="prefetch" href="/cicd/assets/03.æ•´åˆJunitå’ŒMybatis.html.88ff751a.js"><link rel="prefetch" href="/cicd/assets/04.SpringBootæ—¥å¿—.html.cefe801e.js"><link rel="prefetch" href="/cicd/assets/05.SpringBootå¸¸ç”¨æ³¨è§£.html.6d4915ed.js"><link rel="prefetch" href="/cicd/assets/06.SpringBootå¼€å‘é…ç½®.html.eaeb29c4.js"><link rel="prefetch" href="/cicd/assets/07.SpringBootæ•°æ®å±‚æ–¹æ¡ˆ.html.66233b05.js"><link rel="prefetch" href="/cicd/assets/08.SpringBootæ•´åˆç¬¬ä¸‰æ–¹æŠ€æœ¯.html.72fb537e.js"><link rel="prefetch" href="/cicd/assets/01.Springçš„IoCå’ŒDI.html.baa8886c.js"><link rel="prefetch" href="/cicd/assets/02.IoCå’ŒDIæ³¨è§£å¼€å‘.html.d79783cd.js"><link rel="prefetch" href="/cicd/assets/03.Springçš„MVCå…¥é—¨.html.539104f8.js"><link rel="prefetch" href="/cicd/assets/04.SpringMVCçš„è¯·æ±‚å’Œå“åº”.html.028bbdf3.js"><link rel="prefetch" href="/cicd/assets/05.Springæ•´åˆJdbc.html.53c21fb4.js"><link rel="prefetch" href="/cicd/assets/06.SpringMVCé¡¹ç›®çš„å¸¸ç”¨é…ç½®.html.6eda597e.js"><link rel="prefetch" href="/cicd/assets/07.SpringMVCæ‹¦æˆªå™¨.html.1b33a69b.js"><link rel="prefetch" href="/cicd/assets/08.Springçš„å¼‚å¸¸å¤„ç†.html.a8841457.js"><link rel="prefetch" href="/cicd/assets/09.Springçš„AOP.html.dfaed15c.js"><link rel="prefetch" href="/cicd/assets/10.Springçš„äº‹åŠ¡ç®¡ç†.html.03810ef4.js"><link rel="prefetch" href="/cicd/assets/11.Mybatiså…¥é—¨.html.e46a9d31.js"><link rel="prefetch" href="/cicd/assets/12.Mybatiså¤šè¡¨æŸ¥è¯¢.html.ef88ef89.js"><link rel="prefetch" href="/cicd/assets/13.Mybatisæ³¨è§£å¼€å‘.html.c9eb015f.js"><link rel="prefetch" href="/cicd/assets/14.MyBatisPlus.html.b2b54d4f.js"><link rel="prefetch" href="/cicd/assets/404.html.792fbdca.js"><link rel="prefetch" href="/cicd/assets/auto.264f6c8c.js"><link rel="prefetch" href="/cicd/assets/index.cac02f97.js"><link rel="prefetch" href="/cicd/assets/flowchart.parse.ee90d7e0.js"><link rel="prefetch" href="/cicd/assets/mermaid.esm.min.e3b5d21d.js"><link rel="prefetch" href="/cicd/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/cicd/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/cicd/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/cicd/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/cicd/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/cicd/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/cicd/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/cicd/assets/VuePlayground.74354207.js"><link rel="prefetch" href="/cicd/assets/photoswipe.esm.382b1873.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/cicd/zh" class="brand"><img class="logo" src="/cicd/logo.svg" alt="æ–‡æ¡£æ¼”ç¤º"><!----><span class="site-name hide-in-pad">æ–‡æ¡£æ¼”ç¤º</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/cicd/zh" class="nav-link" aria-label="isKcount"><span class="icon iconfont icon-home"></span>isKcount<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åˆ†ç±»"><span class="title"><span class="icon iconfont icon-interact"></span>åˆ†ç±»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/cicd/zh/isKcount/1/" class="nav-link" aria-label="å­¦ä¹ è·¯çº¿è§„åˆ’"><span class="icon iconfont icon-ability"></span>å­¦ä¹ è·¯çº¿è§„åˆ’<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/isKcount/2/" class="nav-link" aria-label="è€ƒè¯"><span class="icon iconfont icon-relation"></span>è€ƒè¯<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/isKcount/3/" class="nav-link" aria-label="è¿ç»´ç¬”è®°"><span class="icon iconfont icon-linux"></span>è¿ç»´ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/isKcount/4/" class="nav-link" aria-label="åç«¯å¼€å‘ç¬”è®°"><span class="icon iconfont icon-note"></span>åç«¯å¼€å‘ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/isKcount/5/" class="nav-link" aria-label="å‰ç«¯å¼€å‘ç¬”è®°"><span class="icon iconfont icon-like"></span>å‰ç«¯å¼€å‘ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/isKcount/6/" class="nav-link" aria-label="ä¸­é—´ä»¶æœåŠ¡ç¬”è®°"><span class="icon iconfont icon-api"></span>ä¸­é—´ä»¶æœåŠ¡ç¬”è®°<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Devops"><span class="title"><span class="icon iconfont icon-select"></span>Devops</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/cicd/zh/pip/git/" class="nav-link" aria-label="Gitå¼€å‘æ‰‹å†Œ"><span class="icon iconfont icon-git"></span>Gitå¼€å‘æ‰‹å†Œ<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/pip/ci/" class="nav-link" aria-label="CICD"><span class="icon iconfont icon-ci"></span>CICD<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/pip/istio/" class="nav-link active" aria-label="Istio"><span class="icon iconfont icon-material"></span>Istio<!----></a></li><li class="dropdown-item"><a href="/cicd/zh/pip/operator/" class="nav-link" aria-label="Operator"><span class="icon iconfont icon-proxy"></span>Operator<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://wallhaven.cc/" rel="noopener noreferrer" target="_blank" aria-label="Wallhaven" class="nav-link"><span class="icon iconfont icon-autumn"></span>Wallhaven<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/cicd/zh/pip/" class="nav-link sidebar-link sidebar-page" aria-label="Devopsç”Ÿæ€"><!---->Devopsç”Ÿæ€<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-github"></span><span class="title">Gitæ‰‹å†Œ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ci"></span><span class="title">CICD</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-material"></span><span class="title">Istio</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/cicd/zh/pip/istio/1.Istio%E6%A6%82%E8%BF%B0.html" class="nav-link sidebar-link sidebar-page" aria-label="Istioæ¦‚è¿°"><!---->Istioæ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/cicd/zh/pip/istio/2.Istio%E5%AE%89%E8%A3%85.html" class="nav-link sidebar-link sidebar-page" aria-label="Istioå®‰è£…"><!---->Istioå®‰è£…<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Istioç”±æµ…å…¥æ·±"><!---->Istioç”±æµ…å…¥æ·±<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istioç®€ä»‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Istioç®€ä»‹"><!---->Istioç®€ä»‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istioçš„å®‰è£…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Istioçš„å®‰è£…"><!---->Istioçš„å®‰è£…<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ä½¿ç”¨-istioctl-å®‰è£…" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ä½¿ç”¨ Istioctl å®‰è£…"><!---->ä½¿ç”¨ Istioctl å®‰è£…<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æµ‹è¯•ä¸€ä¸ªå®ä¾‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æµ‹è¯•ä¸€ä¸ªå®ä¾‹"><!---->æµ‹è¯•ä¸€ä¸ªå®ä¾‹<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ä»‹ç»istioæµé‡ç®¡ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ä»‹ç»Istioæµé‡ç®¡ç†"><!---->ä»‹ç»Istioæµé‡ç®¡ç†<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#sidecaræ³¨å…¥" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Sidecaræ³¨å…¥"><!---->Sidecaræ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#è¯·æ±‚è·¯ç”±" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è¯·æ±‚è·¯ç”±"><!---->è¯·æ±‚è·¯ç”±<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æ•…éšœæ³¨å…¥-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ•…éšœæ³¨å…¥"><!---->æ•…éšœæ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æµé‡è½¬ç§»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æµé‡è½¬ç§»"><!---->æµé‡è½¬ç§»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#tcp-æµé‡è½¬ç§»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TCP æµé‡è½¬ç§»"><!---->TCP æµé‡è½¬ç§»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#è¯·æ±‚è¶…æ—¶" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è¯·æ±‚è¶…æ—¶"><!---->è¯·æ±‚è¶…æ—¶<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ç†”æ–­-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç†”æ–­"><!---->ç†”æ–­<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#é•œåƒ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="é•œåƒ"><!---->é•œåƒ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å…¥å£ç½‘å…³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å…¥å£ç½‘å…³"><!---->å…¥å£ç½‘å…³<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å®‰å…¨ç½‘å…³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å®‰å…¨ç½‘å…³"><!---->å®‰å…¨ç½‘å…³<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å‡ºå£tlså‘èµ·" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å‡ºå£TLSå‘èµ·"><!---->å‡ºå£TLSå‘èµ·<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å‡ºå£ç½‘å…³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å‡ºå£ç½‘å…³"><!---->å‡ºå£ç½‘å…³<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/cicd/zh/pip/istio/4.Istio%E7%BB%83%E4%B9%A0%E9%A2%98.html" class="nav-link sidebar-link sidebar-page" aria-label="Istioç»ƒä¹ é¢˜"><!---->Istioç»ƒä¹ é¢˜<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-proxy"></span><span class="title">Operator</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Istioç”±æµ…å…¥æ·±</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://iskcount.github.io" target="_blank" rel="noopener noreferrer">isKcount</a></span><span property="author" content="isKcount"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´4æœˆ1æ—¥</span><meta property="datePublished" content="2022-04-01T13:59:49.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 83 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT83M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istioç®€ä»‹" class="router-link-active router-link-exact-active toc-link level2">Istioç®€ä»‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#istioçš„å®‰è£…" class="router-link-active router-link-exact-active toc-link level2">Istioçš„å®‰è£…</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ä½¿ç”¨-istioctl-å®‰è£…" class="router-link-active router-link-exact-active toc-link level3">ä½¿ç”¨ Istioctl å®‰è£…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æµ‹è¯•ä¸€ä¸ªå®ä¾‹" class="router-link-active router-link-exact-active toc-link level3">æµ‹è¯•ä¸€ä¸ªå®ä¾‹</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ä»‹ç»istioæµé‡ç®¡ç†" class="router-link-active router-link-exact-active toc-link level2">ä»‹ç»Istioæµé‡ç®¡ç†</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#sidecaræ³¨å…¥" class="router-link-active router-link-exact-active toc-link level2">Sidecaræ³¨å…¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#è¯·æ±‚è·¯ç”±" class="router-link-active router-link-exact-active toc-link level2">è¯·æ±‚è·¯ç”±</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æ•…éšœæ³¨å…¥-1" class="router-link-active router-link-exact-active toc-link level2">æ•…éšœæ³¨å…¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#æµé‡è½¬ç§»" class="router-link-active router-link-exact-active toc-link level2">æµé‡è½¬ç§»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#tcp-æµé‡è½¬ç§»" class="router-link-active router-link-exact-active toc-link level2">TCP æµé‡è½¬ç§»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#è¯·æ±‚è¶…æ—¶" class="router-link-active router-link-exact-active toc-link level2">è¯·æ±‚è¶…æ—¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#ç†”æ–­-1" class="router-link-active router-link-exact-active toc-link level2">ç†”æ–­</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#é•œåƒ" class="router-link-active router-link-exact-active toc-link level2">é•œåƒ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å…¥å£ç½‘å…³" class="router-link-active router-link-exact-active toc-link level2">å…¥å£ç½‘å…³</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å®‰å…¨ç½‘å…³" class="router-link-active router-link-exact-active toc-link level2">å®‰å…¨ç½‘å…³</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å‡ºå£tlså‘èµ·" class="router-link-active router-link-exact-active toc-link level2">å‡ºå£TLSå‘èµ·</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/cicd/zh/pip/istio/3.Istio%E7%9A%84%E6%B7%B1%E5%85%A5%E6%B5%85.html#å‡ºå£ç½‘å…³" class="router-link-active router-link-exact-active toc-link level2">å‡ºå£ç½‘å…³</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="istioç”±æµ…å…¥æ·±" tabindex="-1"><a class="header-anchor" href="#istioç”±æµ…å…¥æ·±" aria-hidden="true">#</a> Istioç”±æµ…å…¥æ·±</h1><h2 id="istioç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#istioç®€ä»‹" aria-hidden="true">#</a> Istioç®€ä»‹</h2><h4 id="ä»€ä¹ˆæ˜¯istio" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯istio" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯Istio?</h4><p>åœ¨ä¼ä¸šæ™®ééƒ½åšäº‘å¹³å°çš„æ—¶ä»£èƒŒæ™¯ä¸‹ï¼Œäº‘å¹³å°æ¶æ„å¸¦æ¥çš„è¯¸å¤šå¥½å¤„ï¼Œä½†æ˜¯ï¼Œä¸å¯å¦è®¤çš„æ˜¯ï¼Œé‡‡ç”¨äº‘æŠ€æœ¯æ¶æ„ä¼šå¯¹DevOpså›¢é˜Ÿé€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚ å¼€å‘äººå‘˜ä¹Ÿå¿…é¡»ä½¿ç”¨å¾®æœåŠ¡æ¥æ„å»ºå¯ç§»æ¤æ€§ï¼ŒåŒæ—¶å„å¤§è¿è¥å•†æ­£åœ¨ç®¡ç†è¶…å¤§å‹æ··åˆå’Œå¤šäº‘éƒ¨ç½²ã€‚è€ŒIstioä½¿å¾—æ‚¨å¯ä»¥è¿æ¥ï¼Œå®‰å…¨ï¼Œæ§åˆ¶å’Œç›‘æ§è¿™äº›æœåŠ¡ã€‚</p><p>ä»æ›´é«˜çš„ç»´åº¦æ¥çœ‹ï¼ŒIstioæœ‰åŠ©äºé™ä½éƒ¨ç½²çš„å¤æ‚æ€§ï¼Œå‡è½»å¼€å‘å›¢é˜Ÿçš„è´Ÿæ‹…ã€‚<code>Istioæ˜¯ä¸€ä¸ªå®Œå…¨å¼€æºçš„æœåŠ¡ç½‘æ ¼ï¼ˆservice meshï¼‰ï¼Œå¯ä»¥é€æ˜åœ°åˆ†å±‚åˆ°ç°æœ‰çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸Šã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¹³å°ï¼Œé€šè¿‡å…¶æä¾›çš„APIï¼Œå¯å°†å…¶é›†æˆåˆ°ä»»ä½•æ—¥å¿—å¹³å°ï¼Œtelemetryæˆ–ç­–ç•¥ç³»ç»Ÿä¸­ã€‚</code></p><p>Istioçš„å¤šæ ·åŒ–åŠŸèƒ½é›†ä½¿æ‚¨èƒ½å¤Ÿé«˜æ•ˆåœ°è¿è¡Œåˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„æ–¹å¼æ¥ä¿æŠ¤ï¼Œè¿æ¥å’Œç›‘è§†å¾®æœåŠ¡ã€‚</p><h4 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼-serivce-mesh" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼-serivce-mesh" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼ˆserivce meshï¼‰ï¼Ÿ</h4><p>å½“æ•´ä½“åº”ç”¨ç¨‹åºå‘åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„è¿‡æ¸¡æ—¶ï¼ŒIstioè§£å†³äº†å¼€å‘äººå‘˜å’Œè¿è¥å•†é¢ä¸´çš„æŒ‘æˆ˜ã€‚</p><p><code>æœåŠ¡ç½‘æ ¼</code>æœ¯è¯­ç”¨äºæè¿°ç»„æˆæ­¤ç±»åº”ç”¨ç¨‹åºçš„å¾®æœåŠ¡ç½‘ç»œåŠå…¶ä¹‹é—´çš„äº¤äº’ã€‚éšç€æœåŠ¡ç½‘æ ¼çš„å¤§å°å’Œå¤æ‚æ€§çš„å¢é•¿ï¼Œå®ƒå˜å¾—è¶Šæ¥è¶Šéš¾ä»¥ç†è§£å’Œç®¡ç†ã€‚å®ƒçš„è¦æ±‚å¯ä»¥åŒ…æ‹¬å‘ç°ï¼Œè´Ÿè½½å¹³è¡¡ï¼Œæ•…éšœæ¢å¤ï¼ŒæŒ‡æ ‡å’Œç›‘æ§ã€‚æœåŠ¡ç½‘æ ¼é€šå¸¸è¿˜å…·æœ‰æ›´å¤æ‚çš„æ“ä½œè¦æ±‚ï¼Œä¾‹å¦‚A/Bæµ‹è¯•ï¼Œé‡‘ä¸é›€ï¼Œç½‘é€Ÿé™åˆ¶ï¼Œè®¿é—®æ§åˆ¶å’Œç«¯åˆ°ç«¯çš„èº«ä»½éªŒè¯ã€‚</p><p>Istioæä¾›äº†æ•´ä¸ªæœåŠ¡ç½‘æ ¼ä¸Šçš„è¡Œä¸ºæ´å¯ŸåŠ›å’Œæ“ä½œæ§åˆ¶ï¼Œä»è€Œæä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆæ¥æ»¡è¶³å¾®æœåŠ¡åº”ç”¨ç¨‹åºçš„å„ç§éœ€æ±‚ã€‚</p><h4 id="ä¸ºä»€ä¹ˆä½¿ç”¨istio" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆä½¿ç”¨istio" aria-hidden="true">#</a> ä¸ºä»€ä¹ˆä½¿ç”¨Istioï¼Ÿ</h4><p>Istioå¯ä»¥è½»æ¾åœ¨å·²éƒ¨ç½²æœåŠ¡ç½‘ç»œä¸Šåˆ›å»ºå¸¦æœ‰è´Ÿè½½å¹³è¡¡ï¼ŒæœåŠ¡åˆ°æœåŠ¡çš„èº«ä»½éªŒè¯ï¼Œç›‘æ§ç­‰åŠŸèƒ½ï¼Œå¹¶ä¸”æœåŠ¡ä»£ç ä¸­çš„ä»£ç æ— éœ€å˜åŠ¨ï¼ˆæˆ–å˜åŠ¨å¾ˆå°‘ï¼‰ã€‚é€šè¿‡åœ¨æ•´ä¸ªç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªç‰¹æ®Šçš„sidecarä»£ç†æ¥æ‹¦æˆªå¾®æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰ç½‘ç»œé€šä¿¡ï¼Œç„¶åä½¿ç”¨å…¶å¹³å°æ§åˆ¶åŠŸèƒ½é…ç½®å’Œç®¡ç†Istioï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>è‡ªåŠ¨ä¸ºHTTPï¼ŒgRPCï¼ŒWebSocketå’ŒTCPæµé‡è´Ÿè½½å¹³è¡¡ã€‚</li><li>é€šè¿‡ä¸°å¯Œçš„è·¯ç”±è§„åˆ™ï¼Œé‡è¯•ï¼Œæ•…éšœè½¬ç§»å’Œæ•…éšœæ³¨å…¥å¯¹æµé‡è¡Œä¸ºè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚</li><li>å¯æ’æ‹”çš„ç­–ç•¥å±‚å’Œé…ç½®APIï¼Œæ”¯æŒè®¿é—®æ§åˆ¶ï¼Œé€Ÿç‡é™åˆ¶å’Œé…é¢ã€‚</li><li>é›†ç¾¤å†…æ‰€æœ‰æµé‡çš„è‡ªåŠ¨åº¦é‡ï¼Œæ—¥å¿—å’Œè·Ÿè¸ªï¼ŒåŒ…æ‹¬é›†ç¾¤çš„å…¥å£å’Œå‡ºå£ã€‚</li><li>é€šè¿‡å¼ºå¤§çš„åŸºäºèº«ä»½çš„èº«ä»½éªŒè¯å’Œæˆæƒï¼Œåœ¨é›†ç¾¤ä¸­è¿›è¡Œå®‰å…¨çš„æœåŠ¡ä¹‹é—´é€šä¿¡ã€‚</li></ul><p>Istioä¸“ä¸ºå¯æ‰©å±•æ€§è€Œè®¾è®¡ï¼Œå¯æ»¡è¶³å¤šç§éƒ¨ç½²éœ€æ±‚ã€‚</p><h4 id="æ ¸å¿ƒåŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒåŠŸèƒ½" aria-hidden="true">#</a> æ ¸å¿ƒåŠŸèƒ½</h4><p>Istioåœ¨æœåŠ¡ç½‘ç»œä¸­ç»Ÿä¸€æä¾›äº†è®¸å¤šå…³é”®åŠŸèƒ½ï¼š</p><h4 id="æµé‡ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#æµé‡ç®¡ç†" aria-hidden="true">#</a> æµé‡ç®¡ç†</h4><p>Istioè§„åˆ™é…ç½®å’Œæµé‡è·¯ç”±ä½¿æ‚¨å¯ä»¥å¾ˆå®¹æ˜“çš„æ§åˆ¶æœåŠ¡ä¹‹é—´çš„æµé‡å’ŒAPIè°ƒç”¨çš„æµé‡ã€‚Istioç®€åŒ–äº†è¯¸å¦‚æ–­è·¯å™¨ï¼Œè¶…æ—¶å’Œé‡è¯•ä¹‹ç±»çš„æœåŠ¡çº§åˆ«å±æ€§çš„é…ç½®ï¼Œå¹¶ä½¿å…¶è½»è€Œæ˜“ä¸¾åœ°è®¾ç½®é‡è¦ä»»åŠ¡ï¼Œå¦‚A/Bæµ‹è¯•ï¼Œé‡‘ä¸é›€éƒ¨ç½²å’ŒåŸºäºç™¾åˆ†æ¯”çš„æµé‡æ‹†åˆ†ã€‚</p><p>å€ŸåŠ©å¯¹æµé‡çš„æ›´å¥½å¯è§æ€§å’Œå¼€ç®±å³ç”¨çš„æ•…éšœæ¢å¤åŠŸèƒ½ï¼Œæ— è®ºé‡åˆ°ä»€ä¹ˆæƒ…å†µï¼Œæ‚¨éƒ½å¯ä»¥åœ¨é—®é¢˜å¼•èµ·æ•…éšœä¹‹å‰åŠæ—¶å‘ç°é—®é¢˜ï¼Œä½¿å¾—è°ƒç”¨æ›´åŠ å¯é ï¼Œç½‘ç»œä¹Ÿæ›´åŠ å¼ºå¤§ã€‚</p><h4 id="å®‰å…¨" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨" aria-hidden="true">#</a> å®‰å…¨</h4><p>Istioçš„å®‰å…¨åŠŸèƒ½ä½¿å¼€å‘äººå‘˜å¯ä»¥å°†ç²¾åŠ›é›†ä¸­åœ¨åº”ç”¨ç¨‹åºçº§åˆ«ã€‚Istioæä¾›åŸºç¡€å®‰å…¨é€šä¿¡é€šé“ï¼Œå¹¶å¤§è§„æ¨¡ç®¡ç†æœåŠ¡é€šä¿¡çš„èº«ä»½éªŒè¯ï¼Œæˆæƒå’ŒåŠ å¯†ã€‚ å€ŸåŠ©Istioï¼Œé»˜è®¤æƒ…å†µä¸‹å¯ä»¥ä¿æŠ¤æœåŠ¡é€šä¿¡çš„å®‰å…¨ï¼Œä»è€Œä½¿æ‚¨èƒ½å¤Ÿåœ¨å„ç§åè®®å’Œè¿è¡Œæ—¶ä¹‹é—´ä¸€è‡´åœ°æ‰§è¡Œç­–ç•¥ - æ‰€æœ‰è¿™äº›æ“ä½œå‡ ä¹ä¸éœ€è¦æ›´æ”¹åº”ç”¨ç¨‹åºã€‚</p><p>è™½ç„¶Istioæ˜¯ç‹¬ç«‹äºå¹³å°çš„ï¼Œä½†å°†å…¶ä¸Kubernetesï¼ˆæˆ–åŸºç¡€æ¶æ„ï¼‰ç½‘ç»œç­–ç•¥é…åˆä½¿ç”¨ï¼Œåˆ™å¥½å¤„æ›´å¤§ï¼ŒåŒ…æ‹¬èƒ½å¤Ÿåœ¨ç½‘ç»œå’Œåº”ç”¨ç¨‹åºå±‚ä¿æŠ¤Podåˆ°Podæˆ–æœåŠ¡åˆ°æœåŠ¡çš„é€šä¿¡çš„èƒ½åŠ›ã€‚</p><h4 id="å¯è§‚å¯Ÿæ€§-observability" tabindex="-1"><a class="header-anchor" href="#å¯è§‚å¯Ÿæ€§-observability" aria-hidden="true">#</a> å¯è§‚å¯Ÿæ€§(Observability)</h4><p>Istioå¼ºå¤§çš„è·Ÿè¸ªï¼Œç›‘æ§å’Œæ—¥å¿—è®°å½•åŠŸèƒ½ä½¿æ‚¨å¯ä»¥æ·±å…¥äº†è§£æœåŠ¡ç½‘æ ¼éƒ¨ç½²ã€‚å€ŸåŠ©Istioçš„ç›‘è§†åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥çœŸæ­£äº†è§£æœåŠ¡æ€§èƒ½å¦‚ä½•å½±å“ä¸Šæ¸¸å’Œä¸‹æ¸¸äº‹ç‰©ï¼Œè€Œå…¶è‡ªå®šä¹‰dashboardsï¼ˆä»ªè¡¨ç›˜ï¼‰åˆ™å¯ä»¥æä¾›å¯¹æ‰€æœ‰æœåŠ¡æ€§èƒ½çš„å¯è§†æ€§ï¼Œå¹¶è®©æ‚¨äº†è§£è¯¥æ€§èƒ½å¦‚ä½•å½±å“æ‚¨çš„å…¶ä»–çš„ç¨‹åºçš„ã€‚</p><p>Istioçš„Mixerç»„ä»¶è´Ÿè´£ç­–ç•¥æ§åˆ¶å’Œé¥æµ‹(telemetry)é‡‡é›†ã€‚å®ƒæä¾›äº†åç«¯æŠ½è±¡å’Œä¸­ä»‹ï¼Œä½¿Istioçš„å…¶ä½™éƒ¨åˆ†ä¸å„ä¸ªåŸºç¡€æ¶æ„åç«¯çš„å®ç°ç»†èŠ‚éš”ç¦»å¼€æ¥ï¼Œå¹¶ä¸ºæ“ä½œå‘˜æä¾›äº†å¯¹ç½‘æ ¼å’ŒåŸºç¡€æ¶æ„åç«¯ä¹‹é—´æ‰€æœ‰äº¤äº’çš„ç²¾ç»†æ§åˆ¶ã€‚</p><p>æ‰€æœ‰è¿™äº›åŠŸèƒ½ä½¿æ‚¨å¯ä»¥æ›´æœ‰æ•ˆåœ°è®¾ç½®ï¼Œç›‘æ§å’Œæ‰§è¡ŒæœåŠ¡ä¸Šçš„SLOã€‚å½“ç„¶ï¼Œæœ€é‡è¦çš„æ˜¯æ‚¨å¯ä»¥å¿«é€Ÿæœ‰æ•ˆåœ°æ£€æµ‹å’Œä¿®å¤æ•…éšœã€‚</p><h4 id="å¹³å°æ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#å¹³å°æ”¯æŒ" aria-hidden="true">#</a> å¹³å°æ”¯æŒ</h4><p>Istioæ˜¯ç‹¬ç«‹äºå¹³å°çš„ï¼Œæ—¨åœ¨åœ¨å¤šç§ç¯å¢ƒä¸­è¿è¡Œï¼ŒåŒ…æ‹¬è·¨Cloudï¼Œæœ¬åœ°ï¼ŒKubernetesï¼ŒMesosç­‰çš„ç¯å¢ƒã€‚æ‚¨å¯ä»¥åœ¨Kubernetesæˆ–Consulçš„Nomadä¸Šéƒ¨ç½²Istioã€‚Istioå½“å‰æ”¯æŒï¼š</p><ul><li>Kubernetesä¸Šéƒ¨ç½²Service</li><li>å‘Consulæ³¨å†ŒServices</li><li>åœ¨å•ä¸ªè™šæ‹Ÿæœºä¸Šè¿è¡ŒServices</li></ul><h4 id="é›†æˆå’Œè‡ªå®šä¹‰" tabindex="-1"><a class="header-anchor" href="#é›†æˆå’Œè‡ªå®šä¹‰" aria-hidden="true">#</a> é›†æˆå’Œè‡ªå®šä¹‰</h4><p>Istioçš„ç­–ç•¥æ‰§è¡Œç»„ä»¶å¯ä»¥æ‰©å±•å’Œè‡ªå®šä¹‰ï¼Œä»¥ä¸ç°æœ‰çš„ACLï¼Œæ—¥å¿—è®°å½•ï¼Œç›‘è§†ï¼Œé…é¢ï¼Œå®¡æ ¸ç­‰é›†æˆã€‚</p><h4 id="æ¶æ„" tabindex="-1"><a class="header-anchor" href="#æ¶æ„" aria-hidden="true">#</a> æ¶æ„</h4><p>IstioæœåŠ¡ç½‘æ ¼åœ¨é€»è¾‘ä¸Šåˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ã€‚</p><ul><li>æ•°æ®planeç”±éƒ¨ç½²ä¸ºsidecarçš„ä¸€ç»„æ™ºèƒ½ä»£ç†ï¼ˆEnvoyï¼‰ç»„æˆã€‚è¿™äº›ä»£ç†ä¸­ä»‹å’Œæ§åˆ¶å¾®æœåŠ¡ä¸Mixerã€é€šç”¨ç­–ç•¥å’Œé¥æµ‹é›†çº¿å™¨ä¹‹é—´çš„æ‰€æœ‰ç½‘ç»œé€šä¿¡ã€‚</li><li>æ§åˆ¶å¹³é¢ç®¡ç†å¹¶å°†ä»£ç†é…ç½®ä¸ºè·¯ç”±æµé‡ã€‚å¦å¤–ï¼Œæ§åˆ¶å¹³é¢é…ç½®Mixersæ¥æ‰§è¡Œç­–ç•¥å’Œé‡‡é›†é¥æµ‹æ•°æ®ã€‚</li></ul><p>ä¸‹å›¾æ˜¾ç¤ºäº†ç»„æˆæ¯ä¸ªå¹³é¢çš„ä¸åŒç»„ä»¶:</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326606.jpeg" alt="screenshot" loading="lazy"></p><h4 id="envoy" tabindex="-1"><a class="header-anchor" href="#envoy" aria-hidden="true">#</a> Envoy</h4><p>Istioä½¿ç”¨Envoyä»£ç†çš„æ‰©å±•ç‰ˆæœ¬ã€‚Envoyæ˜¯ä½¿ç”¨<code>C++</code>å¼€å‘çš„é«˜æ€§èƒ½ä»£ç†ï¼Œå¯ä¸ºæœåŠ¡ç½‘æ ¼ä¸­çš„æ‰€æœ‰æœåŠ¡è°ƒè§£æ‰€æœ‰å…¥ç«™å’Œå‡ºç«™æµé‡ã€‚Istioåˆ©ç”¨Envoyçš„è®¸å¤šå†…ç½®åŠŸèƒ½ï¼Œå¦‚ï¼š</p><ul><li>åŠ¨æ€æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>TLS termination</li><li>HTTP/2å’ŒgRPCä»£ç†</li><li>ç†”æ–­ï¼ˆCircuit breakersï¼‰</li><li>å¥åº·æ£€æŸ¥</li><li>åˆ†é˜¶æ®µæ¨å‡ºï¼ŒæŒ‰ç™¾åˆ†æ¯”åˆ†é…æµé‡</li><li>æ•…éšœæ³¨å…¥</li><li>ä¸°å¯Œçš„æŒ‡æ ‡</li></ul><p>Sidecarä»£ç†æ¨¡å‹è¿˜å…è®¸ä½ å°†IstioåŠŸèƒ½æ·»åŠ åˆ°ç°æœ‰éƒ¨ç½²ä¸­ï¼Œè€Œæ— éœ€é‡æ–°æ„é€ æˆ–é‡å†™ä»£ç ã€‚ä½ å¯ä»¥é˜…è¯»æ›´å¤šå…³äºä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è®¾è®¡ç›®æ ‡ä¸­é€‰æ‹©è¿™ç§æ–¹æ³•çš„ä¿¡æ¯ã€‚</p><h4 id="mixer" tabindex="-1"><a class="header-anchor" href="#mixer" aria-hidden="true">#</a> Mixer</h4><p>Mixeræ˜¯ä¸€ä¸ªä¸å¹³å°æ— å…³çš„ç»„ä»¶ã€‚Mixerè·¨æœåŠ¡ç½‘æ ¼å®æ–½è®¿é—®æ§åˆ¶å’Œä½¿ç”¨ç­–ç•¥ï¼Œå¹¶ä»Envoyä»£ç†å’Œå…¶ä»–æœåŠ¡æ”¶é›†é¥æµ‹æ•°æ®ã€‚ ä»£ç†æå–è¯·æ±‚çº§åˆ«å±æ€§ï¼Œå¹¶å°†å…¶å‘é€åˆ°Mixerè¿›è¡Œè¯„ä¼°ã€‚æ‚¨å¯ä»¥åœ¨æˆ‘ä»¬çš„â€œMixeré…ç½®â€æ–‡æ¡£ä¸­æ‰¾åˆ°æœ‰å…³æ­¤å±æ€§æå–å’Œç­–ç•¥è¯„ä¼°çš„æ›´å¤šä¿¡æ¯ã€‚</p><p>MixeråŒ…å«ä¸€ä¸ªçµæ´»çš„æ’ä»¶æ¨¡å‹ã€‚è¯¥æ¨¡å‹ä½¿Istioå¯ä»¥ä¸å„ç§ä¸»æœºç¯å¢ƒå’ŒåŸºç¡€æ¶æ„åç«¯äº¤äº’ã€‚å› æ­¤ï¼ŒIstioä»è¿™äº›ç»†èŠ‚ä¸­æŠ½è±¡äº†Envoyä»£ç†å’ŒIstioç®¡ç†çš„æœåŠ¡ã€‚</p><h4 id="pilot" tabindex="-1"><a class="header-anchor" href="#pilot" aria-hidden="true">#</a> Pilot</h4><p>Pilotæä¾›äº†Envoy sidecarçš„æœåŠ¡å‘ç°ï¼Œæ™ºèƒ½è·¯ç”±çš„æµé‡ç®¡ç†åŠŸèƒ½ï¼ˆä¾‹å¦‚ A/Bæµ‹è¯•ï¼Œé‡‘ä¸é›€ç­‰ï¼‰å’Œå¼¹æ€§ï¼ˆè¶…æ—¶ï¼Œé‡è¯•ï¼Œæ–­è·¯å™¨ç­‰ï¼‰ã€‚</p><p>Pilotå°†æ§åˆ¶æµé‡è¡Œä¸ºçš„é«˜çº§è·¯ç”±è§„åˆ™è½¬æ¢ä¸ºEnvoyç‰¹å®šçš„é…ç½®ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å°†å…¶ä¼ é€åˆ°sidecarã€‚Pilotæå–äº†ç‰¹å®šäºå¹³å°çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå¹¶å°†å®ƒä»¬åˆæˆä¸ºæ ‡å‡†æ ¼å¼ï¼Œä»»ä½•ç¬¦åˆEnvoyæ•°æ®å¹³é¢APIçš„Sidecaréƒ½å¯ä»¥ä½¿ç”¨ã€‚è¿™ç§æ¾æ•£çš„è€¦åˆä½¿å¾—Istioå¯ä»¥åœ¨Kubernetesï¼ŒConsulæˆ–Nomadç­‰å¤šç§ç¯å¢ƒä¸­è¿è¡Œï¼ŒåŒæ—¶ä¸ºæµé‡ç®¡ç†ä¿ç•™ç›¸åŒçš„æ“ä½œå‘˜ç•Œé¢ã€‚</p><h4 id="citadel" tabindex="-1"><a class="header-anchor" href="#citadel" aria-hidden="true">#</a> Citadel</h4><p>Citadelé€šè¿‡å†…ç½®çš„èº«ä»½å’Œå‡­æ®ç®¡ç†å®ç°äº†å¼ºå¤§çš„æœåŠ¡åˆ°æœåŠ¡å’Œç»ˆç«¯ç”¨æˆ·çš„èº«ä»½éªŒè¯ã€‚å¯ä»¥ä½¿ç”¨Citadelæ¥å‡çº§æœåŠ¡ç½‘æ ¼ä¸­çš„æœªåŠ å¯†æµé‡ã€‚ä½¿ç”¨Citadelï¼Œè¿è¥å•†å¯ä»¥åŸºäºæœåŠ¡èº«ä»½è€Œä¸æ˜¯ç›¸å¯¹ä¸ç¨³å®šçš„3å±‚æˆ–4å±‚ç½‘ç»œè¯†åˆ«ç æ¥å®æ–½ç­–ç•¥ã€‚ä»ç‰ˆæœ¬0.5å¼€å§‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Istioçš„æˆæƒåŠŸèƒ½æ¥æ§åˆ¶è°å¯ä»¥è®¿é—®æ‚¨çš„æœåŠ¡ã€‚</p><h4 id="galley" tabindex="-1"><a class="header-anchor" href="#galley" aria-hidden="true">#</a> Galley</h4><p>Galleyæ˜¯Istioçš„é…ç½®éªŒè¯ï¼Œæå–ï¼Œå¤„ç†å’Œåˆ†å‘ç»„ä»¶ã€‚å®ƒè´Ÿè´£å°†å…¶ä½™Istioç»„ä»¶ä¸ä»åº•å±‚å¹³å°ï¼ˆä¾‹å¦‚Kubernetesï¼‰è·å–ç”¨æˆ·é…ç½®çš„ç»†èŠ‚éš”ç¦»å¼€æ¥ã€‚</p><ul><li><code>æœ€å¤§åŒ–é€æ˜åº¦</code>ï¼šè¦é‡‡ç”¨Istioï¼Œè¦æ±‚æ“ä½œå‘˜æˆ–å¼€å‘äººå‘˜è¿›è¡Œå°½å¯èƒ½å°‘çš„å·¥ä½œï¼Œä»¥ä»ç³»ç»Ÿä¸­è·å¾—çœŸæ­£çš„ä»·å€¼ã€‚ä¸ºæ­¤ï¼ŒIstioå¯ä»¥è‡ªåŠ¨å°†å…¶è‡ªèº«æ’å…¥æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰ç½‘ç»œè·¯å¾„ä¸­ã€‚Istioä½¿ç”¨Sidecarä»£ç†æ¥æ•è·æµé‡ï¼Œå¹¶åœ¨å¯èƒ½çš„æƒ…å†µä¸‹è‡ªåŠ¨å¯¹ç½‘ç»œå±‚è¿›è¡Œç¼–ç¨‹ï¼Œä»¥é€šè¿‡è¿™äº›ä»£ç†è·¯ç”±æµé‡ï¼Œè€Œæ— éœ€æ›´æ”¹å·²éƒ¨ç½²çš„åº”ç”¨ç¨‹åºä»£ç ã€‚ åœ¨Kubernetesä¸­ï¼Œä»£ç†è¢«æ³¨å…¥åˆ°Podä¸­ï¼Œå¹¶é€šè¿‡å¯¹iptablesè§„åˆ™è¿›è¡Œç¼–ç¨‹æ¥æ•è·æµé‡ã€‚ ä¸€æ—¦æ³¨å…¥äº†sidecarä»£ç†å¹¶ä¸”å¯¹æµé‡è·¯ç”±è¿›è¡Œäº†ç¼–ç¨‹ï¼ŒIstioå°±å¯ä»¥è°ƒè§£æ‰€æœ‰æµé‡ã€‚æ­¤åŸåˆ™ä¹Ÿé€‚ç”¨äºæ€§èƒ½ã€‚å°†Istioåº”ç”¨äºéƒ¨ç½²æ—¶ï¼Œè¿è¥å•†ä¼šå‘ç°æ‰€æä¾›åŠŸèƒ½çš„èµ„æºæˆæœ¬å¢åŠ æœ€å°ã€‚ç»„ä»¶å’ŒAPIå¿…é¡»åœ¨è®¾è®¡æ—¶å……åˆ†è€ƒè™‘æ€§èƒ½å’Œè§„æ¨¡ã€‚</li><li><code>å¯æ‰©å±•æ€§</code>ï¼šéšç€è¿è¥å•†å’Œå¼€å‘äººå‘˜è¶Šæ¥è¶Šä¾èµ–Istioæä¾›çš„åŠŸèƒ½ï¼Œç³»ç»Ÿä¹Ÿå¿…é¡»éšç€ä»–ä»¬çš„éœ€æ±‚è€Œå¢é•¿ã€‚åœ¨æˆ‘ä»¬ç»§ç»­æ·»åŠ æ–°åŠŸèƒ½çš„åŒæ—¶ï¼Œæœ€å¤§çš„éœ€æ±‚æ˜¯æ‰©å±•ç­–ç•¥ç³»ç»Ÿï¼Œä¸å…¶ä»–ç­–ç•¥å’Œæ§åˆ¶æºé›†æˆä»¥åŠå°†æœ‰å…³ç½‘æ ¼è¡Œä¸ºçš„ä¿¡å·ä¼ é€åˆ°çš„å…¶ä»–ç³»ç»Ÿä»¥è¿›è¡Œåˆ†æã€‚ç­–ç•¥è¿è¡Œæ—¶æ”¯æŒæ’å…¥å…¶ä»–æœåŠ¡çš„æ ‡å‡†æ‰©å±•æœºåˆ¶ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸æ‰©å±•å…¶è¯æ±‡è¡¨ï¼Œä»è€Œå¯ä»¥æ ¹æ®ç½‘æ ¼ç”Ÿæˆçš„æ–°ä¿¡å·æ¥å®æ–½ç­–ç•¥ã€‚</li><li><code>å¯ç§»æ¤æ€§</code>ï¼šä½¿ç”¨Istioçš„ç”Ÿæ€ç³»ç»Ÿåœ¨è®¸å¤šæ–¹é¢éƒ½ä¸åŒã€‚Istioå¿…é¡»èƒ½åœ¨ä»»ä½•äº‘ç«¯æˆ–æœ¬åœ°ç¯å¢ƒä¸­è¿è¡Œï¼Œåªéœ€æœ€å°‘çš„åŠªåŠ›ã€‚å°†åŸºäºIstioçš„æœåŠ¡ç§»æ¤åˆ°æ–°ç¯å¢ƒçš„ä»»åŠ¡å¿…é¡»å¾ˆç®€å•ã€‚ä½¿ç”¨Istioï¼Œæ‚¨å¯ä»¥æ“ä½œéƒ¨ç½²åˆ°å¤šä¸ªç¯å¢ƒä¸­çš„å•ä¸ªæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨å¤šä¸ªäº‘ä¸Šéƒ¨ç½²ä»¥å®ç°å†—ä½™ã€‚</li><li><code>ç­–ç•¥ç»Ÿä¸€æ€§</code>ï¼šå°†ç­–ç•¥åº”ç”¨äºæœåŠ¡ä¹‹é—´çš„APIè°ƒç”¨æä¾›äº†å¯¹ç½‘æ ¼è¡Œä¸ºçš„å¤§é‡æ§åˆ¶ã€‚ä½†æ˜¯ï¼Œå°†ç­–ç•¥åº”ç”¨äºä¸ä¸€å®šåœ¨APIçº§åˆ«è¡¨è¾¾çš„èµ„æºä¹ŸåŒæ ·é‡è¦ã€‚ä¾‹å¦‚ï¼Œå¯¹MLè®­ç»ƒä»»åŠ¡æ¶ˆè€—çš„CPUæ•°é‡åº”ç”¨quotaæ¯”å¯¹å¯åŠ¨wrokçš„è°ƒç”¨åº”ç”¨quotaæ›´æœ‰ç”¨ã€‚ä¸ºæ­¤ï¼ŒIstioå°†ç­–ç•¥ç³»ç»Ÿä½œä¸ºå…·æœ‰å…¶è‡ªå·±çš„APIçš„ç‹¬ç‰¹æœåŠ¡æ¥ç»´æŠ¤ï¼Œè€Œä¸æ˜¯å°†ç­–ç•¥ç³»ç»Ÿçƒ˜ç„™åˆ°ä»£ç†Sidecarä¸­ï¼Œä»è€Œä½¿å¾—æœåŠ¡æ ¹æ®éœ€è¦ç›´æ¥ä¸å…¶é›†æˆã€‚</li></ul><h2 id="istioçš„å®‰è£…" tabindex="-1"><a class="header-anchor" href="#istioçš„å®‰è£…" aria-hidden="true">#</a> Istioçš„å®‰è£…</h2><h3 id="ä½¿ç”¨-istioctl-å®‰è£…" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-istioctl-å®‰è£…" aria-hidden="true">#</a> ä½¿ç”¨ Istioctl å®‰è£…</h3><h4 id="_1-æ‹‰å–istioçš„å®‰è£…åŒ…" tabindex="-1"><a class="header-anchor" href="#_1-æ‹‰å–istioçš„å®‰è£…åŒ…" aria-hidden="true">#</a> 1.æ‹‰å–Istioçš„å®‰è£…åŒ…</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-O</span> http://192.168.1.110/file/istio-1.9.5-linux-amd64.tar.gz

$ <span class="token function">ls</span> 
istio-1.9.5-linux-amd64.tar.gz
$ <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> istio-1.9.5-linux-amd64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-å¤åˆ¶istioctlå·¥å…·" tabindex="-1"><a class="header-anchor" href="#_2-å¤åˆ¶istioctlå·¥å…·" aria-hidden="true">#</a> 2.å¤åˆ¶istioctlå·¥å…·</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> istio-1.9.5/
$ <span class="token function">cp</span> bin/istioctl  /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶å®‰è£…-istio" tabindex="-1"><a class="header-anchor" href="#_3-ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶å®‰è£…-istio" aria-hidden="true">#</a> 3.ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶å®‰è£… Istio</h4><p>æœ€ç®€å•çš„é€‰æ‹©æ˜¯ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…<code>default</code>Istio <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">é…ç½®æ–‡ä»¶<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-å®‰è£…ä¸åŒçš„é…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_4-å®‰è£…ä¸åŒçš„é…ç½®æ–‡ä»¶" aria-hidden="true">#</a> 4.å®‰è£…ä¸åŒçš„é…ç½®æ–‡ä»¶</h4><p>é€šè¿‡åœ¨å‘½ä»¤è¡Œä¸Šä¼ é€’é…ç½®æ–‡ä»¶åç§°ï¼Œå¯ä»¥å°†å…¶ä»– Istio é…ç½®æ–‡ä»¶å®‰è£…åˆ°é›†ç¾¤ä¸­ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å‘½ä»¤å¯ç”¨äºå®‰è£…<code>demo</code>é…ç½®æ–‡ä»¶ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl  create  ns istio-system
$ istioctl <span class="token function">install</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">profile</span><span class="token operator">=</span>demo <span class="token parameter variable">-y</span>
âœ” Istio core installed                                                   
âœ” Istiod installed                                                  
âœ” Egress gateways installed                                                        
âœ” Ingress gateways installed                                                        
âœ” Installation complete     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-æ£€æŸ¥å®‰è£…äº†ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_5-æ£€æŸ¥å®‰è£…äº†ä»€ä¹ˆ" aria-hidden="true">#</a> 5.æ£€æŸ¥å®‰è£…äº†ä»€ä¹ˆ</h4><p>è¯¥<code>istioctl</code>å‘½ä»¤å°†<code>IstioOperator</code>ç”¨äºå®‰è£… Istioçš„CRä¿å­˜åœ¨åä¸º<code>installed-state</code>. è€Œä¸æ˜¯æ£€æŸ¥ Istio å®‰è£…çš„éƒ¨ç½²ã€podã€æœåŠ¡å’Œå…¶ä»–èµ„æºï¼Œä¾‹å¦‚ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system get deploy
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-egressgateway    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           25s
istio-ingressgateway   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s
istiod                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-æ³¨å…¥é»˜è®¤å˜é‡" tabindex="-1"><a class="header-anchor" href="#_6-æ³¨å…¥é»˜è®¤å˜é‡" aria-hidden="true">#</a> 6.æ³¨å…¥é»˜è®¤å˜é‡</h4><p>å°†ç›®å½•æ›´æ”¹ä¸º Istio å®‰è£…çš„æ ¹ç›®å½•ã€‚</p><p>é»˜è®¤çš„ Istio å®‰è£…ä½¿ç”¨<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚æ ‡è®°å°†æ‰˜ç®¡åº”ç”¨ç¨‹åºçš„å‘½åç©ºé—´<code>istio-injection=enabled</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl label namespace default istio-injection<span class="token operator">=</span>enabled 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_7-å¸è½½-istio" tabindex="-1"><a class="header-anchor" href="#_7-å¸è½½-istio" aria-hidden="true">#</a> 7.å¸è½½ Istio</h4><p>è¦ä»é›†ç¾¤ä¸­å®Œå…¨å¸è½½ Istioï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl x uninstall <span class="token parameter variable">--purge</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¯é€‰<code>--purge</code>æ ‡å¿—å°†åˆ é™¤æ‰€æœ‰ Istio èµ„æºï¼ŒåŒ…æ‹¬å¯èƒ½ä¸å…¶ä»– Istio æ§åˆ¶å¹³é¢å…±äº«çš„é›†ç¾¤èŒƒå›´çš„èµ„æºã€‚</p><h3 id="æµ‹è¯•ä¸€ä¸ªå®ä¾‹" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•ä¸€ä¸ªå®ä¾‹" aria-hidden="true">#</a> æµ‹è¯•ä¸€ä¸ªå®ä¾‹</h3><h4 id="bookinfo" tabindex="-1"><a class="header-anchor" href="#bookinfo" aria-hidden="true">#</a> Bookinfo</h4><p><strong>Bookinfo åº”ç”¨ç¨‹åºåˆ†ä¸ºå››ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼š</strong></p><ul><li><code>productpage</code>. è¯¥<code>productpage</code>å¾®æœåŠ¡è°ƒç”¨<code>details</code>å’Œ<code>reviews</code>å¾®æœåŠ¡æ¥å¡«å……é¡µé¢ã€‚</li><li><code>details</code>. è¯¥<code>details</code>å¾®æœåŠ¡åŒ…å«å›¾ä¹¦ä¿¡æ¯ã€‚</li><li><code>reviews</code>. è¯¥<code>reviews</code>å¾®æœåŠ¡åŒ…å«äº†ä¹¦è¯„ã€‚å®ƒè¿˜è°ƒç”¨<code>ratings</code>å¾®æœåŠ¡ã€‚</li><li><code>ratings</code>. è¯¥<code>ratings</code>å¾®æœåŠ¡åŒ…å«é¢„å®šä¼´éšä¹¦è¯„æ’åä¿¡æ¯ã€‚</li></ul><p><strong><code>reviews</code>å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬ï¼š</strong></p><ul><li>ç‰ˆæœ¬ v1 ä¸è°ƒç”¨è¯¥<code>ratings</code>æœåŠ¡ã€‚</li><li>ç‰ˆæœ¬ v2 è°ƒç”¨è¯¥<code>ratings</code>æœåŠ¡ï¼Œå¹¶å°†æ¯ä¸ªè¯„çº§æ˜¾ç¤ºä¸º 1 åˆ° 5 é¢—é»‘æ˜Ÿã€‚</li><li>ç‰ˆæœ¬ v3 è°ƒç”¨è¯¥<code>ratings</code>æœåŠ¡ï¼Œå¹¶å°†æ¯ä¸ªè¯„çº§æ˜¾ç¤ºä¸º 1 åˆ° 5 é¢—çº¢æ˜Ÿã€‚</li></ul><p>è¯¥åº”ç”¨ç¨‹åºçš„ç«¯åˆ°ç«¯æ¶æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326474.png" alt="image-20211214154321190" style="zoom:80%;"><h4 id="ä½¿ç”¨istioéƒ¨ç½²åº”ç”¨ç¨‹åºğŸš€" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨istioéƒ¨ç½²åº”ç”¨ç¨‹åºğŸš€" aria-hidden="true">#</a> ä½¿ç”¨Istioéƒ¨ç½²åº”ç”¨ç¨‹åºğŸš€</h4><p>ä½¿ç”¨ Istio è¿è¡Œç¤ºä¾‹ä¸éœ€è¦æ›´æ”¹åº”ç”¨ç¨‹åºæœ¬èº«ã€‚ç›¸åï¼Œæ‚¨åªéœ€è¦åœ¨æ”¯æŒ Istio çš„ç¯å¢ƒä¸­é…ç½®å’Œè¿è¡ŒæœåŠ¡ï¼Œå¹¶åœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹æ³¨å…¥ Envoy sidecarã€‚ç”Ÿæˆçš„éƒ¨ç½²å°†å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062326222.png" alt="image-20211214154410424" style="zoom:80%;"><h4 id="å¯åŠ¨åº”ç”¨æœåŠ¡ğŸš€" tabindex="-1"><a class="header-anchor" href="#å¯åŠ¨åº”ç”¨æœåŠ¡ğŸš€" aria-hidden="true">#</a> å¯åŠ¨åº”ç”¨æœåŠ¡ğŸš€</h4><p>ä½¿ç”¨ä»¥ä¸‹<code>kubectl</code>å‘½ä»¤éƒ¨ç½²æ‚¨çš„åº”ç”¨ç¨‹åºï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="æŸ¥çœ‹æ‰€æœ‰æœåŠ¡ğŸš€" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹æ‰€æœ‰æœåŠ¡ğŸš€" aria-hidden="true">#</a> æŸ¥çœ‹æ‰€æœ‰æœåŠ¡ğŸš€</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc </span>
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
details       ClusterIP   <span class="token number">10.104</span>.17.202    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
kubernetes    ClusterIP   <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    41m
productpage   ClusterIP   <span class="token number">10.110</span>.235.179   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
ratings       ClusterIP   <span class="token number">10.104</span>.53.51     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
reviews       ClusterIP   <span class="token number">10.101</span>.21.63     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m

<span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get pods </span>
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-gwhkf       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
productpage-v1-6b746f74dc-6dtg8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
ratings-v1-b6994bb9-9h2wn         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v1-545db77b95-6cmmv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v2-7bf8c9648f-m2k9d       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v3-84779c7bbc-vd86b       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é€šè¿‡curlè¯·æ±‚æµ‹è¯•ğŸš€" tabindex="-1"><a class="header-anchor" href="#é€šè¿‡curlè¯·æ±‚æµ‹è¯•ğŸš€" aria-hidden="true">#</a> é€šè¿‡Curlè¯·æ±‚æµ‹è¯•ğŸš€</h4><p>è¦ç¡®è®¤ Bookinfo åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œè¯·é€šè¿‡<code>curl</code>æ¥è‡ªæŸä¸ª podçš„å‘½ä»¤å‘å…¶å‘é€è¯·æ±‚ï¼Œä¾‹å¦‚æ¥è‡ª<code>ratings</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot; -c ratings -- curl -sS productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¡®å®šå…¥å£ipå’Œç«¯å£ğŸš€" tabindex="-1"><a class="header-anchor" href="#ç¡®å®šå…¥å£ipå’Œç«¯å£ğŸš€" aria-hidden="true">#</a> ç¡®å®šå…¥å£IPå’Œç«¯å£ğŸš€</h4><p>ç°åœ¨ Bookinfo æœåŠ¡å·²å¯åŠ¨å¹¶è¿è¡Œï¼Œæ‚¨éœ€è¦ä½¿åº”ç”¨ç¨‹åºå¯ä» Kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—®ï¼Œä¾‹å¦‚ä»æµè§ˆå™¨è®¿é—®ã€‚ä¸€ä¸ª<a href="https://istio.io/latest/docs/concepts/traffic-management/#gateways" target="_blank" rel="noopener noreferrer">Istioç½‘å…³<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ç”¨äºæ­¤ç›®çš„ã€‚</p><ol><li><strong><code>ä¸ºåº”ç”¨å®šä¹‰å…¥å£ç½‘å…³</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml </span>
gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong><code>ç¡®è®¤ç½‘å…³å·²åˆ›å»º</code></strong></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get gateway </span>
NAME               AGE
bookinfo-gateway   61s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong><code>æ”¹ä¸ºNodePort</code></strong></li></ol><p>æ­¤å¤„æˆ‘ä»¬å¹¶æ²¡æœ‰å¤–éƒ¨è´Ÿè½½ï¼Œæ‰€ä»¥è¦å°†svcä¿®æ”¹æˆNodePortçš„æ–¹å¼ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system </span>
NAME                   TYPE         CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                      AGE
istio-egressgateway    ClusterIP    <span class="token number">10.102</span>.197.30   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP,443/TCP,15443/TCP                                                     89m
istio-ingressgateway   LoadBalancer <span class="token number">10.109</span>.71.35    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:31964/TCP,80:31467/TCP,443:31845/TCP,31400:31077/TCP,15443:30757/TCP   89m
istiod                 ClusterIP    <span class="token number">10.111</span>.156.86   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15010</span>/TCP,15012/TCP,443/TCP,15014/TCP                                        90m

<span class="token comment">#è®¿é—®masterIP+80ç«¯å£å¯¹åº”æš´éœ²çš„31962</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>æ³¨æ„ï¼š å¦‚æœ EXTERNAL-IP è®¾ç½®äº†è¯¥å€¼ï¼Œåˆ™è¦æ±‚æ‚¨çš„ç¯å¢ƒå…·æœ‰å¯ç”¨äº Ingress ç½‘å…³çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ã€‚å¦‚æœ EXTERNAL-IP å€¼æ˜¯ &lt;none&gt;ï¼ˆæˆ–ä¸€ç›´æ˜¯ &lt;pending&gt; ï¼‰ï¼Œåˆ™è¯´æ˜å¯èƒ½æ‚¨çš„ç¯å¢ƒä¸æ”¯æŒä¸º ingress ç½‘å…³æä¾›å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„åŠŸèƒ½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Service çš„ node port æ–¹å¼è®¿é—®ç½‘å…³ã€‚</code></p></blockquote><p>ä½¿ç”¨ kubectl patch æ›´æ–° istio-ingressgateway æœåŠ¡ç½‘å…³ç±»å‹</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl patch service istio-ingressgateway -n istio-system -p &#39;{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è®¾ç½®å…¥å£ç«¯å£</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·å–ingress ipåœ°å€</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get po <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway <span class="token parameter variable">-n</span> istio-system <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.items[0].status.hostIP}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327570.png" alt="image-20211214170233622"><h4 id="åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™ğŸš€" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™ğŸš€" aria-hidden="true">#</a> åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™ğŸš€</h4><p>åœ¨ä½¿ç”¨ Istio æ§åˆ¶ Bookinfo ç‰ˆæœ¬è·¯ç”±ä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨<a href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules" target="_blank" rel="noopener noreferrer">ç›®æ ‡è§„åˆ™ä¸­<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å®šä¹‰å¯ç”¨ç‰ˆæœ¬ï¼Œç§°ä¸ºå­é›†ã€‚</p><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸º Bookinfo æœåŠ¡åˆ›å»ºé»˜è®¤ç›®æ ‡è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/destination-rule-all.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>åœ¨<code>default</code>ä¸<code>demo</code> <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">é…ç½®è½®å»“<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å…·æœ‰<a href="https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#auto-mutual-tls" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨ç›¸äº’TLS<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å¯ç”¨é»˜è®¤æƒ…å†µä¸‹ã€‚è¦å¼ºåˆ¶å®æ–½åŒå‘ TLSï¼Œè¯·ä½¿ç”¨<code>samples/bookinfo/networking/destination-rule-all-mtls.yaml</code>.</p></blockquote><h4 id="æ¸…ç†ğŸš€" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†ğŸš€" aria-hidden="true">#</a> æ¸…ç†ğŸš€</h4><p>å½“æ‚¨å®Œæˆ Bookinfo ç¤ºä¾‹çš„è¯•éªŒåï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹è¯´æ˜å¸è½½å¹¶æ¸…ç†å®ƒï¼š</p><p>åˆ é™¤è·¯ç”±è§„åˆ™å¹¶ç»ˆæ­¢åº”ç”¨ç¨‹åº Pod</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ samples/bookinfo/platform/kube/cleanup.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç¡®è®¤å…³æœº</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get virtualservices   <span class="token comment">#-- there should be no virtual services</span>
$ kubectl get destinationrules  <span class="token comment">#-- there should be no destination rules</span>
$ kubectl get gateway           <span class="token comment">#-- there should be no gateway</span>
$ kubectl get pods              <span class="token comment">#-- the Bookinfo pods should be deleted</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ä»‹ç»istioæµé‡ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#ä»‹ç»istioæµé‡ç®¡ç†" aria-hidden="true">#</a> ä»‹ç»Istioæµé‡ç®¡ç†</h2><h4 id="é¦–å…ˆæ˜¯istioå¦‚ä½•åœ¨ç½‘æ ¼ç§å¼•å¯¼æµé‡çš„" tabindex="-1"><a class="header-anchor" href="#é¦–å…ˆæ˜¯istioå¦‚ä½•åœ¨ç½‘æ ¼ç§å¼•å¯¼æµé‡çš„" aria-hidden="true">#</a> é¦–å…ˆæ˜¯Istioå¦‚ä½•åœ¨ç½‘æ ¼ç§å¼•å¯¼æµé‡çš„ï¼Ÿ</h4><ol><li>é¦–å…ˆè¦çŸ¥é“æ‰€åœ¨çš„ç«¯ç‚¹åœ¨å“ªé‡Œï¼Ÿ</li><li>ä»¥åŠå®ƒä»¬å±äºå“ªäº›æœåŠ¡ï¼Ÿ</li><li>å¡«å……è‡ªå·±çš„æœåŠ¡æ³¨å†Œï¼ˆå°±æ˜¯å†…éƒ¨çš„æ³¨å†Œè¡¨ï¼Œç”¨æ¥ç”Ÿæˆä¸€äº›Envoyé…ç½®ï¼‰è¿æ¥åˆ°æœåŠ¡å‘ç°ç³»ç»Ÿã€‚</li><li>åœ¨Kubernetesä¸­å®‰è£…Istioï¼Œé‚£ä¹ˆIstioä¼šè‡ªåŠ¨æ£€æµ‹é›†ç¾¤ä¸­çš„æœåŠ¡å’Œç«¯ç‚¹ã€‚</li></ol><h4 id="åœ¨kubernetesä¸­å¦‚ä½•ä½¿ç”¨istio" tabindex="-1"><a class="header-anchor" href="#åœ¨kubernetesä¸­å¦‚ä½•ä½¿ç”¨istio" aria-hidden="true">#</a> åœ¨Kubernetesä¸­å¦‚ä½•ä½¿ç”¨istioï¼Ÿ</h4><p>1.é€šè¿‡Kuberneteså®‰è£…istioä¹‹åå¯¹<code>K8Sä½¿ç”¨CRDæ‰©å±•ï¼Œ ä¹Ÿå°±æ˜¯Kubernetesçš„ APIæ‰©å±•</code>ï¼Œistioä¹Ÿèƒ½åƒå…¶ä»– çš„resoucesä¸€æ ·ä½¿ç”¨ã€‚ 2.é€šè¿‡ä½¿ç”¨Kubrenetes APIçš„æ‰©å±•ï¼Œå¯ä»¥ä½¿ç”¨èµ„æºæœ‰ è™šæ‹ŸæœåŠ¡ã€ç›®çš„è§„åˆ™ã€ç½‘å…³ã€æœåŠ¡æ¡ç›®ã€è¾¹è½¦ã€‚</p><h4 id="åœ¨istioä¸­èƒ½å­¦åˆ°ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#åœ¨istioä¸­èƒ½å­¦åˆ°ä»€ä¹ˆ" aria-hidden="true">#</a> åœ¨istioä¸­èƒ½å­¦åˆ°ä»€ä¹ˆï¼Ÿ</h4><p>1.å¯ä»¥å­¦ä¹ åˆ°æµé‡çš„ç®¡ç†ã€å…¥å£å‡ºå£æµé‡ç®¡ç†ã€‚</p><ul><li><code>è¯·æ±‚è·¯ç”±</code></li><li><code>æ•…éšœæ³¨å…¥</code></li><li><code>äº¤é€šè½¬ç§»</code></li><li><code>TCPæµé‡è½¬ç§»</code></li><li><code>è¯·æ±‚è¶…æ—¶</code></li><li><code>ç†”æ–­</code></li><li><code>é•œåƒ</code></li><li><code>å±€éƒ¨è´Ÿè½½å‡è¡¡</code></li><li><code>å…¥å£çš„ç½‘å…³</code></li><li><code>å‡ºå£çš„è®¿é—®å¤–éƒ¨æœåŠ¡</code></li></ul><h4 id="ä»€ä¹ˆæ˜¯è™šæ‹ŸæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯è™šæ‹ŸæœåŠ¡" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯è™šæ‹ŸæœåŠ¡ï¼Ÿ</h4><p>è™šæ‹ŸæœåŠ¡ä»¥åŠç›®æ ‡è§„åˆ™æ˜¯Istioæµé‡è·¯ç”±åŠŸèƒ½çš„å…³é”®æ„å»ºå—ã€‚è™šæ‹ŸæœåŠ¡å…è®¸æ‚¨é…ç½®å¦‚ä½•å°†è¯·æ±‚çš„è·¯ç”±åˆ°Istioçš„æœåŠ¡ç½‘æ ¼ä¸­çš„æœåŠ¡ã€‚ å»ºç«‹åœ¨Istioå’Œæ‚¨çš„å¹³å°æä¾›åŸºæœ¬çš„è¿æ¥å’Œå‘ç°ä¹‹ä¸Šã€‚æ¯ä¸€ä¸ªè™šæ‹ŸæœåŠ¡éƒ½åŒ…å«äº†ä¸€ç»„æŒ‰é¡ºåºè¯„ä¼°çš„è·¯ç”±è§„åˆ™ï¼Œè®©Istioå°†æ¯ä¸€ä¸ªç»™å®šçš„è™šæ‹ŸæœåŠ¡è¯·æ±‚åŒ¹é…åˆ°ç½‘æ ¼ä¸­ç‰¹å®šçœŸå®çš„ç›®çš„åœ°ã€‚</p><h4 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹ŸæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹ŸæœåŠ¡" aria-hidden="true">#</a> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹ŸæœåŠ¡ï¼Ÿ</h4><p>1.é€šè¿‡å°†å®¢æˆ·ç«¯ä»å®é™…å®ç°å®ƒä»¬çš„ç›®æ ‡å·¥ä½œè´Ÿè½½å‘é€è¯·æ±‚çš„ä½ç½®å¼ºè§£è€¦æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è™šæ‹ŸæœåŠ¡è¿˜æä¾›ä¸€ç§ä¸°å¯Œçš„æ–¹å¼æ¥æŒ‡å®šä¸åŒçš„æµé‡è·¯ç”±è§„åˆ™ï¼Œä»¥å°†æµé‡å‘é€åˆ°è¿™äº›å·¥ä½œè´Ÿè½½ã€‚</p><p>2.ä¸ºä»€ä¹ˆè¯´è¿™å¾ˆæœ‰ç”¨ï¼Ÿ Envoyåœ¨æ‰€æœ‰æœåŠ¡å®ä¾‹ä¹‹é—´ä½¿ç”¨å¾ªç¯è´Ÿè½½å¹³è¡¡æ¥åˆ†é…æµé‡ï¼Œå¯¹æ­¤è¿›è¡Œäº†æ”¹è¿›ï¼Œå¯ä»¥é’ˆå¯¹ç™¾åˆ†æ¯”è¿›è¡Œç‰¹å®šçš„æµé‡å¼•å¯¼ã€‚</p><p>3.å¯ä»¥ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å®šä¸»æœºåæŒ‡å®šæµé‡è¡Œä¸ºã€‚ åœ¨è™šæ‹ŸæœåŠ¡ä¸­ï¼Œä½¿ç”¨è·¯ç”±è§„åˆ™æ¥å‘Šè¯‰Envoyå¦‚ä½•å°†è™šæ‹ŸæœåŠ¡çš„æµé‡å‘é€åˆ°åˆé€‚çš„åœ°æ–¹ã€‚</p><p>4.è¿˜å¯ä»¥å°†å•ä¸ªè™šæ‹ŸæœåŠ¡å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºã€‚ ç»“åˆç½‘å…³çš„æµé‡è§„åˆ™ï¼Œæ§åˆ¶æµé‡è¿›å‡ºã€‚</p><h4 id="è™šæ‹ŸæœåŠ¡å®ä¾‹" tabindex="-1"><a class="header-anchor" href="#è™šæ‹ŸæœåŠ¡å®ä¾‹" aria-hidden="true">#</a> è™šæ‹ŸæœåŠ¡å®ä¾‹</h4><p>ä»¥ä¸‹çš„è™šæ‹ŸæœåŠ¡æ ¹æ®è¯·æ±‚æ˜¯å¦æ¥è‡ªç‰¹å®šçš„ç”¨æˆ·ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬çš„æœåŠ¡ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸»æœºå­—æ®µ" tabindex="-1"><a class="header-anchor" href="#ä¸»æœºå­—æ®µ" aria-hidden="true">#</a> ä¸»æœºå­—æ®µ</h4><p>1.<code>hostså­—æ®µ</code>åˆ—å‡ºäº†è™šæ‹ŸæœåŠ¡çš„ä¸»æœºï¼Œè¿™äº›è·¯ç”±è§„åˆ™é€‚ç”¨çš„ç”¨æˆ·å¯ä»¥å¯»å€ç›®çš„æˆ–ç›®çš„åœ°ã€‚è¿™æ˜¯å®¢æˆ·ç«¯åœ¨å‘ æœåŠ¡å‘é€è¯·æ±‚æ—¶ä½¿ç”¨çš„åœ°å€ã€‚ 2.ä¸»æœºåå¯ä»¥æ˜¯<code>IPåœ°å€</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯<code>DNSåç§°</code>ä»¥åŠè§£æçš„ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> reviews
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è·¯ç”±è§„åˆ™" tabindex="-1"><a class="header-anchor" href="#è·¯ç”±è§„åˆ™" aria-hidden="true">#</a> è·¯ç”±è§„åˆ™</h4><p>1.è¯¥httpéƒ¨åˆ†åŒ…å«è™šæ‹ŸæœåŠ¡çš„è·¯ç”±è§„åˆ™ï¼Œæè¿°äº†å°†<code>HTTP/1.1 HTTP2å’ŒgRPCæµé‡</code>è·¯ç”±åˆ°hostså­—æ®µä¸­æŒ‡å®šçš„ ç›®æ ‡çš„åŒ¹é…æ¡ä»¶å’Œæ“ä½œã€‚ 2.åŒ¹é…æ¡ä»¶ï¼ˆç¤ºä¾‹ä¸­çš„ç¬¬ä¸€ä¸ªè·¯ç”±æœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå› æ­¤ä»¥matchå­—æ®µå¼€å¤´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¸Œæœ›æ­¤è·¯ç”±é€‚ ç”¨äºæ¥è‡ªç”¨æˆ·â€˜jasonâ€™çš„æ‰€æœ‰è¯·æ±‚ï¼Œå› æ­¤æ‚¨ä½¿ç”¨headersã€end-userå’Œexactå­—æ®µæ¥é€‰æ‹©é€‚å½“çš„è¯·æ±‚ã€‚ï¼‰</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
       <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
         <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç›®çš„åœ°" tabindex="-1"><a class="header-anchor" href="#ç›®çš„åœ°" aria-hidden="true">#</a> ç›®çš„åœ°</h4><p>è·¯ç”±éƒ¨åˆ†<code>destinationå­—æ®µ</code>æŒ‡å®šç¬¦åˆæ¡ä»¶çš„æµé‡å®é™…ç›®çš„åœ°ã€‚ ä¸è™šæ‹Ÿä¸»æœºä¸åŒï¼Œç›®æ ‡ä¸»æœºå¿…é¡»å­˜åœ¨äºistioæœåŠ¡æ³¨å†Œè¡¨ä¸­çœŸå®ç›®æ ‡ï¼Œå¦åˆ™Envoyå°†ä¸çŸ¥é“å°†æµé‡å‘é€åˆ°ä½•å¤„ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>routeï¼š
<span class="token punctuation">-</span> <span class="token key atrule">destintion</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
    <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§" tabindex="-1"><a class="header-anchor" href="#è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§" aria-hidden="true">#</a> è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§</h4><p>è·¯ç”±è§„åˆ™æŒ‰ç…§ä¸Šåˆ°ä¸‹çš„é¡ºåºè¿›è¡Œè¯„ä¼°ï¼Œ<code>è™šæ‹ŸæœåŠ¡å®šä¹‰ä¸­çš„ç¬¬ä¸€ä¸ªè§„åˆ™è¢«èµ‹äºˆæœ€é«˜ä¼˜å…ˆçº§ã€‚</code> åœ¨è¿™ç§æƒ…å†µä¸‹ ï¼Œæ‚¨å¸Œæœ›ä»»ä½•ç¬¬ä¸€æ¡è·¯ç”±è§„åˆ™ä¸åŒ¹é…çš„ä¸œè¥¿éƒ½è½¬åˆ°ç¬¬äºŒæ¡è§„åˆ™ä¸­æŒ‡å®šé»˜è®¤çš„ç›®çš„åœ°ã€‚ å› æ­¤ï¼Œç¬¬äºŒæ¡è§„åˆ™ æ²¡æœ‰åŒ¹é…æ¡ä»¶ï¼Œåªæ˜¯å°†æµé‡å®šå‘åˆ°v3å­é›†ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æœ‰å…³è·¯ç”±çš„æ›´å¤šä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#æœ‰å…³è·¯ç”±çš„æ›´å¤šä¿¡æ¯" aria-hidden="true">#</a> æœ‰å…³è·¯ç”±çš„æ›´å¤šä¿¡æ¯</h4><p>è·¯ç”±è§„åˆ™æ˜¯å°†ç‰¹å®šæµé‡å­é›†è·¯ç”±åˆ°ç‰¹å®šç›®çš„åœ°çš„å¼ºå¤§å·¥å…·ã€‚<code>æ‚¨å¯ä»¥å¯¹æµé‡ç«¯å£ã€æ ‡å¤´å­—æ®µã€URLç­‰è®¾ç½®åŒ¹ é…æ¡ä»¶</code>ï¼Œä¾‹å¦‚ï¼šæ­¤è™šæ‹ŸæœåŠ¡å…è®¸ç”¨æˆ·å°†æµé‡å‘é€åˆ°ä¸¤ä¸ªå•ç‹¬çš„æœåŠ¡ï¼Œè¯„åˆ†å’Œè¯„è®ºï¼Œå°±å¥½åƒå®ƒä»¬æ˜¯æ›´å¤§çš„è™šæ‹ŸæœåŠ¡çš„ä¸€éƒ¨åˆ†ä¸€æ ·ã€‚è™šæ‹ŸæœåŠ¡è§„åˆ™æ ¹æ®è¯·æ±‚çš„URLåŒ¹é…æµé‡ï¼Œå¹¶å°†æµé‡è¯·æ±‚å®šå‘åˆ°åˆé€‚çš„æœåŠ¡ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /reviews
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /ratings
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†ä½¿ç”¨åŒ¹é…æ¡ä»¶å¤–ï¼Œæ‚¨è¿˜å¯ä»¥æŒ‰&quot;æƒé‡&quot;ç™¾åˆ†æ¯”åˆ†é…æµé‡ã€‚è¿™å¯¹äºA/Bæµ‹è¯•å’Œé‡‘ä¸é›€å‘å¸ƒå¾ˆæœ‰ç”¨ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> route
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">75</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">25</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨è·¯ç”±è§„åˆ™å¯¹æµé‡æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ï¼š</p><ul><li><code>é™„åŠ æˆ–åˆ é™¤æ ‡é¢˜</code></li><li><code>é‡å†™ç½‘å€</code></li><li><code>ä¸ºå¯¹è¯¥ç›®çš„åœ°çš„è°ƒç”¨è®¾ç½®é‡è¯•ç­–ç•¥</code></li></ul><h4 id="ç›®çš„åœ°è§„åˆ™" tabindex="-1"><a class="header-anchor" href="#ç›®çš„åœ°è§„åˆ™" aria-hidden="true">#</a> ç›®çš„åœ°è§„åˆ™</h4><p>1.ç›®æ ‡è§„åˆ™æ˜¯Istioæµé‡è·¯ç”±åŠŸèƒ½çš„å…³é”®éƒ¨åˆ†ã€‚å¯ä»¥å°†è™šæ‹ŸæœåŠ¡è§†ä¸ºæµé‡å°†è·¯ç”±ç»™å®šç›® çš„åœ°çš„æ–¹å¼ï¼Œç›®æ ‡è§„åˆ™åœ¨è¯„ä¼°è™šæ‹ŸæœåŠ¡è·¯ç”±è§„åˆ™ååº”ç”¨ï¼Œå› æ­¤å®ƒä»¬é€‚ç”¨äºæµé‡çš„&quot;çœŸå®&quot;ç›®æ ‡ã€‚ 2.ç‰¹åˆ«æ˜¯ï¼Œæ‚¨ä½¿ç”¨ç›®æ ‡è§„åˆ™æ¥æŒ‡å®šå‘½åçš„æœåŠ¡å­é›†ï¼Œä¾‹å¦‚æŒ‰ç‰ˆæœ¬å¯¹æ‰€æœ‰ç»™å®šæœåŠ¡çš„å®ä¾‹è¿›è¡Œåˆ†ç»„ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨è™šæ‹ŸæœåŠ¡çš„è·¯ç”±è§„åˆ™ä¸­ä½¿ç”¨è¿™äº›æœåŠ¡å­é›†æ¥æ§åˆ¶åˆ°ä¸åŒæœåŠ¡å®ä¾‹çš„æµé‡ã€‚ 3.ç›®æ ‡è§„åˆ™è¿˜å…è®¸æ‚¨åœ¨è°ƒç”¨æ•´ä¸ªç›®æ ‡æœåŠ¡æˆ–ç‰¹å®šæœåŠ¡å­é›†æ—¶è‡ªå®šä¹‰ Envoy çš„æµé‡ç­–ç•¥ï¼Œä¾‹å¦‚æ‚¨é¦–é€‰çš„è´Ÿ è½½å¹³è¡¡æ¨¡å‹ã€TLS å®‰å…¨æ¨¡å¼æˆ–æ–­è·¯å™¨è®¾ç½®ã€‚</p><h4 id="è´Ÿè½½å¹³è¡¡é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å¹³è¡¡é€‰é¡¹" aria-hidden="true">#</a> è´Ÿè½½å¹³è¡¡é€‰é¡¹</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio ä½¿ç”¨å¾ªç¯è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ä¾‹æ± ä¸­çš„æ¯ä¸ªæœåŠ¡å®ä¾‹ä¾æ¬¡æ”¶åˆ°è¯·æ±‚ã€‚Istio è¿˜æ”¯æŒä»¥ä¸‹æ¨¡å‹ï¼Œæ‚¨å¯ä»¥åœ¨ç›®æ ‡è§„åˆ™ä¸­ä¸ºå¯¹ç‰¹å®šæœåŠ¡æˆ–æœåŠ¡å­é›†çš„è¯·æ±‚æŒ‡å®šè¿™äº›æ¨¡å‹ã€‚</p><ul><li><code>éšæœºï¼š</code>è¯·æ±‚éšæœºè½¬å‘åˆ°æ± ä¸­çš„å®ä¾‹ã€‚</li><li><code>åŠ æƒï¼š</code>æ ¹æ®ç‰¹å®šç™¾åˆ†æ¯”å°†è¯·æ±‚è½¬å‘åˆ°æ± ä¸­çš„å®ä¾‹ã€‚</li><li><code>æœ€å°‘è¯·æ±‚ï¼š</code>è¯·æ±‚è¢«è½¬å‘åˆ°è¯·æ±‚æ•°é‡æœ€å°‘çš„å®ä¾‹ã€‚</li></ul><h4 id="ç›®æ ‡è§„åˆ™ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç›®æ ‡è§„åˆ™ç¤ºä¾‹" aria-hidden="true">#</a> ç›®æ ‡è§„åˆ™ç¤ºä¾‹</h4><p>ä»¥ä¸‹ç¤ºä¾‹ç›®æ ‡è§„åˆ™ä¸ºmy-svcç›®æ ‡æœåŠ¡é…ç½®äº†ä¸‰ä¸ªä¸åŒçš„å­é›†ï¼Œå…·æœ‰ä¸åŒçš„è´Ÿè½½å¹³è¡¡ç­–ç•¥ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>destination<span class="token punctuation">-</span>rule
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>svc
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ªå­é›†éƒ½æ˜¯åŸºäºä¸€ä¸ªæˆ–å¤šä¸ªå®šä¹‰çš„labelsï¼Œåœ¨Kubernetesä¸­ï¼Œå®ƒä»¬æ˜¯é™„åŠ åˆ°Podç­‰å¯¹è±¡çš„é”®/å€¼å¯¹ã€‚è¿™äº›æ ‡ç­¾åº”ç”¨äºKubernetesæœåŠ¡çš„éƒ¨ç½²ï¼Œmetadataä»¥è¯†åˆ«ä¸åŒçš„ç‰ˆæœ¬ã€‚</p><p>é™¤äº†å®šä¹‰å­é›†ä¹‹å¤–ï¼Œæ­¤ç›®æ ‡è§„åˆ™è¿˜å…·æœ‰é’ˆå¯¹æ­¤ç›®æ ‡ä¸­æ‰€æœ‰å­é›†çš„é»˜è®¤æµé‡ç­–ç•¥å’Œä»…é’ˆå¯¹è¯¥å­é›†è¦†ç›–å®ƒçš„å­é›†ç‰¹å®šç­–ç•¥ã€‚åœ¨è¯¥å­—æ®µä¸Šæ–¹å®šä¹‰çš„é»˜è®¤ç­–ç•¥ä¸ºå’Œå­é›†subsets è®¾ç½®ç®€å•çš„éšæœºè´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨ ç­–ç•¥ä¸­ï¼Œ åœ¨ç›¸åº”å­é›†çš„å­—æ®µä¸­æŒ‡å®šäº†å¾ªç¯è´Ÿè½½å‡è¡¡å™¨ã€‚v1v3v2</p><h4 id="ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#ç½‘å…³" aria-hidden="true">#</a> ç½‘å…³</h4><p>1.æ‚¨ä½¿ç”¨ç½‘å…³æ¥ç®¡ç†ç½‘æ ¼çš„å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œè®©æ‚¨<code>æŒ‡å®šè¦è¿›å…¥æˆ–ç¦»å¼€ç½‘æ ¼çš„æµé‡</code>ã€‚ç½‘å…³é…ç½®åº”ç”¨äºåœ¨ç½‘æ ¼è¾¹ç¼˜è¿è¡Œçš„ç‹¬ç«‹ Envoy ä»£ç†ï¼Œè€Œä¸æ˜¯ä¸æœåŠ¡å·¥ä½œè´Ÿè½½ä¸€èµ·è¿è¡Œçš„ Sidecar Envoy ä»£ç†ã€‚ 2.ä¸æ§åˆ¶è¿›å…¥ç³»ç»Ÿçš„æµé‡çš„å…¶ä»–æœºåˆ¶ï¼ˆä¾‹å¦‚ Kubernetes Ingress APIï¼‰ä¸åŒï¼Œ<code>Istio ç½‘å…³è®©æ‚¨å¯ä»¥ä½¿ç”¨ Istio æµé‡è·¯ç”±çš„å…¨éƒ¨åŠŸèƒ½å’Œçµæ´»æ€§</code>ã€‚æ‚¨å¯ä»¥è¿™æ ·åšï¼Œå› ä¸º Istio çš„ç½‘å…³èµ„æºåªå…è®¸æ‚¨é…ç½® 4-6 å±‚è´Ÿè½½å¹³è¡¡å±æ€§ï¼Œä¾‹å¦‚è¦å…¬å¼€çš„ç«¯å£ã€TLS è®¾ç½®ç­‰ã€‚ç„¶åï¼Œæ‚¨æ— éœ€å°†åº”ç”¨å±‚æµé‡è·¯ç”± (L7) æ·»åŠ åˆ°åŒä¸€ API èµ„ æºï¼Œè€Œæ˜¯å°†å¸¸è§„ Istioè™šæ‹ŸæœåŠ¡ç»‘å®šåˆ°ç½‘å…³ã€‚è¿™ä½¿æ‚¨å¯ä»¥åƒç®¡ç† Istio ç½‘æ ¼ä¸­çš„ä»»ä½•å…¶ä»–æ•°æ®å¹³é¢æµé‡ ä¸€æ ·ç®¡ç†ç½‘å…³æµé‡ã€‚ 3.<code>ç½‘å…³ä¸»è¦ç”¨äºç®¡ç†å…¥å£æµé‡ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥é…ç½®å‡ºå£ç½‘å…³</code>ã€‚ä¾‹å¦‚ï¼Œå‡ºå£ç½‘å…³å…è®¸æ‚¨ä¸ºç¦»å¼€ç½‘æ ¼çš„æµé‡é…ç½®ä¸“ç”¨å‡ºå£èŠ‚ç‚¹ï¼Œè®©æ‚¨é™åˆ¶å“ªäº›æœåŠ¡å¯ä»¥æˆ–åº”è¯¥è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œæˆ–è€…å¯ç”¨ å¯¹å‡ºå£æµé‡çš„å®‰å…¨æ§åˆ¶ ä»¥å¢åŠ ç½‘æ ¼çš„å®‰å…¨æ€§ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç½‘å…³æ¥é…ç½®çº¯å†…éƒ¨ä»£ç†ã€‚ 4.Istio æä¾›äº†ä¸€äº›æ‚¨å¯ä»¥ä½¿ç”¨çš„é¢„é…ç½®ç½‘å…³ä»£ç†éƒ¨ç½² (istio-ingressgatewayå’Œistio-egressgateway)å¦‚æœæ‚¨ä½¿ç”¨æˆ‘ä»¬çš„æ¼”ç¤ºå®‰è£…ï¼Œåˆ™ä¼šéƒ¨ç½²ä¸¤è€…ï¼Œè€Œä»…ä½¿ç”¨æˆ‘ä»¬çš„é»˜è®¤é…ç½®æ–‡ä»¶éƒ¨ç½²å…¥å£ç½‘å…³ ã€‚æ‚¨å¯ä»¥å°†è‡ª å·±çš„ç½‘å…³é…ç½®åº”ç”¨äºè¿™äº›éƒ¨ç½²ï¼Œæˆ–è€…éƒ¨ç½²å’Œé…ç½®è‡ªå·±çš„ç½‘å…³ä»£ç†ã€‚</p><h4 id="ç½‘å…³ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç½‘å…³ç¤ºä¾‹" aria-hidden="true">#</a> ç½‘å…³ç¤ºä¾‹</h4><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¤–éƒ¨ HTTPS å…¥å£æµé‡çš„å¯èƒ½ç½‘å…³é…ç½®ï¼š æ­¤ç½‘å…³é…ç½®<code>å…è®¸ HTTPS æµé‡</code>ä»<code>ext-host.example.comç«¯å£ 443 è¿›å…¥ç½‘æ ¼</code>ï¼Œä½†æ²¡æœ‰ä¸ºæµé‡æŒ‡å®šä»»ä½•è·¯ç”±ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>controller
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>cert
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¦æŒ‡å®šè·¯ç”±å¹¶ä½¿ç½‘å…³æŒ‰é¢„æœŸå·¥ä½œï¼Œæ‚¨è¿˜å¿…é¡»å°†ç½‘å…³ç»‘å®šåˆ°è™šæ‹ŸæœåŠ¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è™šæ‹ŸæœåŠ¡çš„gatewayså­— æ®µæ‰§è¡Œæ­¤æ“ä½œï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> virtual<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¤–éƒ¨æµé‡çš„è·¯ç”±è§„åˆ™é…ç½®è™šæ‹ŸæœåŠ¡ã€‚</p><h4 id="æœåŠ¡æ¡ç›®" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡æ¡ç›®" aria-hidden="true">#</a> æœåŠ¡æ¡ç›®</h4><p>æ‚¨å¯ä»¥ä½¿ç”¨æœåŠ¡æ¡ç›®å‘Istioå†…éƒ¨ç»´æŠ¤çš„æœåŠ¡æ³¨å†Œè¡¨æ·»åŠ ä¸€ä¸ªæ¡ç›®ã€‚æ·»åŠ æœåŠ¡æ¡ç›®ä¹‹åï¼ŒEnvoyä»£ç†å¯ä»¥å°†æµé‡å‘é€åˆ°æœåŠ¡ï¼Œå°±å¥½åƒå®ƒæ˜¯ç½‘æ ¼ä¸­çš„æœåŠ¡ä¸€æ ·ã€‚é…ç½®æœåŠ¡æ¡ç›®å…è®¸æ‚¨ç®¡ç†åœ¨ç½‘æ ¼ä¹‹å¤–å…è®¸çš„æœåŠ¡æµé‡ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä»»åŠ¡ï¼š</p><ul><li><code>é‡å®šå‘å’Œè½¬å‘å¤–éƒ¨ç›®çš„åœ°çš„æµé‡</code>ï¼Œä¾‹å¦‚ä»webä½¿ç”¨çš„APIï¼Œæˆ–åˆ°æ—§åŸºç¡€è®¾æ–½ä¸­çš„æœåŠ¡æµé‡ã€‚</li><li><code>ä¸ºå¤–éƒ¨ç›®æ ‡å®šä¹‰é‡è¯•ã€è¶…æ—¶å’Œæ•…éšœæ³¨å…¥ç­–ç•¥ã€‚</code></li><li><code>é€šè¿‡è™šæ‹Ÿæœºæ·»åŠ ç½‘æ ¼ä¸­ï¼Œåœ¨è™šæ‹Ÿæœºä¸­å…è®¸ç½‘æ ¼æœåŠ¡ã€‚</code></li></ul><p>æ‚¨æ— éœ€å¸Œæœ›ç½‘æ ¼æœåŠ¡ä½¿ç”¨çš„æ¯ä¸ªå¤–éƒ¨æœåŠ¡æ·»åŠ æœåŠ¡æ¡ç›®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒIstioå°†Envoyä»£ç†è®¾ç½®ä¸ºå°†è¯·æ±‚ä¼ é€’ç»™æœªçŸ¥æœåŠ¡ã€‚ä½†æ˜¯ï¼Œæ‚¨ä¸èƒ½ä½¿ç”¨IstioåŠŸèƒ½æ¥æ§åˆ¶åˆ°æœªæ¥åœ¨ç½‘æ ¼ä¸­æ³¨å†Œçš„ç›®çš„åœ°æµé‡ã€‚</p><h4 id="æœåŠ¡å…¥å£ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å…¥å£ç¤ºä¾‹" aria-hidden="true">#</a> æœåŠ¡å…¥å£ç¤ºä¾‹</h4><p>ä»¥ä¸‹ç¤ºä¾‹ç½‘æ ¼å¤–éƒ¨æœåŠ¡æ¡ç›®<code>å°†ext-svc.example.com å¤–éƒ¨ä¾èµ–é¡¹æ·»åŠ åˆ° Istio çš„æœåŠ¡æ³¨å†Œè¡¨</code>ï¼š æ‚¨ä½¿ç”¨è¯¥hostså­—æ®µæŒ‡å®šå¤–éƒ¨èµ„æºã€‚æ‚¨å¯ä»¥å®Œå…¨é™å®šå®ƒæˆ–ä½¿ç”¨é€šé…ç¬¦å‰ç¼€çš„åŸŸåã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>entry
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥é…ç½®è™šæ‹ŸæœåŠ¡å’Œç›®æ ‡è§„åˆ™ï¼Œä»¥æ›´ç²¾ç»†çš„æ–¹å¼æ§åˆ¶æœåŠ¡æ¡ç›®çš„æµé‡ï¼Œå°±åƒä¸ºç½‘æ ¼ä¸­çš„ä»»ä½•å…¶ä»–æœåŠ¡é…ç½®æµé‡ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç›®æ ‡è§„åˆ™å°†æµé‡è·¯ç”±é…ç½®ä¸ºä½¿ç”¨<code>åŒå‘ TLS æ¥ä¿æŠ¤ä¸ ext-svc.example.comæˆ‘ä»¬ ä½¿ç”¨æœåŠ¡æ¡ç›®é…ç½®çš„å¤–éƒ¨æœåŠ¡çš„è¿æ¥</code>ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>res<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client_private_key.pem
      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¾¹è½¦" tabindex="-1"><a class="header-anchor" href="#è¾¹è½¦" aria-hidden="true">#</a> è¾¹è½¦</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstioå°†æ¯ä¸ªEnvoä»£ç†é…ç½®ä¸ºæ¥å—å…¶ç›¸å…³å·¥ä½œè´Ÿè½½çš„æ‰€æœ‰ç«¯å£ä¸Šçš„æµé‡ï¼Œå¹¶åœ¨è½¬å‘æµé‡æ—¶åˆ° è¾¾ç½‘æ ¼ä¸­çš„æ¯ä¸ªå·¥ä½œè´Ÿè½½ã€‚æ‚¨å¯ä»¥ä½¿ç”¨sidecaré…ç½®æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li><code>å¾®è°ƒEnvoyä»£ç†æ¥å—çš„ç«¯å£å’Œåè®®é›†</code></li><li><code>é™åˆ¶Envoyä»£ç†å¯ä»¥è®¿é—®çš„æœåŠ¡é›†</code></li></ul><p>æ‚¨å¯èƒ½å¸Œæœ›åœ¨å¤§å‹çš„åº”ç”¨ç¨‹åºåƒè¿™æ ·é™åˆ¶sidecarçš„å¯è®¿é—®æ€§ï¼Œå…¶ä¸­å°†æ¯ä¸ªä»£ç†é…ç½®ä¸ºè®¿é—®ç½‘æ ¼ä¸­çš„æ‰€æœ‰ å…¶ä»–æœåŠ¡å¯èƒ½ä¼šç”±äºé«˜å†…å­˜çš„ä½¿ç”¨ç‡è€Œå½±å“ç½‘æ ¼çš„æ€§èƒ½ã€‚</p><p>æ‚¨å¯ä»¥æŒ‡å®šå¸Œæœ›å°† sidecar é…ç½®åº”ç”¨äºç‰¹å®šå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ workloadSelector. ä¾‹å¦‚ï¼Œä»¥ä¸‹ sidecar é…ç½®å°†å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡é…ç½®bookinfoä¸ºä»…è®¿é—®åœ¨åŒä¸€å‘½åç©ºé—´å’Œ Istio æ§åˆ¶å¹³é¢ä¸­è¿è¡Œçš„æœåŠ¡ï¼ˆIstio çš„å‡ºå£å’Œé¥æµ‹åŠŸèƒ½éœ€è¦ï¼‰ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Sidecar
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;./*&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;istio-system/*&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•" aria-hidden="true">#</a> ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•</h4><p>é™¤äº†å¸®åŠ©æ‚¨å¼•å¯¼ç½‘æ ¼å‘¨å›´çš„æµé‡å¤–ï¼ŒIstio è¿˜æä¾›äº†å¯é€‰çš„æ•…éšœæ¢å¤å’Œæ•…éšœæ³¨å…¥åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€é…ç½®è¿™äº›åŠŸèƒ½ã€‚ä½¿ç”¨è¿™äº›åŠŸèƒ½å¯ä»¥å¸®åŠ©æ‚¨çš„åº”ç”¨ç¨‹åºå¯é åœ°è¿è¡Œï¼Œç¡®ä¿æœåŠ¡ç½‘æ ¼å¯ä»¥å®¹å¿æ•…éšœèŠ‚ç‚¹å¹¶é˜²æ­¢å±€éƒ¨æ•…éšœçº§è”åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</p><h4 id="è¶…æ—¶" tabindex="-1"><a class="header-anchor" href="#è¶…æ—¶" aria-hidden="true">#</a> è¶…æ—¶</h4><p><code>è¶…æ—¶æ˜¯ Envoy ä»£ç†åº”è¯¥ç­‰å¾…æ¥è‡ªç»™å®šæœåŠ¡çš„å›å¤çš„æ—¶é—´é‡ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šæ— é™æœŸåœ°ç­‰å¾…å›å¤ï¼Œå¹¶ä¸”è°ƒç”¨ åœ¨å¯é¢„æµ‹çš„æ—¶é—´èŒƒå›´å†…æˆåŠŸæˆ–å¤±è´¥ã€‚</code>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio ä¸­ç¦ç”¨äº† HTTP è¯·æ±‚çš„ Envoy è¶…æ—¶.</p><p>å¯¹äºæŸäº›åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ï¼ŒIstio çš„é»˜è®¤è¶…æ—¶å¯èƒ½ä¸åˆé€‚ã€‚ä¾‹å¦‚ï¼Œè¿‡é•¿çš„è¶…æ—¶å¯èƒ½ä¼šå¯¼è‡´ç­‰å¾…æ¥è‡ªå¤±è´¥æœåŠ¡çš„å›å¤çš„å»¶è¿Ÿè¿‡é•¿ï¼Œè€Œè¿‡çŸ­çš„è¶…æ—¶å¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨åœ¨ç­‰å¾…æ¶‰åŠå¤šä¸ªæœåŠ¡çš„æ“ä½œè¿”å›æ—¶ä¸å¿…è¦åœ°å¤±è´¥ã€‚ä¸ºäº†æ‰¾åˆ°å¹¶ä½¿ç”¨æ‚¨çš„æœ€ä½³è¶…æ—¶è®¾ç½®ï¼ŒIstio å…è®¸æ‚¨ä½¿ç”¨è™šæ‹ŸæœåŠ¡è½»æ¾åœ°åœ¨æ¯ä¸ªæœåŠ¡çš„åŸºç¡€ä¸ŠåŠ¨æ€è°ƒæ•´è¶…æ—¶ï¼Œè€Œæ— éœ€ç¼–è¾‘æ‚¨çš„æœåŠ¡ä»£ç ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼Œå®ƒä¸ºè°ƒç”¨ rating æœåŠ¡çš„ v1 å­é›†æŒ‡å®šäº† 10 ç§’çš„è¶…æ—¶æ—¶é—´ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é‡è¯•" tabindex="-1"><a class="header-anchor" href="#é‡è¯•" aria-hidden="true">#</a> é‡è¯•</h4><p><code>é‡è¯•è®¾ç½®æŒ‡å®š Envoy ä»£ç†åœ¨åˆå§‹è°ƒç”¨å¤±è´¥æ—¶å°è¯•è¿æ¥æœåŠ¡çš„æœ€å¤§æ¬¡æ•°ã€‚</code>é‡è¯•å¯ä»¥é€šè¿‡ç¡®ä¿è°ƒç”¨ä¸ä¼šå› ä¸º ä¸´æ—¶æ€§é—®é¢˜ï¼ˆä¾‹å¦‚ä¸´æ—¶è¿‡è½½çš„æœåŠ¡æˆ–ç½‘ç»œï¼‰è€Œæ°¸ä¹…å¤±è´¥ï¼Œä»è€Œæé«˜æœåŠ¡å¯ç”¨æ€§å’Œåº”ç”¨ç¨‹åºæ€§èƒ½ã€‚é‡è¯•é—´éš”ï¼ˆ25ms+ï¼‰æ˜¯å¯å˜çš„ï¼Œç”± Istio è‡ªåŠ¨ç¡®å®šï¼Œé˜²æ­¢è¢«è°ƒç”¨çš„æœåŠ¡è¢«è¯·æ±‚æ·¹æ²¡ã€‚HTTP è¯·æ±‚çš„é»˜è®¤é‡è¯•è¡Œä¸ºæ˜¯ åœ¨è¿”å›é”™è¯¯ä¹‹å‰é‡è¯•ä¸¤æ¬¡ã€‚</p><p>ä¸è¶…æ—¶ä¸€æ ·ï¼ŒIstio çš„é»˜è®¤é‡è¯•è¡Œä¸ºå¯èƒ½ä¸é€‚åˆæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨å»¶è¿Ÿï¼ˆå¤±è´¥çš„æœåŠ¡é‡è¯•æ¬¡æ•°è¿‡å¤šå¯èƒ½ä¼šå‡æ…¢é€Ÿåº¦ï¼‰æˆ–å¯ç”¨æ€§æ–¹é¢çš„éœ€æ±‚ã€‚ä¹Ÿåƒè¶…æ—¶ä¸€æ ·ï¼Œæ‚¨å¯ä»¥åœ¨è™šæ‹ŸæœåŠ¡ä¸­åŸºäºæ¯ä¸ªæœåŠ¡è°ƒæ•´é‡è¯•è®¾ç½®ï¼Œè€Œæ— éœ€æ¥è§¦æ‚¨çš„æœåŠ¡ä»£ç ã€‚æ‚¨è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ¯æ¬¡é‡è¯•è¶…æ—¶æ¥è¿›ä¸€æ­¥ä¼˜åŒ–æ‚¨çš„é‡è¯•è¡Œä¸ºï¼ŒæŒ‡å®šæ‚¨å¸Œæœ›ç­‰å¾…æ¯æ¬¡é‡è¯•å°è¯•æˆåŠŸè¿æ¥åˆ°æœåŠ¡çš„æ—¶é—´é‡ã€‚ä»¥ä¸‹ç¤ºä¾‹åœ¨åˆå§‹è°ƒç”¨å¤±è´¥åé…ç½®æœ€å¤š 3 æ¬¡é‡è¯•ä»¥è¿æ¥åˆ°æ­¤æœåŠ¡å­é›†ï¼Œ æ¯æ¬¡é‡è¯•æ—¶é—´ä¸º 2 ç§’ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">retries</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç†”æ–­" tabindex="-1"><a class="header-anchor" href="#ç†”æ–­" aria-hidden="true">#</a> ç†”æ–­</h4><p><code>ç†”æ–­æ˜¯ Istio æä¾›çš„å¦ä¸€ç§æœ‰ç”¨çš„æœºåˆ¶ï¼Œç”¨äºåˆ›å»ºåŸºäºå¾®æœåŠ¡çš„å¼¹æ€§åº”ç”¨ç¨‹åºã€‚</code>åœ¨æ–­è·¯å™¨ä¸­ï¼Œæ‚¨å¯ä»¥ è®¾ç½®å¯¹æœåŠ¡ä¸­å„ä¸ªä¸»æœºçš„è°ƒç”¨é™åˆ¶ï¼Œä¾‹å¦‚å¹¶å‘è¿æ¥æ•°æˆ–å¯¹è¯¥ä¸»æœºçš„è°ƒç”¨å¤±è´¥çš„æ¬¡æ•°ã€‚ä¸€æ—¦è¾¾åˆ°è¯¥é™åˆ¶ï¼Œæ–­è·¯å™¨å°±ä¼šâ€œè·³é—¸â€å¹¶åœæ­¢ä¸è¯¥ä¸»æœºçš„è¿›ä¸€æ­¥è¿æ¥ã€‚ä½¿ç”¨æ–­è·¯å™¨æ¨¡å¼å¯ä»¥å®ç°å¿«é€Ÿæ•…éšœï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯å°è¯•è¿æ¥åˆ°è¿‡è½½æˆ–æ•…éšœä¸»æœºã€‚</p><p>ç”±äºæ–­è·¯å™¨é€‚ç”¨äºè´Ÿè½½å¹³è¡¡æ± ä¸­çš„â€œçœŸå®â€ç½‘æ ¼ç›®æ ‡ï¼Œæ‚¨å¯ä»¥åœ¨ç›®æ ‡è§„åˆ™ä¸­é…ç½®æ–­è·¯å™¨é˜ˆå€¼ ï¼Œå¹¶å°†è®¾ç½®åº” ç”¨äºæœåŠ¡ä¸­çš„æ¯ä¸ªå•ç‹¬çš„ä¸»æœºã€‚ä»¥ä¸‹ç¤ºä¾‹reviewså°† v1 å­é›†çš„æœåŠ¡å·¥ä½œè´Ÿè½½çš„å¹¶å‘è¿æ¥æ•°é™åˆ¶ä¸º 100ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
        <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
          <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ•…éšœæ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#æ•…éšœæ³¨å…¥" aria-hidden="true">#</a> æ•…éšœæ³¨å…¥</h4><p><code>é…ç½®å¥½ç½‘ç»œï¼ˆåŒ…æ‹¬æ•…éšœæ¢å¤ç­–ç•¥ï¼‰åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Istio çš„æ•…éšœæ³¨å…¥æœºåˆ¶æ¥æµ‹è¯•æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ•…éšœæ¢å¤èƒ½åŠ›ã€‚</code>æ•…éšœæ³¨å…¥æ˜¯ä¸€ç§å°†é”™è¯¯å¼•å…¥ç³»ç»Ÿä»¥ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—å¹¶ä»é”™è¯¯æ¡ä»¶ä¸­æ¢å¤çš„æµ‹è¯•æ–¹æ³•ã€‚ä½¿ç”¨æ•…éšœæ³¨å…¥å¯¹äºç¡®ä¿æ‚¨çš„æ•…éšœæ¢å¤ç­–ç•¥ä¸ä¼šä¸å…¼å®¹æˆ–é™åˆ¶è¿‡å¤šï¼Œå¯èƒ½ä¼šå¯¼è‡´å…³é”®æœåŠ¡ä¸å¯ç”¨ç‰¹åˆ«æœ‰ç”¨ã€‚</p><p>ä¸å…¶ä»–å¼•å…¥é”™è¯¯çš„æœºåˆ¶ï¼ˆä¾‹å¦‚å»¶è¿Ÿæ•°æ®åŒ…æˆ–åœ¨ç½‘ç»œå±‚æ€æ­» podï¼‰ä¸åŒï¼ŒIstio å…è®¸æ‚¨åœ¨åº”ç”¨ç¨‹åºå±‚æ³¨å…¥æ•…éšœã€‚è¿™ä½¿æ‚¨å¯ä»¥æ³¨å…¥æ›´å¤šç›¸å…³æ•…éšœï¼Œä¾‹å¦‚ HTTP é”™è¯¯ä»£ç ï¼Œä»¥è·å¾—æ›´å¤šç›¸å…³ç»“æœã€‚</p><p>æ‚¨å¯ä»¥æ³¨å…¥ä¸¤ç§ç±»å‹çš„æ•…éšœï¼Œå‡ä½¿ç”¨ è™šæ‹ŸæœåŠ¡è¿›è¡Œé…ç½®ï¼š</p><ul><li><code>å»¶è¿Ÿï¼š</code>å»¶è¿Ÿæ˜¯è®¡æ—¶å¤±è´¥ã€‚å®ƒä»¬æ¨¡ä»¿å¢åŠ çš„ç½‘ç»œå»¶è¿Ÿæˆ–è¿‡è½½çš„ä¸Šæ¸¸æœåŠ¡ã€‚</li><li><code>ä¸­æ­¢ï¼š</code>ä¸­æ­¢æ˜¯å´©æºƒå¤±è´¥ã€‚å®ƒä»¬æ¨¡ä»¿ä¸Šæ¸¸æœåŠ¡ä¸­çš„æ•…éšœã€‚ä¸­æ­¢é€šå¸¸ä»¥ HTTP é”™è¯¯ä»£ç æˆ– TCP è¿æ¥å¤±è´¥çš„ å½¢å¼å‡ºç°ã€‚</li></ul><p>ä¾‹å¦‚ï¼Œæ­¤è™šæ‹ŸæœåŠ¡å¯¹ratingsæœåŠ¡çš„æ¯ 1000 ä¸ªè¯·æ±‚ä¸­çš„ 1 ä¸ªå¼•å…¥äº† 5 ç§’çš„å»¶è¿Ÿã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sidecaræ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#sidecaræ³¨å…¥" aria-hidden="true">#</a> Sidecaræ³¨å…¥</h2><h4 id="å¯¹å·¥ä½œè´Ÿè½½çš„ä¸€äº›è¦æ±‚" tabindex="-1"><a class="header-anchor" href="#å¯¹å·¥ä½œè´Ÿè½½çš„ä¸€äº›è¦æ±‚" aria-hidden="true">#</a> å¯¹å·¥ä½œè´Ÿè½½çš„ä¸€äº›è¦æ±‚</h4><p>æ”¯æŒçš„å·¥ä½œè´Ÿè½½ç±»å‹ï¼š</p><ul><li><code>Job</code></li><li><code>DaemonSet</code></li><li><code>ReplicaSet</code></li><li><code>Pod</code></li><li><code>Deployment</code></li></ul><p>ç­‰ï¼Œå¯¹è¿™äº›å·¥ä½œè´Ÿè½½çš„è¦æ±‚å¦‚ä¸‹ï¼š</p><ul><li>è¦æ­£ç¡®å‘½åæœåŠ¡ç«¯å£ï¼š <ul><li><code>Service</code> å¯¹è±¡ä¸­çš„ <code>Port</code> éƒ¨åˆ†å¿…é¡»ä»¥ &quot;åè®®å&quot; ä¸ºå‰ç¼€ï¼Œç›®å‰æ”¯æŒçš„åè®®ååŒ…æ‹¬ <code>http</code>ï¼Œ<code>http2</code>ï¼Œ<code>mongo</code>ï¼Œ<code>redis</code> ä¸ <code>grpc</code>ï¼›</li><li>istio ä¼šå‘½åæ¥ç¡®å®šä¸ºç«¯å£æä¾›ä»€ä¹ˆæ ·çš„æœåŠ¡ï¼Œä¸ç¬¦åˆå‘½åè§„èŒƒçš„ç«¯å£ä¼šè¢«å½“åš TCP æœåŠ¡å™¨ï¼Œå…¶åŠŸèƒ½æ”¯æŒèŒƒå›´ä¼šå¤§å¹…ç¼©å°ã€‚</li></ul></li><li>å·¥ä½œè´Ÿè½½çš„ Pod å¿…é¡»æœ‰å…³è”çš„ Serviceï¼š <ul><li>ä¸ºæ»¡è¶³æœåŠ¡å‘ç°çš„éœ€è¦ï¼Œæ‰€æœ‰ Pod éƒ½å¿…é¡»æœ‰å…³è”çš„æœåŠ¡ï¼›</li><li>å®˜æ–¹å»ºè®®ä¸º Pod æ¨¡æ¿åŠ å…¥ä¸¤ä¸ªæ ‡ç­¾ï¼š<code>app</code> ä¸ <code>version</code>ï¼Œåˆ†åˆ«æ ‡æ³¨åº”ç”¨åç§°ä¸ç‰ˆæœ¬ï¼Œè™½ä»…æ˜¯ä¸ªå»ºè®®ï¼Œä½† istio å¾ˆå¤šé»˜è®¤ç­–ç•¥ä¼šå¼•ç”¨è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰ä¼šå¼•å‘å¾ˆå¤šä¸å¿…è¦çš„éº»çƒ¦ã€‚</li></ul></li></ul><h4 id="æ‰‹å·¥æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#æ‰‹å·¥æ³¨å…¥" aria-hidden="true">#</a> æ‰‹å·¥æ³¨å…¥</h4><p>åˆ›å»ºä¸€ä¸ªdeploymentåšnginxçš„podæ§åˆ¶å™¨ï¼Œå‰¯æœ¬ç»´æŒåœ¨2ä¸ªã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># cat deploymen.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> test
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deploymen.yaml  </span>
deployment.apps/test created
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>istioctl kube-inject ä¼šå°† istio ç›¸å…³å®¹å™¨æ³¨å…¥åº”ç”¨ï¼Œ&quot;-o&quot; å‚æ•°å°†æ³¨å…¥ç»“æœç”Ÿæˆ yaml æ–‡ä»¶ ï¼Œæ–¹ä¾¿è§‚å¯Ÿä½¿ç”¨æ­¤å‘½ä»¤ä¸ &quot;kubectl apply -f&quot; çš„åŒºåˆ«ï¼›</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject -f deployment.yaml -o deployment-inject.yaml  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ–°çš„ yaml æ–‡ä»¶ä¸­å¤šå‡ºäº† &quot;Sidecar&quot; å®¹å™¨ï¼Œ å¹¶ä¸”å‡ºç°äº†1ä¸ªåˆå§‹åŒ–å®¹å™¨ (initContainers) &quot;istio-init&quot; ï¼Œåˆå§‹åŒ–å®¹å™¨å³ç”¨æ¥åŠ«æŒåº”ç”¨é€šä¿¡åˆ° &quot;Sidecar&quot; å®¹å™¨çš„å·¥å…·ï¼›</p><p>å¯ç›´æ¥ &quot;kubectl apply -f&quot; ç”Ÿæˆçš„ yaml æ–‡ä»¶ï¼Œ<code>æ³¨å…¥å Nginx åº”ç”¨ ä¸ Istio-Proxy å…±äº«ç½‘ç»œå‘½åç©ºé—´</code> ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject  -f /root/deploymen.yaml | kubectl apply -f - -n test </span>
deployment.apps/test configured
<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n test </span>
NAME                    READY   STATUS    RESTARTS   AGE
test-67b6d4d78c-jzzml   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s
test-67b6d4d78c-sfxk8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  -n test test-67b6d4d78c-jzzml -c istio-proxy -- netstat -ntlp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:80              <span class="token number">0.0</span>.0.0:*               LISTEN      -                   
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15000         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15004         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1</span>/pilot-agent       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::15020                :::*                    LISTEN      <span class="token number">1</span>/pilot-agent       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::80                   :::*                    LISTEN      -                   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è¯·æ±‚è·¯ç”±" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚è·¯ç”±" aria-hidden="true">#</a> è¯·æ±‚è·¯ç”±</h2><h4 id="ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>éƒ¨ç½²<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚</li><li>äº†è§£äº†æµé‡ç®¡ç†çš„åŸºç¡€æ¦‚å¿µï¼Œä»¥åŠä¸“ä¸šè¯­æœ¯ã€‚</li></ul><blockquote><p>æ³¨æ„ï¼š</p><p>Istio <a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ç”±å››ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ç»„æˆï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰å¤šä¸ªç‰ˆæœ¬ã€‚å…¶ä¸­ä¸€ä¸ªå¾®æœåŠ¡çš„ä¸‰ä¸ªä¸åŒç‰ˆæœ¬<code>reviews</code>å·²éƒ¨ç½²å¹¶åŒæ—¶è¿è¡Œã€‚ä¸ºäº†è¯´æ˜è¿™å¯¼è‡´çš„é—®é¢˜ï¼Œè¯·<code>/productpage</code>åœ¨æµè§ˆå™¨ä¸­è®¿é—® Bookinfo åº”ç”¨ç¨‹åºå¹¶åˆ·æ–°å‡ æ¬¡ã€‚æ‚¨ä¼šæ³¨æ„åˆ°ï¼Œæœ‰æ—¶ä¹¦è¯„è¾“å‡ºåŒ…å«æ˜Ÿçº§ï¼Œæœ‰æ—¶åˆ™ä¸åŒ…å«ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæ²¡æœ‰æ˜ç¡®çš„é»˜è®¤æœåŠ¡ç‰ˆæœ¬æ¥è·¯ç”±ï¼ŒIstio ä¼šä»¥å¾ªç¯æ–¹å¼å°†è¯·æ±‚è·¯ç”±åˆ°æ‰€æœ‰å¯ç”¨ç‰ˆæœ¬ã€‚</p></blockquote><h4 id="åº”ç”¨è™šæ‹ŸæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨è™šæ‹ŸæœåŠ¡" aria-hidden="true">#</a> åº”ç”¨è™šæ‹ŸæœåŠ¡</h4><p>è¦ä»…è·¯ç”±åˆ°ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥åº”ç”¨ä¸ºå¾®æœåŠ¡è®¾ç½®é»˜è®¤ç‰ˆæœ¬çš„è™šæ‹ŸæœåŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè™šæ‹ŸæœåŠ¡ä¼šå°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°<code>v1</code>æ¯ä¸ªå¾®æœåŠ¡ã€‚</p><ol><li>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åº”ç”¨è™šæ‹ŸæœåŠ¡ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å› ä¸ºé…ç½®ä¼ æ’­æœ€ç»ˆæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ç­‰å¾…å‡ ç§’é’Ÿè®©è™šæ‹ŸæœåŠ¡ç”Ÿæ•ˆã€‚</p><ol start="2"><li>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ˜¾ç¤ºå®šä¹‰çš„è·¯ç”±ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat istio<span class="token punctuation">-</span>1.9.5/samples/bookinfo/networking/virtual<span class="token punctuation">-</span>service<span class="token punctuation">-</span>all<span class="token punctuation">-</span>v1.yaml 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> productpage
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> details
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> details
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æ‚¨è¿˜å¯ä»¥<code>subset</code>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ˜¾ç¤ºç›¸åº”çš„å®šä¹‰ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get destinationrules <span class="token parameter variable">-o</span> yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‚¨å·²å°† Istio é…ç½®ä¸ºè·¯ç”±åˆ°<code>v1</code>Bookinfo å¾®æœåŠ¡çš„ç‰ˆæœ¬ï¼Œæœ€é‡è¦çš„æ˜¯<code>reviews</code>æœåŠ¡ç‰ˆæœ¬ 1ã€‚</p><h4 id="æµ‹è¯•æ–°çš„è·¯ç”±é…ç½®" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æ–°çš„è·¯ç”±é…ç½®" aria-hidden="true">#</a> æµ‹è¯•æ–°çš„è·¯ç”±é…ç½®</h4><p>æ‚¨å¯ä»¥é€šè¿‡å†æ¬¡åˆ·æ–°<code>/productpage</code> Bookinfo åº”ç”¨ç¨‹åºè½»æ¾æµ‹è¯•æ–°é…ç½®ã€‚</p><ol><li><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Bookinfo ç«™ç‚¹ã€‚URL æ˜¯<code>http://$GATEWAY_URL/productpage</code>ï¼Œå…¶ä¸­<code>$GATEWAY_URL</code>æ˜¯å…¥å£çš„å¤–éƒ¨ IP åœ°å€ï¼Œå¦‚<a href="https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ–‡æ¡£ä¸­æ‰€è¿°ã€‚</p><p>è¯·æ³¨æ„ï¼Œæ— è®ºæ‚¨åˆ·æ–°å¤šå°‘æ¬¡ï¼Œé¡µé¢çš„è¯„è®ºéƒ¨åˆ†éƒ½ä¸ä¼šæ˜¾ç¤ºè¯„åˆ†æ˜Ÿã€‚è¿™æ˜¯å› ä¸ºæ‚¨å°† Istio é…ç½®ä¸ºå°†è¯„è®ºæœåŠ¡çš„æ‰€æœ‰æµé‡è·¯ç”±åˆ°è¯¥ç‰ˆæœ¬<code>reviews:v1</code>ï¼Œå¹¶ä¸”è¯¥ç‰ˆæœ¬çš„æœåŠ¡ä¸è®¿é—®æ˜Ÿçº§è¯„åˆ†æœåŠ¡ã€‚</p></li></ol><p>æ‚¨å·²æˆåŠŸå®Œæˆæ­¤ä»»åŠ¡çš„ç¬¬ä¸€éƒ¨åˆ†ï¼šå°†æµé‡è·¯ç”±åˆ°æœåŠ¡çš„ä¸€ä¸ªç‰ˆæœ¬</p><h4 id="åŸºäºç”¨æˆ·èº«ä»½çš„è·¯ç”±" tabindex="-1"><a class="header-anchor" href="#åŸºäºç”¨æˆ·èº«ä»½çš„è·¯ç”±" aria-hidden="true">#</a> åŸºäºç”¨æˆ·èº«ä»½çš„è·¯ç”±</h4><p>æ¥ä¸‹æ¥ï¼Œæ‚¨å°†æ›´æ”¹è·¯ç”±é…ç½®ï¼Œä»¥ä¾¿å°†æ¥è‡ªç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æµé‡è·¯ç”±åˆ°ç‰¹å®šæœåŠ¡ç‰ˆæœ¬ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¥è‡ªåä¸º Jason çš„ç”¨æˆ·çš„æ‰€æœ‰æµé‡éƒ½å°†è·¯ç”±åˆ°æœåŠ¡<code>reviews:v2</code>ã€‚</p><p>è¯¥ç¤ºä¾‹çš„å¯ç”¨æ˜¯å› ä¸ºè¯¥<code>productpage</code>æœåŠ¡å°†è‡ªå®šä¹‰<code>end-user</code>æ ‡å¤´æ·»åŠ åˆ°æ‰€æœ‰åˆ°è¯„è®ºæœåŠ¡çš„å‡ºç«™ HTTP è¯·æ±‚ã€‚</p><p>Istio è¿˜æ”¯æŒåœ¨å…¥å£ç½‘å…³ä¸ŠåŸºäºå¼ºè®¤è¯ JWT çš„è·¯ç”±ï¼Œæœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://istio.io/latest/docs/tasks/security/authentication/jwt-route" target="_blank" rel="noopener noreferrer">åŸºäº JWT å£°æ˜çš„è·¯ç”±<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><p>è¯·è®°ä½ï¼Œ<code>reviews:v2</code>æ˜¯åŒ…å«æ˜Ÿçº§è¯„åˆ†åŠŸèƒ½çš„ç‰ˆæœ¬ã€‚</p><ol><li>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯ç”¨åŸºäºç”¨æˆ·çš„è·¯ç”±ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ç¡®è®¤è§„åˆ™å·²åˆ›å»ºï¼š</li></ol><p>åˆ›å»ºè§„åˆ™å…è®¸ç”¨æˆ·jasone</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-test-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>åœ¨<code>/productpage</code>Bookinfo åº”ç”¨ç¨‹åºä¸Šï¼Œä»¥ user èº«ä»½ç™»å½•<code>jason</code>ã€‚åˆ·æ–°æµè§ˆå™¨ã€‚ä½ çœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿæ˜Ÿçº§è¯„åˆ†æ˜¾ç¤ºåœ¨æ¯æ¡è¯„è®ºæ—è¾¹ã€‚</p></li><li><p>ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½ç™»å½•ï¼ˆé€‰æ‹©æ‚¨æƒ³è¦çš„ä»»ä½•åç§°ï¼‰ã€‚åˆ·æ–°æµè§ˆå™¨ã€‚ç°åœ¨æ˜Ÿæ˜Ÿä¸è§äº†ã€‚è¿™æ˜¯å› ä¸ºæµé‡è¢«è·¯ç”±åˆ°<code>reviews:v1</code>é™¤äº† Jason ä¹‹å¤–çš„æ‰€æœ‰ç”¨æˆ·ã€‚æ‚¨å·²æˆåŠŸé…ç½® Istio ä»¥æ ¹æ®ç”¨æˆ·èº«ä»½è·¯ç”±æµé‡ã€‚</p></li></ol><h4 id="æ¸…ç†" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤åº”ç”¨ç¨‹åºè·¯ç”±è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="æ•…éšœæ³¨å…¥-1" tabindex="-1"><a class="header-anchor" href="#æ•…éšœæ³¨å…¥-1" aria-hidden="true">#</a> æ•…éšœæ³¨å…¥</h2><h4 id="ç¯å¢ƒå‡†å¤‡-1" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-1" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>éƒ¨ç½²<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç›®æ ‡è§„åˆ™ã€‚</li><li>äº†è§£äº†æµé‡ç®¡ç†çš„åŸºç¡€æ¦‚å¿µï¼Œä»¥åŠä¸“ä¸šè¯­æœ¯ã€‚</li></ul><blockquote><p>é€šè¿‡æ‰§è¡Œ <a href="https://istio.io/latest/docs/tasks/traffic-management/request-routing/" target="_blank" rel="noopener noreferrer">è¯·æ±‚è·¯ç”±<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä»»åŠ¡æˆ–è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åº”ç”¨åº”ç”¨ç¨‹åºç‰ˆæœ¬è·¯ç”±ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="æ³¨å…¥httpå»¶è¿Ÿé”™è¯¯" tabindex="-1"><a class="header-anchor" href="#æ³¨å…¥httpå»¶è¿Ÿé”™è¯¯" aria-hidden="true">#</a> æ³¨å…¥HTTPå»¶è¿Ÿé”™è¯¯</h4><p>è¦æµ‹è¯• Bookinfo åº”ç”¨ç¨‹åºå¾®æœåŠ¡çš„å¼¹æ€§ï¼Œè¯·åœ¨user<code>reviews:v2</code>å’Œå¾®æœåŠ¡ä¹‹é—´æ³¨å…¥ 7s å»¶è¿Ÿã€‚æ­¤æµ‹è¯•å°†å‘ç°ä¸€ä¸ªæœ‰æ„å¼•å…¥ Bookinfo åº”ç”¨ç¨‹åºçš„é”™è¯¯ã€‚<code>ratings jason</code></p><p>è¯·æ³¨æ„ï¼Œè¯¥<code>reviews:v2</code>æœåŠ¡å¯¹æœåŠ¡çš„è°ƒç”¨æœ‰ 10 ç§’çš„ç¡¬ç¼–ç è¿æ¥è¶…æ—¶<code>ratings</code>ã€‚å³ä½¿æ‚¨å¼•å…¥äº† 7 ç§’å»¶è¿Ÿï¼Œæ‚¨ä»ç„¶å¸Œæœ›ç«¯åˆ°ç«¯æµç¨‹ç»§ç»­è¿›è¡Œè€Œä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚</p><ol><li>åˆ›å»ºæ•…éšœæ³¨å…¥è§„åˆ™ä»¥å»¶è¿Ÿæ¥è‡ªæµ‹è¯•ç”¨æˆ·çš„æµé‡ <code>jason</code>ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ç¡®è®¤è§„åˆ™å·²åˆ›å»ºï¼š <ul><li><code>åˆ›å»ºè§„åˆ™é€šè¿‡jasonç”¨æˆ·ç™»å½•</code></li><li><code>åœ¨å¾®æœåŠ¡ä¹‹é—´æ³¨å…¥7sçš„å»¶è¿Ÿ</code></li></ul></li></ol><blockquote><p><code>å‚æ•°è¯¦è§£ï¼š</code></p><p><strong>fault:</strong> # è¦åº”ç”¨äºå®¢æˆ·ç«¯HTTPæµé‡çš„æ•…éšœæ³¨å…¥ç­–ç•¥ã€‚ <strong>delay:</strong> # å»¶è¿Ÿ <strong>percentage:</strong> # ç™¾åˆ†ç‡ <strong>value: 100.0</strong> # é”®å€¼ä¸ºç™¾åˆ†ä¹‹ä¸€ç™¾ <strong>fixedDelay: 7s</strong> # å›ºå®šæ—¶é—´ä¸º7s</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-delay.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>					
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>				
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>			
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 7s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç­‰å¾…å‡ ç§’é’Ÿï¼Œè®©æ–°è§„åˆ™ä¼ æ’­åˆ°æ‰€æœ‰ podã€‚</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327994.png" alt="image-20220316153536186" loading="lazy"></p><h4 id="æµ‹è¯•å»¶è¿Ÿé…ç½®" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•å»¶è¿Ÿé…ç½®" aria-hidden="true">#</a> æµ‹è¯•å»¶è¿Ÿé…ç½®</h4><ol><li><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web åº”ç”¨ç¨‹åºã€‚<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>åœ¨<code>/productpage</code>ç½‘é¡µä¸Šï¼Œä»¥ user èº«ä»½ç™»å½•<code>jason</code>ã€‚</p><p>æ‚¨å¸Œæœ› Bookinfo ä¸»é¡µåœ¨å¤§çº¦ 7 ç§’å†…åŠ è½½è€Œä¸ä¼šå‡ºç°é”™è¯¯ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šReviews éƒ¨åˆ†æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼š</p><p><code>Sorry, product reviews are currently unavailable for this book.</code></p></li><li><p>æŸ¥çœ‹ç½‘é¡µå“åº”æ—¶é—´ï¼š</p><ol><li>åœ¨ Web æµè§ˆå™¨ä¸­æ‰“å¼€<em>å¼€å‘è€…å·¥å…·</em>èœå•ã€‚</li><li>æ‰“å¼€ç½‘ç»œé€‰é¡¹å¡</li><li>é‡æ–°åŠ è½½<code>/productpage</code>ç½‘é¡µã€‚æ‚¨å°†çœ‹åˆ°é¡µé¢å®é™…åŠ è½½å¤§çº¦éœ€è¦ 6 ç§’ã€‚</li></ol></li></ol><h4 id="ä¿®å¤é”™è¯¯" tabindex="-1"><a class="header-anchor" href="#ä¿®å¤é”™è¯¯" aria-hidden="true">#</a> ä¿®å¤é”™è¯¯</h4><p>æ‚¨é€šå¸¸ä¼šé€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³é—®é¢˜ï¼š</p><ol><li>å¢åŠ æœåŠ¡è¶…æ—¶æˆ–å‡å°‘<code>productpage</code>æœåŠ¡è¶…æ—¶<code>reviews reviews ratings</code></li><li>åœæ­¢å’Œé‡å¯å›ºå®šçš„å¾®æœåŠ¡</li><li>ç¡®è®¤<code>/productpage</code>ç½‘é¡µè¿”å›å…¶å“åº”æ²¡æœ‰ä»»ä½•é”™è¯¯ã€‚</li></ol><p>ä½†æ˜¯ï¼Œæ‚¨å·²ç»åœ¨<code>reviews</code>æœåŠ¡çš„ v3 ä¸­è¿è¡Œäº†ä¸€ä¸ªä¿®å¤ç¨‹åºã€‚è¯¥<code>reviews:v3</code>æœåŠ¡å°†è¶…æ—¶æ—¶é—´ä» 10s å‡å°‘<code>reviews</code>åˆ°2.5sï¼Œä»¥ä¾¿ä¸ä¸‹æ¸¸è¯·æ±‚<code>ratings</code>çš„è¶…æ—¶æ—¶é—´å…¼å®¹ï¼ˆå°äºï¼‰ <code>productpage</code>ã€‚</p><p>å¦‚æœæ‚¨æŒ‰ç…§<a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/" target="_blank" rel="noopener noreferrer">æµé‡è½¬ç§»<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>reviews:v3</code>ä»»åŠ¡ä¸­çš„æè¿° å°†æ‰€æœ‰æµé‡è¿ç§»åˆ°ï¼Œæ‚¨å¯ä»¥å°è¯•å°†å»¶è¿Ÿè§„åˆ™æ›´æ”¹ä¸ºå°äº 2.5s çš„ä»»æ„é‡ï¼Œä¾‹å¦‚ 2sï¼Œå¹¶ç¡®è®¤ç«¯åˆ°ç«¯æµç¨‹ç»§ç»­æ²¡æœ‰ä»»ä½•é”™è¯¯ã€‚</p><h4 id="æ³¨å…¥httpä¸­æ­¢é”™è¯¯" tabindex="-1"><a class="header-anchor" href="#æ³¨å…¥httpä¸­æ­¢é”™è¯¯" aria-hidden="true">#</a> æ³¨å…¥HTTPä¸­æ­¢é”™è¯¯</h4><p>æµ‹è¯•å¾®æœåŠ¡å¼¹æ€§çš„å¦ä¸€ç§æ–¹æ³•æ˜¯å¼•å…¥ HTTP ä¸­æ­¢æ•…éšœã€‚<code>ratings</code>åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†ä¸ºæµ‹è¯•ç”¨æˆ·çš„å¾®æœåŠ¡å¼•å…¥ HTTP ä¸­æ­¢<code>jason</code>ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¸Œæœ›é¡µé¢ç«‹å³åŠ è½½å¹¶æ˜¾ç¤º<code>Ratings service is currently unavailable</code>æ¶ˆæ¯ã€‚</p><ol><li>åˆ›å»ºä¸€ä¸ªæ•…éšœæ³¨å…¥è§„åˆ™ï¼Œä¸ºç”¨æˆ·å‘é€ HTTP ä¸­æ­¢<code>jason</code>ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ç¡®è®¤è§„åˆ™å·²åˆ›å»ºï¼š <ul><li><code>åˆ›å»ºè§„åˆ™é€šè¿‡jasonç”¨æˆ·æµé‡</code></li><li><code>åœ¨å¾®æœåŠ¡ä¹‹é—´ä¸­æ­¢jasonç”¨æˆ·ï¼Œhttpstatusæ˜¯500çŠ¶æ€ï¼Œç™¾åˆ†ç‡è®¾ç½®ä¸º100</code></li></ul></li></ol><blockquote><p><code>å‚æ•°è¯¦è§£ï¼š</code></p><p><strong>fault:</strong> # è¦åº”ç”¨äºå®¢æˆ·ç«¯HTTPæµé‡çš„æ•…éšœæ³¨å…¥ç­–ç•¥ã€‚ <strong>abort:</strong> # ä¸­æ­¢ç­–ç•¥ <strong>percentage:</strong> # ç™¾åˆ†ç‡ <strong>value: 100.0</strong> # é”®å€¼ä¸ºç™¾åˆ†ä¹‹ä¸€ç™¾ <strong>httpStatus: 500</strong> # httpstatusè®¾ç½®ä¸º500æŠ¥é”™</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-abort.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æµ‹è¯•ä¸­æ­¢é…ç½®" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•ä¸­æ­¢é…ç½®" aria-hidden="true">#</a> æµ‹è¯•ä¸­æ­¢é…ç½®</h4><ol><li><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web åº”ç”¨ç¨‹åºã€‚<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>åœ¨ ä¸Š<code>/productpage</code>ï¼Œä»¥ç”¨æˆ·èº«ä»½ç™»å½•<code>jason</code>ã€‚</p><p>å¦‚æœè§„åˆ™æˆåŠŸä¼ æ’­åˆ°æ‰€æœ‰ podï¼Œé¡µé¢ä¼šç«‹å³åŠ è½½å¹¶æ˜¾ç¤º<code>Ratings service is currently unavailable</code>æ¶ˆæ¯ã€‚</p></li><li><p>å¦‚æœæ‚¨ä»ç”¨æˆ·æ³¨é”€<code>jason</code>æˆ–åœ¨åŒ¿åçª—å£ï¼ˆæˆ–å…¶ä»–æµè§ˆå™¨ï¼‰ä¸­æ‰“å¼€ Bookinfo åº”ç”¨ç¨‹åºï¼Œæ‚¨ å°†<code>/productpage</code>çœ‹åˆ°é™¤äº†. å› æ­¤ï¼Œæ‚¨ä¸ä¼šçœ‹åˆ°ä»»ä½•é”™è¯¯æ¶ˆæ¯ã€‚<code>reviews:v1 ratings jason</code></p></li></ol><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327813.png" alt="image-20220316155324788" loading="lazy"></p><h4 id="æ¸…ç†-1" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-1" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤åº”ç”¨ç¨‹åºè·¯ç”±è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="æµé‡è½¬ç§»" tabindex="-1"><a class="header-anchor" href="#æµé‡è½¬ç§»" aria-hidden="true">#</a> æµé‡è½¬ç§»</h2><h4 id="ä»€ä¹ˆæ˜¯æµé‡è½¬ç§»" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯æµé‡è½¬ç§»" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯æµé‡è½¬ç§»ï¼Ÿ</h4><p>æ­¤ä»»åŠ¡å‘æ‚¨å±•ç¤ºå¦‚ä½•å°†æµé‡ä»ä¸€ä¸ªå¾®æœåŠ¡ç‰ˆæœ¬è½¬ç§»åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å°†æµé‡ä»æ—§ç‰ˆæœ¬çš„å¾®æœåŠ¡é€æ¸è¿ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚åœ¨ Istio ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½®ä¸€ç³»åˆ—è·¯ç”±è§„åˆ™æ¥å®ç°è¿™ä¸€ç›®æ ‡ï¼Œè¿™äº›è§„åˆ™å°†ä¸€å®šæ¯”ä¾‹çš„æµé‡ä»ä¸€ä¸ªç›®çš„åœ°é‡å®šå‘åˆ°å¦ä¸€ä¸ªç›®çš„åœ°ã€‚</p><p>åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†ä½¿ç”¨å°† 50% çš„æµé‡å‘é€åˆ°<code>reviews:v1</code>å’Œ 50% åˆ°<code>reviews:v3</code>ã€‚ç„¶åï¼Œæ‚¨å°†é€šè¿‡å°† 100% çš„æµé‡å‘é€åˆ° æ¥å®Œæˆè¿ç§»<code>reviews:v3</code>ã€‚</p><h4 id="ç¯å¢ƒå‡†å¤‡-2" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-2" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>éƒ¨ç½²<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç›®æ ‡è§„åˆ™ã€‚</li><li>äº†è§£äº†æµé‡ç®¡ç†çš„åŸºç¡€æ¦‚å¿µï¼Œä»¥åŠä¸“ä¸šè¯­æœ¯ã€‚</li></ul><blockquote><p>é¦–å…ˆï¼Œè¿è¡Œæ­¤å‘½ä»¤å°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°<code>v1</code>æ¯ä¸ªå¾®æœåŠ¡çš„ç‰ˆæœ¬ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="åº”ç”¨åŸºäºæƒé‡çš„è·¯ç”±" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åŸºäºæƒé‡çš„è·¯ç”±" aria-hidden="true">#</a> åº”ç”¨åŸºäºæƒé‡çš„è·¯ç”±</h4><ol><li><code>reviews:v1</code>ä½¿ç”¨<code>reviews:v3</code>ä»¥ä¸‹å‘½ä»¤ä¼ è¾“ 50% çš„æµé‡ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ç¡®è®¤è§„åˆ™å·²è¢«æ›¿æ¢ï¼š <ul><li><code>åˆ›å»ºv1ç‰ˆæœ¬çš„æƒé‡ä¸º50</code></li><li><code>åˆ›å»ºv3ç‰ˆæœ¬çš„æƒé‡ä¸º50</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-50-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­åˆ·æ–°<code>/productpage</code>ï¼Œæ‚¨ç°åœ¨å¤§çº¦æœ‰ 50% çš„æ—¶é—´ä¼šçœ‹åˆ°<code>çº¢è‰²</code>çš„æ˜Ÿçº§ã€‚è¿™æ˜¯å› ä¸º<code>v3</code>ç‰ˆæœ¬<code>reviews</code>è®¿é—®äº†æ˜Ÿçº§æœåŠ¡ï¼Œè€Œ<code>v1</code>ç‰ˆæœ¬æ²¡æœ‰ã€‚</li></ol><blockquote><p>æ³¨æ„ï¼š</p><p>ä½¿ç”¨å½“å‰çš„ Envoy sidecar å®ç°ï¼Œæ‚¨å¯èƒ½éœ€è¦ <code>/productpage</code>å¤šæ¬¡åˆ·æ–°ï¼ˆå¯èƒ½ 15 æ¬¡æˆ–æ›´å¤šï¼‰æ‰èƒ½çœ‹åˆ°æ­£ç¡®çš„åˆ†å¸ƒã€‚æ‚¨å¯ä»¥ä¿®æ”¹è§„åˆ™ä»¥å°† 90% çš„æµé‡è·¯ç”±åˆ°<code>v3</code>æ›´é¢‘ç¹åœ°çœ‹åˆ°çº¢æ˜Ÿã€‚</p></blockquote><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327265.png" alt="image-20220316160723199" loading="lazy"></p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327027.png" alt="image-20220316160736887" loading="lazy"></p><ol start="4"><li>å‡è®¾æ‚¨ç¡®å®š<code>reviews:v3</code>å¾®æœåŠ¡æ˜¯ç¨³å®šçš„ï¼Œæ‚¨å¯ä»¥<code>reviews:v3</code>é€šè¿‡åº”ç”¨æ­¤è™šæ‹ŸæœåŠ¡å°† 100% çš„æµé‡è·¯ç”±åˆ°ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œå½“æ‚¨åˆ·æ–°æ—¶ï¼Œ<code>/productpage</code>æ‚¨æ€»æ˜¯ä¼šçœ‹åˆ°æ¯æ¡è¯„è®ºå¸¦æœ‰<code>çº¢è‰²</code>æ˜Ÿçº§çš„ä¹¦è¯„ã€‚</p><h4 id="æ¸…ç†-2" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-2" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤åº”ç”¨ç¨‹åºè·¯ç”±è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="tcp-æµé‡è½¬ç§»" tabindex="-1"><a class="header-anchor" href="#tcp-æµé‡è½¬ç§»" aria-hidden="true">#</a> TCP æµé‡è½¬ç§»</h2><h4 id="ä»€ä¹ˆæ˜¯tcpæµé‡è½¬ç§»" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯tcpæµé‡è½¬ç§»" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯TCPæµé‡è½¬ç§»ï¼Ÿ</h4><p>å°† TCP æµé‡ä»ä¸€ä¸ªå¾®æœåŠ¡ç‰ˆæœ¬è½¬ç§»åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å°† TCP æµé‡ä»æ—§ç‰ˆæœ¬çš„å¾®æœåŠ¡é€æ¸è¿ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚åœ¨ Istio ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½®ä¸€ç³»åˆ—è·¯ç”±è§„åˆ™æ¥å®ç°è¿™ä¸€ç›®æ ‡ï¼Œè¿™äº›è§„åˆ™å°†ä¸€å®šç™¾åˆ†æ¯”çš„ TCP æµé‡ä»ä¸€ä¸ªç›®çš„åœ°é‡å®šå‘åˆ°å¦ä¸€ä¸ªç›®çš„åœ°ã€‚åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°† 100% çš„ TCP æµé‡å‘é€åˆ°<code>tcp-echo:v1</code>. ç„¶åï¼Œæ‚¨å°†<code>tcp-echo:v2</code>ä½¿ç”¨ Istio çš„åŠ æƒè·¯ç”±åŠŸèƒ½è·¯ç”± 20% çš„ TCP æµé‡ã€‚</p><h4 id="åŸºç¡€ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€ç¯å¢ƒ" aria-hidden="true">#</a> åŸºç¡€ç¯å¢ƒ</h4><blockquote><ol><li>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯• TCP æµé‡è½¬ç§»çš„å‘½åç©ºé—´å¹¶å°†å…¶æ ‡è®°ä¸ºå¯ç”¨è‡ªåŠ¨è¾¹è½¦æ³¨å…¥ã€‚</li><li>éƒ¨ç½²<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºä»¥ç”¨ä½œå‘é€è¯·æ±‚çš„æµ‹è¯•æºã€‚</li><li>éƒ¨ç½²å¾®æœåŠ¡çš„<code>v1</code>å’Œ<code>v2</code>ç‰ˆæœ¬<code>tcp-echo</code>ã€‚</li><li>æŒ‰ç…§ <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports" target="_blank" rel="noopener noreferrer">ç¡®å®šå…¥å£ IP å’Œç«¯å£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>TCP_INGRESS_PORT</code>ä¸­ çš„è¯´æ˜å®šä¹‰<code>INGRESS_HOST</code>ç¯å¢ƒå˜é‡ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create namespace istio-io-tcp-traffic-shifting
$ kubectl label namespace istio-io-tcp-traffic-shifting istio-injection<span class="token operator">=</span>enabled
$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl apply <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="åº”ç”¨åŸºäºæƒé‡çš„tcpè·¯ç”±" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åŸºäºæƒé‡çš„tcpè·¯ç”±" aria-hidden="true">#</a> åº”ç”¨åŸºäºæƒé‡çš„TCPè·¯ç”±</h4><ol><li>å°†æ‰€æœ‰ TCP æµé‡è·¯ç”±åˆ°å¾®æœåŠ¡çš„<code>v1</code>ç‰ˆæœ¬<code>tcp-echo</code>ã€‚</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml -n istio-io-tcp-traffic-shifting</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># cat tcp-echo/tcp-echo-all-v1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">31400</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>destination
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>				<span class="token comment"># è¿™é‡Œä¿®æ”¹æˆä½¿ç”¨ç«¯å£çš„æ–¹å¼</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>		 <span class="token comment"># ç«¯å£å·æ˜¯9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1            <span class="token comment"># ç‰ˆæœ¬ä½¿ç”¨V1ç‰ˆæœ¬</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><code>tcp-echo</code>é€šè¿‡ä»å®¢æˆ·ç«¯å‘é€ä¸€äº› TCP æµé‡æ¥ç¡®è®¤æœåŠ¡å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œ<code>sleep</code>ã€‚</li></ol><blockquote><p>ä¸‹é¢çš„ <code>$INGRESS_HOST</code> å˜é‡æ˜¯ ingress çš„å¤–éƒ¨ IP åœ°å€ï¼Œ<code>$TCP_INGRESS_PORT</code>æ˜¯ingressçš„ç«¯å£</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span>worker-node-address
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 samples<span class="token punctuation">]</span><span class="token comment"># for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:24:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:07 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:10 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:12 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:15 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:17 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:19 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨åº”è¯¥æ³¨æ„åˆ°æ‰€æœ‰æ—¶é—´æˆ³çš„å‰ç¼€éƒ½æ˜¯<em>one</em>ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰æµé‡éƒ½è¢«è·¯ç”±åˆ°æœåŠ¡çš„<code>v1</code>ç‰ˆæœ¬<code>tcp-echo</code>ã€‚</p><ol start="3"><li><code>tcp-echo:v1</code>ä½¿ç”¨<code>tcp-echo:v2</code>ä»¥ä¸‹å‘½ä»¤ä¼ è¾“ 20% çš„æµé‡ï¼š</li></ol><blockquote><p>é€šè¿‡ä¿®æ”¹<code>weightçš„å€¼</code>æ¥ç¡®å®šæµé‡çš„åˆ†å¸ƒæ§åˆ¶ã€‚</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># cat samples/tcp-echo/tcp-echo-20-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><p>å‘å¾®æœåŠ¡å‘é€æ›´å¤š TCP æµé‡<code>tcp-echo</code>ã€‚</p><p>æ‚¨ç°åœ¨åº”è¯¥æ³¨æ„åˆ°å¤§çº¦ 20% çš„æ—¶é—´æˆ³å…·æœ‰å‰ç¼€<em>2</em>ï¼Œè¿™æ„å‘³ç€ 80% çš„ TCP æµé‡è¢«è·¯ç”±åˆ°æœåŠ¡<code>v1</code>ç‰ˆæœ¬<code>tcp-echo</code>ï¼Œè€Œ 20% è¢«è·¯ç”±åˆ°<code>v2</code>.</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment">#  for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:45 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:47 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:50 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:52 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:55 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:07 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†-3" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-3" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤<code>sleep</code>ç¤ºä¾‹ã€<code>tcp-echo</code>åº”ç”¨ç¨‹åºå’Œè·¯ç”±è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-all-v1.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete namespace istio-io-tcp-traffic-shifting
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è¯·æ±‚è¶…æ—¶" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚è¶…æ—¶" aria-hidden="true">#</a> è¯·æ±‚è¶…æ—¶</h2><h4 id="ç¯å¢ƒå‡†å¤‡-3" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-3" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>éƒ¨ç½²<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç›®æ ‡è§„åˆ™ã€‚</li><li>äº†è§£äº†æµé‡ç®¡ç†çš„åŸºç¡€æ¦‚å¿µï¼Œä»¥åŠä¸“ä¸šè¯­æœ¯ã€‚</li></ul><blockquote><p>é¦–å…ˆï¼Œè¿è¡Œæ­¤å‘½ä»¤å°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°<code>v1</code>æ¯ä¸ªå¾®æœåŠ¡çš„ç‰ˆæœ¬ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><h4 id="è¯·æ±‚è¶…æ—¶-1" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚è¶…æ—¶-1" aria-hidden="true">#</a> è¯·æ±‚è¶…æ—¶</h4><p>å¯ä»¥ä½¿ç”¨<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute" target="_blank" rel="noopener noreferrer">è·¯ç”±è§„åˆ™çš„<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><em>timeout</em>å­—æ®µæŒ‡å®š HTTP è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚è¶…æ—¶è¢«ç¦ç”¨ï¼Œä½†åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†æœåŠ¡è¶…æ—¶è¦†ç›–ä¸º 1 ç§’ã€‚ä½†æ˜¯ï¼Œè¦æŸ¥çœ‹å…¶æ•ˆæœï¼Œæ‚¨è¿˜å¯ä»¥åœ¨è°ƒç”¨æœåŠ¡æ—¶äººä¸ºåœ°å¼•å…¥ 2 ç§’å»¶è¿Ÿã€‚</p><ol><li>å°†è¯·æ±‚è·¯ç”±åˆ°<code>reviews</code>æœåŠ¡çš„ v2ï¼Œå³è°ƒç”¨<code>ratings</code>æœåŠ¡çš„ç‰ˆæœ¬ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å¯¹æœåŠ¡çš„è°ƒç”¨æ·»åŠ  2 ç§’å»¶è¿Ÿ<code>ratings</code>ï¼š <ul><li><code>ä½¿ç”¨httpè§„åˆ™é…ç½®ç›®çš„åœ°ç‰ˆæœ¬ä¸ºv1ä¸»æœºæ˜¯ratings</code></li><li><code>é…ç½®ç™¾åˆ†æ¯”ä¸º100çš„2ç§’å›ºå®šæ—¶é—´å»¶è¿Ÿ</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 2s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>http://$GATEWAY_URL/productpage</code>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Bookinfo URL ã€‚</li></ol><p>æ‚¨åº”è¯¥ä¼šçœ‹åˆ° Bookinfo åº”ç”¨ç¨‹åºæ­£å¸¸å·¥ä½œï¼ˆæ˜¾ç¤ºè¯„çº§æ˜Ÿï¼‰ï¼Œä½†æ˜¯æ¯å½“æ‚¨åˆ·æ–°é¡µé¢æ—¶éƒ½ä¼šæœ‰ 2 ç§’çš„å»¶è¿Ÿã€‚</p><ol start="4"><li>ç°åœ¨ä¸ºå¯¹æœåŠ¡çš„è°ƒç”¨æ·»åŠ åŠç§’è¯·æ±‚è¶…æ—¶<code>reviews</code>ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 0.5s
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>åˆ·æ–° Bookinfo ç½‘é¡µã€‚</li></ol><p>æ‚¨ç°åœ¨åº”è¯¥çœ‹åˆ°å®ƒåœ¨å¤§çº¦ 1 ç§’å†…è¿”å›ï¼Œè€Œä¸æ˜¯ 2 ç§’ï¼Œå¹¶ä¸”è¯„è®ºä¸å¯ç”¨ã€‚</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062327037.png" alt="image-20220318111010285" loading="lazy"></p><blockquote><p>æ³¨æ„ï¼š</p><p>å“åº”éœ€è¦1ç§’çš„åŸå› ï¼Œå³ä½¿è¶…æ—¶é…ç½®ä¸ºåŠç§’ï¼Œä¹Ÿæ˜¯å› ä¸ºæœåŠ¡ä¸­æœ‰ç¡¬ç¼–ç çš„é‡è¯•ï¼Œæ‰€ä»¥å®ƒåœ¨è¿”å›ä¹‹å‰è°ƒç”¨äº†ä¸¤æ¬¡<code>productpage</code>è¶…æ—¶æœåŠ¡ã€‚<code>reviews</code></p></blockquote><h4 id="æ¸…ç†-4" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-4" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤åº”ç”¨ç¨‹åºè·¯ç”±è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="ç†”æ–­-1" tabindex="-1"><a class="header-anchor" href="#ç†”æ–­-1" aria-hidden="true">#</a> ç†”æ–­</h2><h4 id="ç†”æ–­çš„æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#ç†”æ–­çš„æ–¹å¼" aria-hidden="true">#</a> ç†”æ–­çš„æ–¹å¼</h4><p>æ­¤ä»»åŠ¡å‘æ‚¨å±•ç¤ºå¦‚ä½•ä¸ºè¿æ¥ã€è¯·æ±‚å’Œå¼‚å¸¸å€¼æ£€æµ‹é…ç½®æ–­è·¯ã€‚</p><p>æ–­è·¯æ˜¯åˆ›å»ºå¼¹æ€§å¾®æœåŠ¡åº”ç”¨ç¨‹åºçš„é‡è¦æ¨¡å¼ã€‚æ–­è·¯å…è®¸æ‚¨ç¼–å†™é™åˆ¶æ•…éšœã€å»¶è¿Ÿå³°å€¼å’Œç½‘ç»œç‰¹æ€§çš„å…¶ä»–ä¸è‰¯å½±å“çš„å½±å“çš„åº”ç”¨ç¨‹åºã€‚</p><p>åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†é…ç½®æ–­è·¯å™¨è§„åˆ™ï¼Œç„¶åé€šè¿‡æœ‰æ„â€œè·³é—¸â€æ–­è·¯å™¨æ¥æµ‹è¯•é…ç½®ã€‚</p><h4 id="ç¯å¢ƒå‡†å¤‡-4" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-4" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><p>å¯åŠ¨<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ã€‚</p><p>å¦‚æœæ‚¨å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œè¯·éƒ¨ç½²è¯¥<code>httpbin</code>æœåŠ¡ï¼š</p><p>å¦åˆ™ï¼Œæ‚¨å¿…é¡»åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºä¹‹å‰æ‰‹åŠ¨æ³¨å…¥ sidecar <code>httpbin</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é…ç½®æ–­è·¯å™¨" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ–­è·¯å™¨" aria-hidden="true">#</a> é…ç½®æ–­è·¯å™¨</h4><ol><li>åˆ›å»º<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" target="_blank" rel="noopener noreferrer">ç›®æ ‡è§„åˆ™<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä»¥åœ¨è°ƒç”¨æœåŠ¡æ—¶åº”ç”¨æ–­è·¯è®¾ç½®<code>httpbin</code>ï¼š <ul><li><code>é…ç½®äº¤é€šæ”¿ç­–çš„è¿æ¥æ± å’Œå¼‚å¸¸æ£€æµ‹</code></li><li><code>é…ç½®è¿æ¥æ± çš„tcpè§„åˆ™åˆ°ç›®æ ‡ä¸»æœºçš„æœ€å¤§HTTP1/TCPè¿æ¥æ•°ä¸º 1</code></li><li><code>é…ç½®è¿æ¥æ± çš„httpè§„åˆ™å¯¹ç›®æ ‡çš„æœ€å¤§æŒ‚èµ·HTTPè¯·æ±‚æ•°ä¸º 1 </code></li><li><code>é…ç½®è¿æ¥æ± çš„httpè§„åˆ™æ¯ä¸ªåç«¯è¿æ¥çš„æœ€å¤§è¯·æ±‚æ•°ä¸º 1</code></li><li><code>é…ç½®å¼‚å¸¸æ£€æµ‹ä»è¿æ¥æ± ä¸­å¼¹å‡ºä¸»æœºä¹‹å‰çš„5xxé”™è¯¯æ•°ä¸º 1</code></li><li><code>é…ç½®å¼‚å¸¸æ£€æµ‹å¼¹å°„æ‰«æåˆ†æä¹‹é—´çš„æ—¶é—´é—´éš”ä¸º 1ç§’</code></li><li><code>é…ç½®å¼‚å¸¸æ£€æµ‹æœ€çŸ­å¼¹å°„æ—¶é—´ä¸º 3åˆ†é’Ÿ</code></li><li><code>é…ç½®å¼‚å¸¸æ£€æµ‹æœ€å¤§å¼¹å°„ç™¾åˆ†æ¯”ä¸º 100</code></li></ul></li></ol><blockquote><p>å¦‚æœæ‚¨å®‰è£…/é…ç½®äº†å¯ç”¨åŒå‘ TLS èº«ä»½éªŒè¯çš„ Istioï¼Œåˆ™å¿…é¡»åœ¨åº”ç”¨ä¹‹å‰æ·»åŠ  TLS æµé‡<code>mode: ISTIO_MUTUAL</code>ç­–ç•¥<code>DestinationRule</code>ã€‚å¦åˆ™è¯·æ±‚å°†äº§ç”Ÿ 503 é”™è¯¯ï¼Œå¦‚æ­¤<a href="https://istio.io/latest/docs/ops/common-problems/network-issues/#503-errors-after-setting-destination-rule" target="_blank" rel="noopener noreferrer">å¤„<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ‰€è¿°ã€‚</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>éªŒè¯ç›®æ ‡è§„åˆ™æ˜¯å¦å·²æ­£ç¡®åˆ›å»ºï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get destinationrules</span>
NAME                   HOST          AGE
details                details       4h41m
httpbin                httpbin       64m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ·»åŠ å®¢æˆ·ç«¯" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ å®¢æˆ·ç«¯" aria-hidden="true">#</a> æ·»åŠ å®¢æˆ·ç«¯</h4><p>åˆ›å»ºå®¢æˆ·ç«¯ä»¥å°†æµé‡å‘é€åˆ°<code>httpbin</code>æœåŠ¡ã€‚<a href="https://github.com/istio/fortio" target="_blank" rel="noopener noreferrer">è¯¥å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªåä¸ºfortio<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>çš„ç®€å•è´Ÿè½½æµ‹è¯•å®¢æˆ·ç«¯ã€‚Fortio å…è®¸æ‚¨æ§åˆ¶ä¼ å‡º HTTP è°ƒç”¨çš„è¿æ¥æ•°ã€å¹¶å‘æ€§å’Œå»¶è¿Ÿã€‚æ‚¨å°†ä½¿ç”¨æ­¤å®¢æˆ·ç«¯â€œè·³é—¸â€æ‚¨åœ¨<code>DestinationRule</code>.</p><ol><li>ä½¿ç”¨ Istio sidecar ä»£ç†æ³¨å…¥å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿ç½‘ç»œäº¤äº’ç”± Istio ç®¡ç†ã€‚å¦‚æœæ‚¨å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œè¯·éƒ¨ç½²è¯¥<code>fortio</code>æœåŠ¡ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦åˆ™ï¼Œæ‚¨å¿…é¡»åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºä¹‹å‰æ‰‹åŠ¨æ³¨å…¥ sidecar <code>fortio</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ç™»å½•å®¢æˆ·ç«¯podï¼Œä½¿ç”¨fortioå·¥å…·è°ƒç”¨<code>httpbin</code>. ä¼ å…¥<code>curl</code>è¡¨ç¤ºä½ åªæƒ³æ‰“ä¸€ä¸ªç”µè¯ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FORTIO_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>fortio <span class="token parameter variable">-o</span> <span class="token string">&#39;jsonpath={.items[0].metadata.name}&#39;</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$FORTIO_POD</span>&quot;</span> <span class="token parameter variable">-c</span> fortio -- /usr/bin/fortio <span class="token function">curl</span> <span class="token parameter variable">-quiet</span> http://httpbin:8000/get
HTTP/1.1 <span class="token number">200</span> OK
server: envoy
date: Tue, <span class="token number">25</span> Feb <span class="token number">2020</span> <span class="token number">20</span>:25:52 GMT
content-type: application/json
content-length: <span class="token number">586</span>
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
x-envoy-upstream-service-time: <span class="token number">36</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;args&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;fortio.org/fortio-1.3.1&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;8fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;071d7f06bc94943c&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;86a929a0e76cda378fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=68bbaedefe01ef4cb99e17358ff63e92d04a4ce831a35ab9a31d3c8e06adb038;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;origin&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;127.0.0.1&quot;</span>,
  <span class="token string">&quot;url&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://httpbin:8000/get&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿æ–­è·¯å™¨è·³é—¸" tabindex="-1"><a class="header-anchor" href="#ä½¿æ–­è·¯å™¨è·³é—¸" aria-hidden="true">#</a> ä½¿æ–­è·¯å™¨è·³é—¸</h4><p>åœ¨<code>DestinationRule</code>è®¾ç½®ä¸­ï¼Œæ‚¨æŒ‡å®šäº†<code>maxConnections: 1</code>å’Œ <code>http1MaxPendingRequests: 1</code>ã€‚è¿™äº›è§„åˆ™è¡¨æ˜ï¼Œå¦‚æœæ‚¨è¶…è¿‡ä¸€ä¸ªè¿æ¥å¹¶åŒæ—¶è¯·æ±‚ï¼Œåˆ™å½“ <code>istio-proxy</code>æ‰“å¼€æ›´å¤šè¯·æ±‚å’Œè¿æ¥çš„ç”µè·¯æ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€äº›å¤±è´¥ã€‚</p><ol><li>ä½¿ç”¨ä¸¤ä¸ªå¹¶å‘è¿æ¥ ( <code>-c 2</code>) è°ƒç”¨æœåŠ¡å¹¶å‘é€ 20 ä¸ªè¯·æ±‚ ( <code>-n 20</code>)ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:42:53 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">90</span>.508623ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">220.97</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0081634006</span> +/- <span class="token number">0.006652</span> min <span class="token number">0.000929244</span> max <span class="token number">0.027135759</span> <span class="token function">sum</span> <span class="token number">0.163268012</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000929244</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000964622</span> , <span class="token number">5.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">25.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">30.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">40.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.006</span> <span class="token operator">&lt;=</span> <span class="token number">0.007</span> , <span class="token number">0.0065</span> , <span class="token number">50.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.007</span> <span class="token operator">&lt;=</span> <span class="token number">0.008</span> , <span class="token number">0.0075</span> , <span class="token number">60.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">65.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">80.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.014</span> <span class="token operator">&lt;=</span> <span class="token number">0.016</span> , <span class="token number">0.015</span> , <span class="token number">85.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.018</span> <span class="token operator">&lt;=</span> <span class="token number">0.02</span> , <span class="token number">0.019</span> , <span class="token number">95.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.025</span> <span class="token operator">&lt;=</span> <span class="token number">0.0271358</span> , <span class="token number">0.0260679</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.007</span>
<span class="token comment"># target 75% 0.00966667</span>
<span class="token comment"># target 90% 0.019</span>
<span class="token comment"># target 99% 0.0267086</span>
<span class="token comment"># target 99.9% 0.027093</span>
Sockets used: <span class="token number">8</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">2</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">14</span> <span class="token punctuation">(</span><span class="token number">70.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">6</span> <span class="token punctuation">(</span><span class="token number">30.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">161.15</span> +/- <span class="token number">105.5</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">3223</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">649.25</span> +/- <span class="token number">267.3</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">12985</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">8.163</span> ms avg, <span class="token number">221.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰è¶£çš„æ˜¯ï¼Œå‡ ä¹æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡äº†ï¼<code>istio-proxy</code> ç¡®å®ç•™æœ‰ä½™åœ°ã€‚</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 14 (70.0 %)
Code 503 : 6 (30.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å°†å¹¶å‘è¿æ¥æ•°å¢åŠ åˆ° 3ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 3 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:44:49 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">3</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">6</span> per thread + <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">32</span>.522699ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">614.96</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0029114787</span> +/- <span class="token number">0.003681</span> min <span class="token number">0.000447652</span> max <span class="token number">0.016532305</span> <span class="token function">sum</span> <span class="token number">0.058229575</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000447652</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000723826</span> , <span class="token number">30.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">60.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">70.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">90.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">95.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.016</span> <span class="token operator">&lt;=</span> <span class="token number">0.0165323</span> , <span class="token number">0.0162662</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.00166667</span>
<span class="token comment"># target 75% 0.00425</span>
<span class="token comment"># target 90% 0.005</span>
<span class="token comment"># target 99% 0.0164258</span>
<span class="token comment"># target 99.9% 0.0165217</span>
Sockets used: <span class="token number">16</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">3</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token number">25.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">75.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">57.55</span> +/- <span class="token number">99.68</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">1151</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">386.8</span> +/- <span class="token number">252.5</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">7736</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">2.911</span> ms avg, <span class="token number">615.0</span> qps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æ‚¨å¼€å§‹çœ‹åˆ°é¢„æœŸçš„æ–­è·¯è¡Œä¸ºã€‚åªæœ‰ 36.7% çš„è¯·æ±‚æˆåŠŸï¼Œå…¶ä½™çš„åˆ™è¢«ç†”æ–­æœºåˆ¶å›°ä½ï¼š</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Code 200 : 5 (25.0 %)
Code 503 : 15 (75.0 %)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>æŸ¥è¯¢<code>istio-proxy</code>ç»Ÿè®¡ä¿¡æ¯ä»¥æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼š</p><p>æ‚¨å¯ä»¥æŸ¥çœ‹<code>21</code>è¯¥<code>upstream_rq_pending_overflow</code>å€¼ï¼Œè¿™æ„å‘³ç€<code>21</code> åˆ°ç›®å‰ä¸ºæ­¢çš„è°ƒç”¨å·²è¢«æ ‡è®°ä¸ºæ–­è·¯ã€‚</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep pending</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.remaining_pending: <span class="token number">1</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_active: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: <span class="token number">40</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_total: <span class="token number">41</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†-5" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-5" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…³é—­<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æœåŠ¡å’Œå®¢æˆ·ç«¯ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin fortio-deploy
$ kubectl delete svc httpbin fortio
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="é•œåƒ" tabindex="-1"><a class="header-anchor" href="#é•œåƒ" aria-hidden="true">#</a> é•œåƒ</h2><h4 id="æµé‡é•œåƒ" tabindex="-1"><a class="header-anchor" href="#æµé‡é•œåƒ" aria-hidden="true">#</a> æµé‡é•œåƒ</h4><p>æ­¤ä»»åŠ¡æ¼”ç¤ºäº† Istio çš„æµé‡é•œåƒåŠŸèƒ½ã€‚</p><p>æµé‡é•œåƒï¼Œä¹Ÿç§°ä¸ºé˜´å½±ï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¦‚å¿µï¼Œå®ƒå…è®¸åŠŸèƒ½å›¢é˜Ÿä»¥å°½å¯èƒ½å°çš„é£é™©å°†æ›´æ”¹å¸¦å…¥ç”Ÿäº§ç¯å¢ƒã€‚é•œåƒå°†å®æ—¶æµé‡çš„å‰¯æœ¬å‘é€åˆ°é•œåƒæœåŠ¡ã€‚é•œåƒæµé‡å‘ç”Ÿåœ¨ä¸»æœåŠ¡çš„å…³é”®è¯·æ±‚è·¯å¾„çš„å¸¦å¤–ã€‚</p><p>åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†é¦–å…ˆå¼ºåˆ¶æ‰€æœ‰æµé‡æµå‘<code>v1</code>æµ‹è¯•æœåŠ¡ã€‚ç„¶åï¼Œæ‚¨å°†åº”ç”¨è§„åˆ™å°†ä¸€éƒ¨åˆ†æµé‡é•œåƒåˆ°<code>v2</code>.</p><h4 id="åŸºç¡€ç¯å¢ƒ-1" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€ç¯å¢ƒ-1" aria-hidden="true">#</a> åŸºç¡€ç¯å¢ƒ</h4><p>é¦–å…ˆéƒ¨ç½²ä¸¤ä¸ªå¯ç”¨äº†è®¿é—®æ—¥å¿—è®°å½•çš„<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbinæœåŠ¡ç‰ˆæœ¬ï¼š<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>httpbin-v1ï¼š</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/kennethreitz/httpbin
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;gunicorn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--access-logfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:80&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;httpbin:app&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin-v2ï¼š</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> istioctl kube-inject <span class="token parameter variable">-f</span> - <span class="token operator">|</span> kubectl create <span class="token parameter variable">-f</span> -</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
      version: v2
  template:
    metadata:
      labels:
        app: httpbin
        version: v2
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]
        ports:
        - containerPort: 80
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>httpbin Kubernetes æœåŠ¡ï¼š</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯åŠ¨<code>sleep</code>æœåŠ¡ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä½¿ç”¨å®ƒ<code>curl</code>æ¥æä¾›è´Ÿè½½ï¼š</p><p><strong>ç¡çœ æœåŠ¡ï¼š</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
        <span class="token key atrule">image</span><span class="token punctuation">:</span> curlimages/curl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sleep&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3650d&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºé»˜è®¤è·¯ç”±ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºé»˜è®¤è·¯ç”±ç­–ç•¥" aria-hidden="true">#</a> åˆ›å»ºé»˜è®¤è·¯ç”±ç­–ç•¥</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes ä¼šåœ¨<code>httpbin</code>æœåŠ¡çš„ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨å°†æ›´æ”¹è¯¥è¡Œä¸ºï¼Œä»¥ä¾¿æ‰€æœ‰æµé‡éƒ½è½¬åˆ°<code>v1</code>.</p><ol><li>åˆ›å»ºé»˜è®¤è·¯ç”±è§„åˆ™ä»¥å°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°<code>v1</code>æœåŠ¡ï¼Œç°åœ¨æ‰€æœ‰æµé‡éƒ½æµå‘<code>httpbin:v1</code>æœåŠ¡ã€‚ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å‘æœåŠ¡å‘é€ä¸€äº›æµé‡ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SLEEP_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SLEEP_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sS</span> http://httpbin:8000/headers
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.35.0&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3289ae7257c3f159&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b56eebd279a76f0b57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=20afebed6da091c850264cc751b8c9306abac02993f80bdb76282237422bd098;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æ£€æŸ¥pod<code>v1</code>çš„æ—¥å¿—<code>v2</code>ã€‚<code>httpbin</code>æ‚¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹çš„è®¿é—®æ—¥å¿—æ¡ç›®ï¼Œ<code>v1</code>å¹¶ä¸”æ²¡æœ‰<code>v2</code>ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V1_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v1 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V1_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V2_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v2 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V2_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å°†æµé‡é•œåƒåˆ°v2" tabindex="-1"><a class="header-anchor" href="#å°†æµé‡é•œåƒåˆ°v2" aria-hidden="true">#</a> å°†æµé‡é•œåƒåˆ°v2</h4><p><strong>æ›´æ”¹è·¯ç”±è§„åˆ™ä»¥å°†æµé‡é•œåƒåˆ° v2ï¼š</strong></p><p>æ­¤è·¯ç”±è§„åˆ™å°† 100% çš„æµé‡å‘é€åˆ°<code>v1</code>. æœ€åä¸€èŠ‚æŒ‡å®šæ‚¨å¸Œæœ›å°† 100% çš„ç›¸åŒæµé‡é•œåƒï¼ˆå³ï¼Œä¹Ÿå‘é€ï¼‰åˆ° <code>httpbin:v2</code>æœåŠ¡ã€‚</p><p>å½“æµé‡è¢«é•œåƒæ—¶ï¼Œè¯·æ±‚è¢«å‘é€åˆ°é•œåƒæœåŠ¡ï¼Œå…¶ Host/Authority æ ‡å¤´é™„åŠ <code>-shadow</code>. ä¾‹å¦‚ï¼Œ<code>cluster-1</code>å˜æˆ<code>cluster-1-shadow</code>ã€‚</p><p>æ­¤å¤–ï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„è¿™äº›è¯·æ±‚è¢«é•œåƒä¸ºâ€œå³å‘å³å¼ƒâ€ï¼Œè¿™æ„å‘³ç€å“åº”è¢«ä¸¢å¼ƒã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¯¥<code>value</code>å­—æ®µä¸‹çš„<code>mirrorPercentage</code>å­—æ®µæ¥é•œåƒä¸€éƒ¨åˆ†æµé‡ï¼Œè€Œä¸æ˜¯é•œåƒæ‰€æœ‰è¯·æ±‚ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œæ‰€æœ‰çš„æµé‡éƒ½ä¼šè¢«é•œåƒã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">mirrorPercentage</span><span class="token punctuation">:</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‘é€æµé‡" tabindex="-1"><a class="header-anchor" href="#å‘é€æµé‡" aria-hidden="true">#</a> å‘é€æµé‡</h4><p>é€šè¿‡å‘é€æµé‡å†æ¬¡è¿›è¡Œæµ‹è¯•ï¼Œæƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li><code>v1</code>ç°åœ¨ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°å’Œçš„è®¿é—®è®°å½•</li><li><code>v2</code>ä¸­åˆ›å»ºçš„è®¿é—®æ—¥å¿—<code>v2</code>æ˜¯å®é™…å°†è¦è®¿é—®çš„é•œåƒè¯·æ±‚<code>v1</code>ã€‚</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;${SLEEP_POD}&quot; -c sleep -- curl -sS http://httpbin:8000/headers</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;a422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;acd7163f70c9aa89&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;f7ca9fb1e0581d6ba422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=ab53dec650eb79f2aa9dc051ed27a2b4b698ee40ffd557cd885495105916a139;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V1_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V2_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†-6" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-6" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤è§„åˆ™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete virtualservice httpbin
$ kubectl delete destinationrule httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³é—­<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æœåŠ¡å’Œå®¢æˆ·ç«¯ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deploy httpbin-v1 httpbin-v2 <span class="token function">sleep</span>
$ kubectl delete svc httpbin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å…¥å£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#å…¥å£ç½‘å…³" aria-hidden="true">#</a> å…¥å£ç½‘å…³</h2><h4 id="å…¥å£ç½‘å…³ç®€è¦" tabindex="-1"><a class="header-anchor" href="#å…¥å£ç½‘å…³ç®€è¦" aria-hidden="true">#</a> å…¥å£ç½‘å…³ç®€è¦</h4><p>é™¤äº†æ”¯æŒ Kubernetes <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" target="_blank" rel="noopener noreferrer">Ingress<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼ŒIstio è¿˜æä¾›äº†å¦ä¸€ç§é…ç½®æ¨¡å‹ï¼Œ<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">å³ Istio Gateway<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚A<code>Gateway</code>æä¾›äº†æ¯” æ›´å¹¿æ³›çš„è‡ªå®šä¹‰å’Œçµæ´»æ€§<code>Ingress</code>ï¼Œå¹¶å…è®¸å°†ç›‘æ§å’Œè·¯ç”±è§„åˆ™ç­‰ Istio åŠŸèƒ½åº”ç”¨äºè¿›å…¥é›†ç¾¤çš„æµé‡ã€‚</p><p>æ­¤ä»»åŠ¡æè¿°äº†å¦‚ä½•é…ç½® Istio ä»¥ä½¿ç”¨ Istio åœ¨æœåŠ¡ç½‘æ ¼ä¹‹å¤–å…¬å¼€æœåŠ¡<code>Gateway</code>ã€‚</p><h4 id="ç¯å¢ƒå‡†å¤‡-5" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-5" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>ç¡®ä¿æ‚¨çš„å½“å‰ç›®å½•æ˜¯è¯¥<code>istio</code>ç›®å½•ã€‚</li><li>å¯åŠ¨<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ã€‚</li></ul><p>â€‹ å¦‚æœæ‚¨å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œè¯·éƒ¨ç½²è¯¥<code>httpbin</code>æœåŠ¡ï¼š</p><p>â€‹ å¦åˆ™ï¼Œæ‚¨å¿…é¡»åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºä¹‹å‰æ‰‹åŠ¨æ³¨å…¥ sidecar <code>httpbin</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¡®å®šå…¥å£ipå’Œç«¯å£" tabindex="-1"><a class="header-anchor" href="#ç¡®å®šå…¥å£ipå’Œç«¯å£" aria-hidden="true">#</a> ç¡®å®šå…¥å£IPå’Œç«¯å£</h4><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¡®å®šæ‚¨çš„ Kubernetes é›†ç¾¤æ˜¯å¦åœ¨æ”¯æŒå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„ç¯å¢ƒä¸­è¿è¡Œï¼ˆ<code>è¿™é‡Œæ²¡æœ‰è´Ÿè½½å‡è¡¡å™¨æ”¹ä¸ºNodePortæ¨¡å¼</code>ï¼‰ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system istio-ingressgateway</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                    AGE
istio-ingressgateway   NodePort   <span class="token number">10.96</span>.88.217   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:28214/TCP,80:27007/TCP,443:9673/TCP,31400:3938/TCP,15443:41053/TCP   4d2h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœ<code>EXTERNAL-IP</code>è®¾ç½®äº†è¯¥å€¼ï¼Œåˆ™æ‚¨çš„ç¯å¢ƒå…·æœ‰å¯ç”¨äºå…¥å£ç½‘å…³çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ã€‚å¦‚æœ<code>EXTERNAL-IP</code>å€¼ä¸º<code>&lt;none&gt;</code>æˆ–æ°¸ä¹…<code>&lt;pending&gt;</code>ï¼Œåˆ™æ‚¨çš„ç¯å¢ƒä¸ä¸ºå…¥å£ç½‘å…³æä¾›å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ã€‚<a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" target="_blank" rel="noopener noreferrer">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æœåŠ¡çš„èŠ‚ç‚¹ç«¯å£<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>è®¿é—®ç½‘å…³ã€‚</p><h4 id="æ·»åŠ ç¯å¢ƒè¯´æ˜" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ ç¯å¢ƒè¯´æ˜" aria-hidden="true">#</a> æ·»åŠ ç¯å¢ƒè¯´æ˜</h4><p>å¦‚æœæ‚¨ç¡®å®šæ‚¨çš„ç¯å¢ƒæ²¡æœ‰å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œè¯·æŒ‰ç…§è¿™äº›è¯´æ˜è¿›è¡Œæ“ä½œï¼Œå› æ­¤æ‚¨éœ€è¦æ”¹ç”¨èŠ‚ç‚¹ç«¯å£ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&#39;{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}&#39;</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328622.png" alt="image-20220318172145022" loading="lazy"></p><h4 id="ä½¿ç”¨istioç½‘å…³é…ç½®å…¥å£" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨istioç½‘å…³é…ç½®å…¥å£" aria-hidden="true">#</a> ä½¿ç”¨Istioç½‘å…³é…ç½®å…¥å£</h4><p>å…¥å£<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">ç½‘å…³<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æè¿°äº†åœ¨ç½‘æ ¼è¾¹ç¼˜è¿è¡Œçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨äºæ¥æ”¶ä¼ å…¥çš„ HTTP/TCP è¿æ¥ã€‚å®ƒé…ç½®æš´éœ²çš„ç«¯å£ã€åè®®ç­‰ï¼Œä½†ä¸<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Resources<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä¸åŒï¼Œå®ƒä¸åŒ…æ‹¬ä»»ä½•æµé‡è·¯ç”±é…ç½®ã€‚å…¥å£æµé‡çš„æµé‡è·¯ç”±æ˜¯ä½¿ç”¨ Istio è·¯ç”±è§„åˆ™é…ç½®çš„ï¼Œä¸å†…éƒ¨æœåŠ¡è¯·æ±‚çš„æ–¹å¼å®Œå…¨ç›¸åŒã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•<code>Gateway</code>ä¸º HTTP æµé‡é…ç½®ç«¯å£ 80ã€‚</p><ol><li>åˆ›å»ºä¸€ä¸ª Istio <code>Gateway</code>ï¼š <ul><li><code>ä½¿ç”¨é»˜è®¤çš„ingressgatewayç½‘å…³</code></li><li><code>åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨è§„èŒƒåˆ—è¡¨ï¼Œåˆ†åˆ«æ˜¯ä¸»æœºå’Œç«¯å£</code></li><li><code>é…ç½®httpæœåŠ¡çš„80ç«¯å£ä»¥åŠä¸»æœºhttpbin.example.com</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ä¸ºé€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›å…¥çš„æµé‡é…ç½®è·¯ç”±<code>Gateway</code>ï¼š <ul><li><code>é…ç½®è™šæ‹ŸæœåŠ¡å…è®¸ä¸»æœºhttpbin.example.com</code></li><li><code>é…è¿½httpçš„è§„åˆ™ä¸ºä¸¤ä¸ªuriçš„ä¸¤ä¸ªå…è®¸è·¯å¾„ã€åˆ†åˆ«æ˜¯statuså’Œdelay</code></li><li><code>é…ç½®ç›®çš„åœ°è§„åˆ™ä¸ºä¸»æœºæ˜¯httpbinç«¯å£ä¸º8080çš„</code></li><li><code>ç½‘å…³åˆ—è¡¨æŒ‡å®šåªå…è®¸é€šè¿‡æ‚¨çš„è¯·æ±‚httpbin-gatewayã€‚æ‰€æœ‰å…¶ä»–å¤–éƒ¨è¯·æ±‚éƒ½å°†è¢« 404 å“åº”æ‹’ç»ã€‚</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ³¨æ„ï¼š</p><p>ç½‘æ ¼ä¸­å…¶ä»–æœåŠ¡çš„å†…éƒ¨è¯·æ±‚ä¸å—è¿™äº›è§„åˆ™çš„çº¦æŸï¼Œè€Œæ˜¯é»˜è®¤ä½¿ç”¨å¾ªç¯è·¯ç”±ã€‚è¦å°†è¿™äº›è§„åˆ™ä¹Ÿåº”ç”¨äºå†…éƒ¨è°ƒç”¨ï¼Œæ‚¨å¯ä»¥å°†ç‰¹æ®Šå€¼æ·»åŠ <code>mesh</code>åˆ°<code>gateways</code>. ç”±äºæœåŠ¡çš„å†…éƒ¨ä¸»æœºåå¯èƒ½ä¸å¤–éƒ¨ä¸»æœºåä¸åŒï¼ˆä¾‹å¦‚ï¼Œ<code>httpbin.default.svc.cluster.local</code>ï¼‰ï¼Œå› æ­¤æ‚¨è¿˜éœ€è¦å°†å…¶æ·»åŠ åˆ°<code>hosts</code>åˆ—è¡¨ä¸­ã€‚</p></blockquote><ol start="3"><li><em>ä½¿ç”¨curl</em>è®¿é—®<em>httpbin</em>æœåŠ¡ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/status/200&quot;</span>
HTTP/1.1 <span class="token number">200</span> OK
server: istio-envoy
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:05:09 GMT
content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
content-length: <span class="token number">0</span>
x-envoy-upstream-service-time: <span class="token number">24</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œæ‚¨ä½¿ç”¨è¯¥<code>-H</code>æ ‡å¿—å°†<em>Host</em> HTTP æ ‡å¤´è®¾ç½®ä¸ºâ€œ<a href="http://httpbin.example.com" target="_blank" rel="noopener noreferrer">httpbin.example.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>â€ã€‚è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæ‚¨çš„å…¥å£<code>Gateway</code>é…ç½®ä¸ºå¤„ç†â€œ<a href="http://httpbin.example.com" target="_blank" rel="noopener noreferrer">httpbin.example.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>â€ï¼Œä½†åœ¨æ‚¨çš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ‚¨æ²¡æœ‰è¯¥ä¸»æœºçš„ DNS ç»‘å®šï¼Œåªæ˜¯å°†æ‚¨çš„è¯·æ±‚å‘é€åˆ°å…¥å£ IPã€‚</p><ol start="4"><li>è®¿é—®å°šæœªæ˜ç¡®å…¬å¼€çš„ä»»ä½•å…¶ä»– URLã€‚æ‚¨åº”è¯¥ä¼šçœ‹åˆ° HTTP 404 é”™è¯¯ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/headers&quot;</span>
HTTP/1.1 <span class="token number">404</span> Not Found
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:29:26 GMT
server: istio-envoy
transfer-encoding: chunked
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨æµè§ˆå™¨è®¿é—®å…¥å£æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æµè§ˆå™¨è®¿é—®å…¥å£æœåŠ¡" aria-hidden="true">#</a> ä½¿ç”¨æµè§ˆå™¨è®¿é—®å…¥å£æœåŠ¡</h4><p>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<code>httpbin</code>æœåŠ¡ URL å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæ‚¨æ— æ³•å°†<em>Host</em>æ ‡å¤´ä¼ é€’ç»™æµè§ˆå™¨ï¼Œå°±åƒä½¿ç”¨<code>curl</code>. åœ¨ç°å®ä¸–ç•Œçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºæ‚¨æ­£ç¡®é…ç½®äº†è¯·æ±‚çš„ä¸»æœºå¹¶ä¸” DNS å¯è§£æã€‚å› æ­¤ï¼Œæ‚¨åœ¨ URL ä¸­ä½¿ç”¨ä¸»æœºçš„åŸŸåï¼Œä¾‹å¦‚<code>https://httpbin.example.com/status/200</code>.</p><p>è¦ä¸ºç®€å•çš„æµ‹è¯•å’Œæ¼”ç¤ºè§£å†³æ­¤é—®é¢˜ï¼Œè¯·åœ¨ å’Œé…ç½®<code>*</code>ä¸­ä¸ºä¸»æœºä½¿ç”¨é€šé…ç¬¦å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°†å…¥å£é…ç½®æ›´æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š<code>Gateway VirtualService</code></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /headers
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æœ¬æœºçš„hosts<code>é…ç½®192.168.1.6:44526/headers httpbin.example.com</code>æ˜ å°„ï¼Œç„¶åé€šè¿‡æµè§ˆå™¨è®¿é—®ã€‚</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202205062328976.png" alt="image-20220320230630481" loading="lazy"></p><h4 id="æ¸…ç†-7" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-7" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤<code>Gateway</code>and<code>VirtualService</code>é…ç½®ï¼Œå…³é—­<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æœåŠ¡ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway httpbin-gateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å®‰å…¨ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨ç½‘å…³" aria-hidden="true">#</a> å®‰å…¨ç½‘å…³</h2><h4 id="å®‰å…¨ç½‘å…³çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨ç½‘å…³çš„ä½œç”¨" aria-hidden="true">#</a> å®‰å…¨ç½‘å…³çš„ä½œç”¨</h4><p>æ§åˆ¶å…¥å£<a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control" target="_blank" rel="noopener noreferrer">æµé‡ä»»åŠ¡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> æè¿°äº†å¦‚ä½•é…ç½®å…¥å£ç½‘å…³ä»¥å°† HTTP æœåŠ¡å…¬å¼€ç»™å¤–éƒ¨æµé‡ã€‚æ­¤ä»»åŠ¡æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨ç®€å•æˆ–åŒå‘ TLS å…¬å¼€å®‰å…¨çš„ HTTPS æœåŠ¡ã€‚</p><h4 id="ç¯å¢ƒå‡†å¤‡-6" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-6" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><ul><li>ç¡®ä¿æ‚¨çš„å½“å‰ç›®å½•æ˜¯è¯¥<code>istio</code>ç›®å½•ã€‚</li><li>å¯åŠ¨<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ã€‚</li></ul><p>â€‹ å¦‚æœæ‚¨å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œè¯·éƒ¨ç½²è¯¥<code>httpbin</code>æœåŠ¡ï¼š</p><p>â€‹ å¦åˆ™ï¼Œæ‚¨å¿…é¡»åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºä¹‹å‰æ‰‹åŠ¨æ³¨å…¥ sidecar <code>httpbin</code>ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥" tabindex="-1"><a class="header-anchor" href="#ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥" aria-hidden="true">#</a> ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥</h4><p>å¯¹äºæ­¤ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„å·¥å…·æ¥ç”Ÿæˆè¯ä¹¦å’Œå¯†é’¥ã€‚ä¸‹é¢çš„å‘½ä»¤ä½¿ç”¨ <a href="https://man.openbsd.org/openssl.1" target="_blank" rel="noopener noreferrer">openssl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ol><li>åˆ›å»ºæ ¹è¯ä¹¦å’Œç§é’¥æ¥ä¸ºæ‚¨çš„æœåŠ¡ç­¾ç½²è¯ä¹¦ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> example.com.key <span class="token parameter variable">-out</span> example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>åˆ›å»ºè¯ä¹¦å’Œç§é’¥<code>httpbin.example.com</code>ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> httpbin.example.com.csr <span class="token parameter variable">-out</span> httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºå•ä¸ªä¸»æœºé…ç½®tlså…¥å£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#ä¸ºå•ä¸ªä¸»æœºé…ç½®tlså…¥å£ç½‘å…³" aria-hidden="true">#</a> ä¸ºå•ä¸ªä¸»æœºé…ç½®TLSå…¥å£ç½‘å…³</h4><ol><li>ä¸ºå…¥å£ç½‘å…³åˆ›å»ºä¸€ä¸ªå¯†é’¥ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="2"><li>ä½¿ç”¨ç«¯å£ 443çš„éƒ¨åˆ†å®šä¹‰ç½‘å…³<code>servers:</code>ï¼Œå¹¶æŒ‡å®š <code>credentialName</code>to beçš„å€¼<code>httpbin-credential</code>ã€‚è¿™äº›å€¼ä¸å¯†é’¥çš„åç§°ç›¸åŒã€‚TLS æ¨¡å¼çš„å€¼åº”ä¸º<code>SIMPLE</code>.</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential <span class="token comment"># must be the same as secret</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>é…ç½®ç½‘å…³çš„å…¥å£æµé‡è·¯ç”±ã€‚å®šä¹‰ç›¸åº”çš„è™šæ‹ŸæœåŠ¡ã€‚</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>å‘é€ HTTPS è¯·æ±‚ä»¥<code>httpbin</code>é€šè¿‡ HTTPS è®¿é—®æœåŠ¡ï¼Œè¯¥<code>httpbin</code>æœåŠ¡å°†è¿”å› <a href="https://tools.ietf.org/html/rfc7168#section-2.3.3" target="_blank" rel="noopener noreferrer">418 I&#39;m a Teapot<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä»£ç ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">15</span>:41:25 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">23</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>åˆ é™¤ç½‘å…³çš„å¯†ç å¹¶åˆ›å»ºä¸€ä¸ªæ–°å¯†ç ä»¥æ›´æ”¹å…¥å£ç½‘å…³çš„å‡­æ®ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ <span class="token function">mkdir</span> new_certificates
$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">&#39;/O=example Inc./CN=example.com&#39;</span> <span class="token parameter variable">-keyout</span> new_certificates/example.com.key <span class="token parameter variable">-out</span> new_certificates/example.com.crt
$ openssl req <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> new_certificates/httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> new_certificates/example.com.crt <span class="token parameter variable">-CAkey</span> new_certificates/example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.crt
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>new_certificates/httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>new_certificates/httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>ä½¿ç”¨æ–°çš„è¯ä¹¦é“¾è®¿é—®<code>httpbin</code>æœåŠ¡ï¼š<code>curl</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> new_certificates/example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">418</span>
<span class="token punctuation">..</span>.
    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>å¦‚æœæ‚¨å°è¯•ä½¿ç”¨<code>httpbin</code>ä»¥å‰çš„è¯ä¹¦é“¾è¿›è¡Œè®¿é—®ï¼Œåˆ™ç°åœ¨å°è¯•å¤±è´¥ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Certificate <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS alert, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> error:04FFF06A:rsa routines:CRYPTO_internal:block <span class="token builtin class-name">type</span> is not 01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¸ºå¤šä¸ªä¸»æœºé…ç½®tlså…¥å£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#ä¸ºå¤šä¸ªä¸»æœºé…ç½®tlså…¥å£ç½‘å…³" aria-hidden="true">#</a> ä¸ºå¤šä¸ªä¸»æœºé…ç½®TLSå…¥å£ç½‘å…³</h4><p>æ‚¨å¯ä»¥ä¸ºå¤šä¸ªä¸»æœºé…ç½®ä¸€ä¸ªå…¥å£ç½‘å…³ <code>httpbin.example.com</code>ï¼Œ<code>helloworld-v1.example.com</code>ä¾‹å¦‚ã€‚å…¥å£ç½‘å…³æ£€ç´¢ä¸ç‰¹å®š<code>credentialName</code>.</p><ol><li>è¦æ¢å¤ çš„å‡­æ®<code>httpbin</code>ï¼Œè¯·åˆ é™¤å…¶å¯†é’¥å¹¶é‡æ–°åˆ›å»ºã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å¯åŠ¨<code>helloworld-v1</code>ç¤ºä¾‹</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
        <span class="token key atrule">image</span><span class="token punctuation">:</span> istio/examples<span class="token punctuation">-</span>helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#Always</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>ç”Ÿæˆè¯ä¹¦å’Œç§é’¥<code>helloworld-v1.example.com</code>ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ openssl req <span class="token parameter variable">-out</span> helloworld-v1.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> helloworld-v1.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=helloworld-v1.example.com/O=helloworld organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">1</span> <span class="token parameter variable">-in</span> helloworld-v1.example.com.csr <span class="token parameter variable">-out</span> helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>åˆ›å»º<code>helloworld-credential</code>å¯†é’¥ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls helloworld-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>helloworld-v1.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>helloworld-v1.example.com.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="5"><li>ä¸ºç«¯å£ 443 å®šä¹‰ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªæœåŠ¡å™¨éƒ¨åˆ†çš„ç½‘å…³ã€‚å°† <code>credentialName</code>æ¯ä¸ªç«¯å£ä¸Šçš„å€¼åˆ†åˆ«è®¾ç½®ä¸º<code>httpbin-credential</code>å’Œ<code>helloworld-credential</code> ã€‚ <ul><li>å°† TLS æ¨¡å¼è®¾ç½®ä¸º<code>SIMPLE</code>æ˜¯å•å‘TLSå…¥å£ç½‘å…³.</li><li>å°† TLS æ¨¡å¼è®¾ç½®ä¸º<code>MUTUAL</code>æ˜¯åŒå‘TLSå…¥å£ç½‘å…³</li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>httpbin
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>helloworld
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li>é…ç½®ç½‘å…³çš„æµé‡è·¯ç”±ã€‚å®šä¹‰ç›¸åº”çš„è™šæ‹ŸæœåŠ¡ã€‚</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /hello
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="7"><li>å‘é€ HTTPS è¯·æ±‚åˆ°<code>helloworld-v1.example.com</code>ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 00:58:24 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">2</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="8"><li>å‘é€ä¸€ä¸ª HTTPS è¯·æ±‚<code>httpbin.example.com</code>å¹¶ä»ç„¶å¾—åˆ°ä¸€ä¸ªèŒ¶å£¶ä½œä¸ºå›æŠ¥ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 01:13:48 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">3</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .&#39;  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¯†é’¥æ ¼å¼" tabindex="-1"><a class="header-anchor" href="#å¯†é’¥æ ¼å¼" aria-hidden="true">#</a> å¯†é’¥æ ¼å¼</h4><p>Istio æ”¯æŒè¯»å–å‡ ç§ä¸åŒçš„ Secret æ ¼å¼ï¼Œä»¥æ”¯æŒä¸å„ç§å·¥å…·çš„é›†æˆï¼Œä¾‹å¦‚<a href="https://istio.io/latest/docs/ops/integrations/certmanager/" target="_blank" rel="noopener noreferrer">cert-manager<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼š</p><ul><li>ä¸€ä¸ª TLS å¯†é’¥ï¼Œå¸¦æœ‰<code>tls.key</code>å’Œ<code>tls.crt</code>ï¼Œå¦‚ä¸Šæ‰€è¿°ã€‚å¯¹äºåŒå‘ TLSï¼Œ<code>ca.crt</code>å¯ä»¥ä½¿ç”¨å¯†é’¥ã€‚</li><li>å¸¦æœ‰é”®çš„é€šç”¨ Secret<code>key</code>å’Œ<code>cert</code>. å¯¹äºåŒå‘ TLSï¼Œ<code>cacert</code>å¯ä»¥ä½¿ç”¨å¯†é’¥ã€‚</li><li>å¸¦æœ‰é”®çš„é€šç”¨ Secret<code>key</code>å’Œ<code>cert</code>. å¯¹äºåŒå‘ TLSï¼Œä¸€ä¸ªåä¸º çš„å•ç‹¬é€šç”¨ Secret<code>&lt;secret&gt;-cacert</code>å¸¦æœ‰ä¸€ä¸ª<code>cacert</code>å¯†é’¥ã€‚ä¾‹å¦‚ï¼Œ<code>httpbin-credential</code>æœ‰<code>key</code>å’Œ<code>cert</code>ï¼Œå¹¶ä¸”<code>httpbin-credential-cacert</code>æœ‰<code>cacert</code>ã€‚</li><li><code>cacert</code>é”®å€¼å¯ä»¥æ˜¯ä¸€ä¸ª CA æ†ç»‘åŒ…ï¼Œç”±ä¸²è”çš„å„ä¸ª CA è¯ä¹¦ç»„æˆã€‚</li></ul><h4 id="æ¸…ç†-8" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-8" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤ç½‘å…³é…ç½®ã€è™šæ‹ŸæœåŠ¡å®šä¹‰å’Œæœºå¯†ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway mygateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-n</span> istio-system secret httpbin-credential <span class="token punctuation">\</span>
helloworld-credential
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true virtualservice helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ é™¤è¯ä¹¦å’Œå¯†é’¥ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> example.com.crt example.com.key httpbin.example.com.crt httpbin.example.com.key httpbin.example.com.csr helloworld-v1.example.com.crt helloworld-v1.example.com.key helloworld-v1.example.com.csr client.example.com.crt client.example.com.csr client.example.com.key ./new_certificates
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å…³é—­<code>httpbin</code>å’Œ<code>helloworld-v1</code>æœåŠ¡ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete deployment --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
$ kubectl delete <span class="token function">service</span> --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‡ºå£tlså‘èµ·" tabindex="-1"><a class="header-anchor" href="#å‡ºå£tlså‘èµ·" aria-hidden="true">#</a> å‡ºå£TLSå‘èµ·</h2><h4 id="ä»€ä¹ˆæ˜¯tlså‘èµ·" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯tlså‘èµ·" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯TLSå‘èµ·</h4><p>ç”¨äºé…ç½® Istio ä»¥å—æ§æ–¹å¼è®¿é—®å¤–éƒ¨æœåŠ¡ã€‚è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•é…ç½® Istio æ¥æ‰§è¡Œ<a href="https://istio.io/latest/docs/reference/config/networking/service-entry/" target="_blank" rel="noopener noreferrer"><code>ServiceEntry</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>TLS å‘èµ· ç”¨äºåˆ°å¤–éƒ¨æœåŠ¡çš„æµé‡ã€‚å½“åŸå§‹æµé‡ä¸º HTTP æ—¶ï¼ŒIstio å°†æ‰“å¼€ä¸å¤–éƒ¨æœåŠ¡çš„ HTTPS è¿æ¥ã€‚</p><p>è€ƒè™‘ä¸€ä¸ªå¯¹å¤–éƒ¨ç«™ç‚¹æ‰§è¡Œ HTTP è°ƒç”¨çš„é—ç•™åº”ç”¨ç¨‹åºã€‚å‡è®¾è¿è¡Œåº”ç”¨ç¨‹åºçš„ç»„ç»‡æ”¶åˆ°ä¸€ä¸ªæ–°è¦æ±‚ï¼Œè¦æ±‚æ‰€æœ‰å¤–éƒ¨æµé‡éƒ½å¿…é¡»åŠ å¯†ã€‚ä½¿ç”¨ Istioï¼Œåªéœ€é…ç½®å³å¯å®ç°æ­¤è¦æ±‚ï¼Œæ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•ä»£ç ã€‚åº”ç”¨ç¨‹åºå¯ä»¥å‘é€æœªåŠ å¯†çš„ HTTP è¯·æ±‚ï¼Œç„¶å Istio å°†ä¸ºåº”ç”¨ç¨‹åºåŠ å¯†å®ƒä»¬ã€‚</p><p>ä»æºå‘é€æœªåŠ å¯†çš„ HTTP è¯·æ±‚å¹¶è®© Istio æ‰§è¡Œ TLS å‡çº§çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ Istio å¯ä»¥ç”Ÿæˆæ›´å¥½çš„é¥æµ‹æ•°æ®å¹¶ä¸ºæœªåŠ å¯†çš„è¯·æ±‚æä¾›æ›´å¤šçš„è·¯ç”±æ§åˆ¶ã€‚</p><h4 id="ç¯å¢ƒå‡†å¤‡-7" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡-7" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><p>å¯åŠ¨å°†ç”¨ä½œå¤–éƒ¨è°ƒç”¨æµ‹è¯•æºçš„<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">ç¡çœ æ ·æœ¬ã€‚<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å¦‚æœæ‚¨å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨è¾¹è½¦æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼Œè¯·éƒ¨ç½²<code>sleep</code>åº”ç”¨ç¨‹åºï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥<code>exec</code>å’Œ<code>curl</code>æ¥è‡ªçš„ä»»ä½• pod éƒ½å°†æ‰§è¡Œä»¥ä¸‹è¿‡ç¨‹ã€‚</p><p>åˆ›å»ºä¸€ä¸ª shell å˜é‡æ¥ä¿å­˜ç”¨äºå‘å¤–éƒ¨æœåŠ¡å‘é€è¯·æ±‚çš„æº pod çš„åç§°ã€‚å¦‚æœæ‚¨ä½¿ç”¨äº†<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ï¼Œè¯·è¿è¡Œï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="é…ç½®å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®" tabindex="-1"><a class="header-anchor" href="#é…ç½®å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®" aria-hidden="true">#</a> é…ç½®å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®</h4><p>é¦–å…ˆä½¿ç”¨<a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control" target="_blank" rel="noopener noreferrer">è®¿é—®å¤–éƒ¨æœåŠ¡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä»»åŠ¡<code>edition.cnn.com</code>ä¸­æ˜¾ç¤ºçš„ç›¸åŒæŠ€æœ¯é…ç½®å¯¹å¤–éƒ¨æœåŠ¡çš„è®¿é—®ã€‚ä½†æ˜¯ï¼Œè¿™ä¸€æ¬¡ä½¿ç”¨å•ä¸ªæ¥å¯ç”¨å¯¹æœåŠ¡çš„ HTTP å’Œ HTTPS è®¿é—®ã€‚<code>ServiceEntry</code></p><ol><li>åˆ›å»ºä¸€ä¸ª<code>ServiceEntry</code>ä»¥å¯ç”¨å¯¹<code>edition.cnn.com</code>ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å‘å¤–éƒ¨ HTTP æœåŠ¡å‘å‡ºè¯·æ±‚ï¼š</li></ol><blockquote><p>æ³¨æ„ curl çš„<em>æ ‡å¿—</em><code>-L</code>ï¼Œå®ƒæŒ‡ç¤º<em>curl</em>éµå¾ªé‡å®šå‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¸º HTTP è¯·æ±‚è¿”å›äº†é‡å®šå‘å“åº”ï¼ˆ<a href="https://tools.ietf.org/html/rfc2616#section-10.3.2" target="_blank" rel="noopener noreferrer">301 Moved Permanently<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼‰ ã€‚é‡å®šå‘å“åº”æŒ‡ç¤ºå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé¢å¤–çš„è¯·æ±‚ï¼Œè¿™æ¬¡ä½¿ç”¨ HTTPSï¼Œåˆ°. å¯¹äºç¬¬äºŒä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›è¯·æ±‚çš„å†…å®¹å’Œ<em>200 OK</em>çŠ¶æ€ç ã€‚<code>http://edition.cnn.com/politics``https://edition.cnn.com/politics</code></p><p>å°½ç®¡<em>curl</em>å‘½ä»¤é€æ˜åœ°å¤„ç†äº†é‡å®šå‘ï¼Œä½†è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å†—ä½™è¯·æ±‚ï¼Œå®ƒä½¿è·å–<code>http://edition.cnn.com/politics</code>. ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ URL çš„è·¯å¾„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯<em>æ”¿æ²»</em>ï¼Œæ˜¯ä»¥æ˜æ–‡å½¢å¼å‘é€çš„ã€‚å¦‚æœæœ‰æ”»å‡»è€…å—…æ¢ä½ çš„åº”ç”¨ç¨‹åºå’Œ ä¹‹é—´çš„é€šä¿¡<code>edition.cnn.com</code>ï¼Œæ”»å‡»è€…å°±ä¼šçŸ¥é“<code>edition.cnn.com</code>åº”ç”¨ç¨‹åºè·å–äº†å“ªäº›ç‰¹å®šä¸»é¢˜ã€‚å‡ºäºéšç§åŸå› ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é˜»æ­¢æ­¤ç±»æŠ«éœ²ã€‚</p><p><strong>è¿™ä¸¤ä¸ªé—®é¢˜éƒ½å¯ä»¥é€šè¿‡é…ç½® Istio æ¥æ‰§è¡Œ TLS å‘èµ·æ¥è§£å†³ã€‚</strong></p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‡ºå£æµé‡çš„tlså‘èµ·" tabindex="-1"><a class="header-anchor" href="#å‡ºå£æµé‡çš„tlså‘èµ·" aria-hidden="true">#</a> å‡ºå£æµé‡çš„TLSå‘èµ·</h4><ol><li>é‡æ–°å®šä¹‰<code>ServiceEntry</code>ä¸Šä¸€èŠ‚ä¸­çš„å°† HTTP è¯·æ±‚é‡å®šå‘åˆ°ç«¯å£ 443 å¹¶æ·»åŠ ä¸€ä¸ª<code>DestinationRule</code>ä»¥æ‰§è¡Œ TLS å‘èµ·ï¼š <ul><li><code>é…ç½®æœåŠ¡å…¥å£çš„httpé‡å®šå‘åˆ°443ç«¯å£</code></li><li><code>é…ç½®äº¤é€šç­–ç•¥é’ˆå¯¹80ç«¯å£ä½¿ç”¨æ¨¡å¼ä¸ºSIMPLEçš„tls</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE <span class="token comment"># initiates HTTPS when accessing edition.cnn.com</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Š<code>DestinationRule</code>å°†ä¸ºç«¯å£ 80 ä¸Šçš„ HTTP è¯·æ±‚æ‰§è¡Œ TLS å‘èµ·ï¼Œ<code>ServiceEntry</code> ç„¶åå°†ç«¯å£ 80 ä¸Šçš„è¯·æ±‚é‡å®šå‘åˆ°ç›®æ ‡ç«¯å£ 443ã€‚</p><ol start="2"><li>å‘ å‘é€ HTTP è¯·æ±‚<code>http://edition.cnn.com/politics</code>ï¼Œå¦‚ä¸Šä¸€èŠ‚æ‰€è¿°ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">200</span> OK
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ¬¡æ‚¨æ”¶åˆ°<em>200 OK</em>ä½œä¸ºç¬¬ä¸€ä¸ªä¹Ÿæ˜¯å”¯ä¸€çš„å“åº”ã€‚Istio ä¸º<em>curl</em>æ‰§è¡Œ TLS å‘èµ·ï¼Œå› æ­¤åŸå§‹ HTTP è¯·æ±‚è¢«è½¬å‘<code>edition.cnn.com</code>ä¸º HTTPSã€‚æœåŠ¡å™¨ç›´æ¥è¿”å›å†…å®¹ï¼Œæ— éœ€é‡å®šå‘ã€‚æ‚¨æ¶ˆé™¤äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒé‡å¾€è¿”ï¼Œå¹¶ä¸”è¯·æ±‚ä½¿ç½‘æ ¼åŠ å¯†ï¼Œè€Œæ²¡æœ‰æŠ«éœ²æ‚¨çš„åº”ç”¨ç¨‹åº<em>è·å–</em>.<code>edition.cnn.com</code></p><p>è¯·æ³¨æ„ï¼Œæ‚¨ä½¿ç”¨äº†ä¸ä¸Šä¸€èŠ‚ä¸­ç›¸åŒçš„å‘½ä»¤ã€‚å¯¹äºä»¥ç¼–ç¨‹æ–¹å¼è®¿é—®å¤–éƒ¨æœåŠ¡çš„åº”ç”¨ç¨‹åºï¼Œæ— éœ€æ›´æ”¹ä»£ç ã€‚æ‚¨å¯ä»¥é€šè¿‡é…ç½® Istio è·å¾— TLS å‘èµ·çš„å¥½å¤„ï¼Œè€Œæ— éœ€æ›´æ”¹ä¸€è¡Œä»£ç ã€‚</p><ol start="3"><li>è¯·æ³¨æ„ï¼Œä½¿ç”¨ HTTPS è®¿é—®å¤–éƒ¨æœåŠ¡çš„åº”ç”¨ç¨‹åºç»§ç»­åƒä»¥å‰ä¸€æ ·å·¥ä½œï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†-9" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†-9" aria-hidden="true">#</a> æ¸…ç†</h4><p>åˆ é™¤æ‚¨åˆ›å»ºçš„ Istio é…ç½®é¡¹ã€å…³é—­<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">ç¡çœ <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æœåŠ¡ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry edition-cnn-com
$ kubectl delete destinationrule edition-cnn-com
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‡ºå£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#å‡ºå£ç½‘å…³" aria-hidden="true">#</a> å‡ºå£ç½‘å…³</h2><h4 id="ä»€ä¹ˆæ˜¯å‡ºå£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯å‡ºå£ç½‘å…³" aria-hidden="true">#</a> ä»€ä¹ˆæ˜¯å‡ºå£ç½‘å…³</h4><p>Istio ä½¿ç”¨<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">å…¥å£å’Œå‡ºå£ç½‘å…³<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> æ¥é…ç½®åœ¨æœåŠ¡ç½‘æ ¼è¾¹ç¼˜æ‰§è¡Œçš„è´Ÿè½½å‡è¡¡å™¨ã€‚å…¥å£ç½‘å…³å…è®¸æ‚¨å®šä¹‰æ‰€æœ‰ä¼ å…¥æµé‡æµè¿‡çš„ç½‘æ ¼çš„å…¥å£ç‚¹ã€‚å‡ºå£ç½‘å…³æ˜¯ä¸€ä¸ªå¯¹ç§°çš„æ¦‚å¿µï¼›å®ƒå®šä¹‰äº†ç½‘æ ¼çš„å‡ºå£ç‚¹ã€‚å‡ºå£ç½‘å…³å…è®¸æ‚¨å°† Istio åŠŸèƒ½ï¼ˆä¾‹å¦‚ç›‘æ§å’Œè·¯ç”±è§„åˆ™ï¼‰åº”ç”¨äºé€€å‡ºç½‘æ ¼çš„æµé‡ã€‚</p><p>è€ƒè™‘ä¸€ä¸ªå…·æœ‰ä¸¥æ ¼å®‰å…¨è¦æ±‚çš„ç»„ç»‡ï¼Œå³æ‰€æœ‰ç¦»å¼€æœåŠ¡ç½‘æ ¼çš„æµé‡éƒ½å¿…é¡»æµç»ä¸€ç»„ä¸“ç”¨èŠ‚ç‚¹ã€‚è¿™äº›èŠ‚ç‚¹å°†åœ¨ä¸“ç”¨æœºå™¨ä¸Šè¿è¡Œï¼Œä¸é›†ç¾¤ä¸­è¿è¡Œåº”ç”¨ç¨‹åºçš„å…¶ä½™èŠ‚ç‚¹åˆ†å¼€ã€‚è¿™äº›ç‰¹æ®ŠèŠ‚ç‚¹å°†ç”¨äºå¯¹å‡ºå£æµé‡æ‰§è¡Œç­–ç•¥ï¼Œå¹¶ä¸”å°†æ¯”å…¶ä»–èŠ‚ç‚¹æ›´å½»åº•åœ°ç›‘æ§ã€‚</p><p>å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯åº”ç”¨ç¨‹åºèŠ‚ç‚¹æ²¡æœ‰å…¬å…± IP çš„é›†ç¾¤ï¼Œå› æ­¤åœ¨å®ƒä»¬ä¸Šè¿è¡Œçš„ç½‘å†…æœåŠ¡æ— æ³•è®¿é—® Internetã€‚å®šä¹‰ä¸€ä¸ªå‡ºå£ç½‘å…³ï¼Œå¼•å¯¼æ‰€æœ‰å‡ºå£æµé‡é€šè¿‡å®ƒï¼Œå¹¶å°†å…¬å…± IP åˆ†é…ç»™å‡ºå£ç½‘å…³èŠ‚ç‚¹ï¼Œå…è®¸åº”ç”¨ç¨‹åºèŠ‚ç‚¹ä»¥å—æ§æ–¹å¼è®¿é—®å¤–éƒ¨æœåŠ¡ã€‚</p><h4 id="åŸºç¡€ç¯å¢ƒ-2" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€ç¯å¢ƒ-2" aria-hidden="true">#</a> åŸºç¡€ç¯å¢ƒ</h4><p>éƒ¨ç½²<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹åº”ç”¨ç¨‹åºä»¥ç”¨ä½œå‘é€è¯·æ±‚çš„æµ‹è¯•æºã€‚å¦‚æœæ‚¨ å¯ç”¨äº†<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">è‡ªåŠ¨ Sidecar æ³¨å…¥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†<code>SOURCE_POD</code>ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºæº pod çš„åç§°ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="éƒ¨ç½²istioå‡ºå£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²istioå‡ºå£ç½‘å…³" aria-hidden="true">#</a> éƒ¨ç½²Istioå‡ºå£ç½‘å…³</h4><ol><li>æ£€æŸ¥æ˜¯å¦éƒ¨ç½²äº† Istio å‡ºå£ç½‘å…³ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>egressgateway <span class="token parameter variable">-n</span> istio-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æœ‰è¿”å› podï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤éƒ¨ç½² Istio å‡ºå£ç½‘å…³ã€‚</p><ol start="2"><li>å¦‚æœæ‚¨ä½¿ç”¨<code>IstioOperator</code>CR å®‰è£… Istioï¼Œè¯·å°†ä»¥ä¸‹å­—æ®µæ·»åŠ åˆ°æ‚¨çš„é…ç½®ä¸­ï¼š</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">components</span><span class="token punctuation">:</span>
    <span class="token key atrule">egressGateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦åˆ™ï¼Œå°†ç­‰æ•ˆè®¾ç½®æ·»åŠ åˆ°æ‚¨çš„åŸå§‹<code>istioctl install</code>å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ istioctl <span class="token function">install</span> <span class="token operator">&lt;</span>flags-you-used-to-install-Istio<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.name<span class="token operator">=</span>istio-egressgateway <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.enabled<span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="httpæµé‡çš„å‡ºå£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#httpæµé‡çš„å‡ºå£ç½‘å…³" aria-hidden="true">#</a> HTTPæµé‡çš„å‡ºå£ç½‘å…³</h4><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>ServiceEntry</code>å…è®¸ç›´æ¥æµé‡åˆ°å¤–éƒ¨æœåŠ¡ã€‚</p><ol><li><code>ServiceEntry</code>ä¸ºå®šä¹‰ä¸€ä¸ª<code>edition.cnn.com</code>ã€‚ <ul><li><code>é…ç½®ä¸»æœºä¸ºedition.cnn.com</code></li><li><code>é…ç½®ä¸»æœºå‘ç°æ¨¡å¼ä¸ºDNS</code></li><li><code>é…ç½®HTTPå’ŒHTTPSä¸¤ä¸ªåè®®</code></li></ul></li></ol><blockquote><p><code>DNS</code>å¿…é¡»åœ¨ä¸‹é¢çš„æœåŠ¡æ¡ç›®ä¸­ä½¿ç”¨åˆ†è¾¨ç‡ã€‚å¦‚æœåˆ†è¾¨ç‡ä¸º<code>NONE</code>ï¼Œç½‘å…³å°†åœ¨æ— é™å¾ªç¯ä¸­å°†æµé‡å®šå‘åˆ°è‡ªèº«ã€‚è¿™æ˜¯å› ä¸ºç½‘å…³æ¥æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œå…¶åŸå§‹ç›®æ ‡ IP åœ°å€ç­‰äºç½‘å…³çš„æœåŠ¡ IPï¼ˆå› ä¸ºè¯·æ±‚æ˜¯ç”± Sidecar ä»£ç†å®šå‘åˆ°ç½‘å…³çš„ï¼‰ã€‚é€šè¿‡<code>DNS</code>è§£æï¼Œç½‘å…³æ‰§è¡Œ DNS æŸ¥è¯¢ä»¥è·å–å¤–éƒ¨æœåŠ¡çš„ IP åœ°å€å¹¶å°†æµé‡å®šå‘åˆ°è¯¥ IP åœ°å€ã€‚</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p><a href="http://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">é€šè¿‡å‘http://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>ServiceEntry</code>å‘é€ HTTP è¯·æ±‚æ¥éªŒè¯æ‚¨çš„åº”ç”¨æ˜¯å¦æ­£ç¡®ã€‚</p><p>è¾“å‡ºåº”ä¸ <a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/" target="_blank" rel="noopener noreferrer">TLS Origination for Egress Traffic<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ç¤ºä¾‹ä¸­çš„ç›¸åŒï¼Œä½†æ²¡æœ‰ TLS å‘èµ·ã€‚</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>Gateway</code>ä¸º<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>åˆ›å»ºä¸€ä¸ªå‡ºå£ï¼Œç«¯å£ 80ï¼Œå¹¶ä¸ºå®šå‘åˆ°å‡ºå£ç½‘å…³çš„æµé‡åˆ›å»ºä¸€ä¸ªç›®æ ‡è§„åˆ™ã€‚ <ul><li><code>é…ç½®å‡ºå£ç½‘å…³ä¸ºegressgateway</code></li><li><code>é…ç½®ä¸»æœºedition.cnn.comè§„èŒƒä¸ºå…è®¸80ç«¯å£</code></li><li><code>åˆ›å»ºè·¯ç”±è§„åˆ™ä¸»æœºä½¿ç”¨ istio-egressgateway.istio-system.svc.cluster.local</code></li><li><code>è·¯ç”±è§„åˆ™ä¸‹çš„å­é›†ä½¿ç”¨cnn</code></li></ul></li></ol><blockquote><p>è¦é€šè¿‡å‡ºå£ç½‘å…³å¼•å¯¼å¤šä¸ªä¸»æœºï¼Œæ‚¨å¯ä»¥<code>*</code>åœ¨<code>Gateway</code>. åº”å°† ä¸­çš„<code>subset</code>å­—æ®µé‡æ–°ç”¨äºå…¶ä»–ä¸»æœºã€‚<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>å®šä¹‰ <code>VirtualService</code>ä»¥å°†æµé‡ä» sidecar å¼•å¯¼åˆ° egress ç½‘å…³ï¼Œå¹¶ä» egress ç½‘å…³å¼•å¯¼åˆ°å¤–éƒ¨æœåŠ¡ï¼š <ul><li><code>å®šä¹‰ä¸»æœºåœ°å€ä¸ºedition.cnn.com</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡ä½¿ç”¨ä¸¤ä¸ªç½‘å…³ istio-egressgatewayå’Œmesh</code></li><li><code>é…ç½®httpè§„åˆ™åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªç½‘å…³éƒ½æ˜¯å…è®¸80ç«¯å£</code></li><li><code>é…ç½®meshçš„è·¯ç”±è§„åˆ™å…è®¸ä¸»æœº istio-egressgateway.istio-system.svc.cluster.local ã€å­é›†ä¸ºcnnã€ç«¯å£æ˜¯80 ã€æƒé‡åˆ†é…ä¸º100</code></li><li><code>é…ç½®istio-egressgatewayçš„è·¯ç”±è§„åˆ™å…è®¸ä¸»æœºä¸ºedition.cnn.comã€ç«¯å£æ˜¯80ã€æƒé‡åˆ†é…ä¹Ÿæ˜¯100</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token punctuation">-</span> mesh
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>å°† HTTP è¯·æ±‚é‡æ–°å‘é€åˆ°<a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">http://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li><p>æ£€æŸ¥<code>istio-egressgateway</code>pod çš„æ—¥å¿—ä¸­æ˜¯å¦æœ‰ä¸æˆ‘ä»¬çš„è¯·æ±‚ç›¸å¯¹åº”çš„è¡Œã€‚å¦‚æœ Istio éƒ¨ç½²åœ¨<code>istio-system</code>å‘½åç©ºé—´ä¸­ï¼Œæ‰“å°æ—¥å¿—çš„å‘½ä»¤æ˜¯ï¼š</p><p>è¯·æ³¨æ„ï¼Œæ‚¨ä»…å°†æµé‡ä»ç«¯å£ 80 é‡å®šå‘åˆ°å‡ºå£ç½‘å…³ã€‚åˆ°ç«¯å£ 443 çš„ HTTPS æµé‡ç›´æ¥è½¬åˆ°<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>ã€‚</p></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail</span>
<span class="token number">2022</span>-03-21T09:42:18.336211Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:14:36.196020Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:47:07.424114Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:15:16.460832Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:42:49.235363Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:20.947Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> UF,URX - - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">15</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.65.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com - <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33384 edition.cnn.com -
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†httpç½‘å…³" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†httpç½‘å…³" aria-hidden="true">#</a> æ¸…ç†HTTPç½‘å…³</h4><p>åœ¨ç»§ç»­ä¸‹ä¸€æ­¥ä¹‹å‰åˆ é™¤ä»¥å‰çš„å®šä¹‰ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete gateway istio-egressgateway
$ kubectl delete serviceentry cnn
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="httpsæµé‡çš„å‡ºå£ç½‘å…³" tabindex="-1"><a class="header-anchor" href="#httpsæµé‡çš„å‡ºå£ç½‘å…³" aria-hidden="true">#</a> HTTPSæµé‡çš„å‡ºå£ç½‘å…³</h4><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å°†é€šè¿‡å‡ºå£ç½‘å…³å¼•å¯¼ HTTPS æµé‡ï¼ˆç”±åº”ç”¨ç¨‹åºå‘èµ·çš„ TLSï¼‰ã€‚æ‚¨éœ€è¦<code>TLS</code>åœ¨ä¸€ä¸ªå¯¹åº”<code>ServiceEntry</code>çš„ã€ä¸€ä¸ªå‡ºå£<code>Gateway</code>å’Œä¸€ä¸ª<code>VirtualService</code>.</p><ol><li><code>ServiceEntry</code>ä¸ºå®šä¹‰ä¸€ä¸ª<code>edition.cnn.com</code>ï¼š <ul><li><code>é…ç½®æœåŠ¡å…¥å£çš„ä¸»æœºåˆ—è¡¨ä¸º edition.cnn.com</code></li><li><code>é…ç½®portsè§„åˆ™ä¸ºTLSæ¨¡å¼ä»¥åŠ443ç«¯å£</code></li><li><code>é…ç½®ä¸»æœºå‘ç°æ¨¡å¼ä¸ºDNS</code></li></ul></li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">é€šè¿‡å‘https://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><code>ServiceEntry</code>å‘é€ HTTPS è¯·æ±‚æ¥éªŒè¯æ‚¨çš„åº”ç”¨æ˜¯å¦æ­£ç¡®ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><code>Gateway</code>ä¸º<em><a href="http://edition.cnn.com" target="_blank" rel="noopener noreferrer">edition.cnn.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em>åˆ›å»ºä¸€ä¸ªå‡ºå£ã€ä¸€ä¸ªç›®æ ‡è§„åˆ™å’Œä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼Œä»¥å¼•å¯¼æµé‡é€šè¿‡å‡ºå£ç½‘å…³å¹¶ä»å‡ºå£ç½‘å…³åˆ°å¤–éƒ¨æœåŠ¡ã€‚ <ul><li><code>åˆ›å»ºæœåŠ¡ç½‘å…³å’Œç›®æ ‡è§„åˆ™ä»¥åŠè™šæ‹ŸæœåŠ¡</code></li><li><code>é…ç½®Gatewayä½¿ç”¨egressgatewayçš„å‡ºå£ç½‘å…³,æœåŠ¡è§„åˆ™ä¸ºå…è®¸443ç«¯å£ä½¿ç”¨TLS</code></li><li><code>Gatewayå…è®¸çš„ä¸»æœºä¸º edition.cnn.com tlsçš„æ¨¡å¼ä½¿ç”¨PASSTHROUGH</code></li><li><code>é…ç½®ç›®æ ‡è§„åˆ™å…è®¸çš„ä¸»æœºåˆ—è¡¨istio-egressgateway.istio-system.svc.cluster.local å­é›†ä¸ºcnn</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡å…è®¸ä¸»æœºåˆ—è¡¨ä¸ºedition.cnn.com</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡ä½¿ç”¨å‡ºå£ç½‘å…³istio-egressgatewayå’Œmesh</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡çš„meshç½‘å…³è¦åŒ¹é…çš„SNIï¼ˆæœåŠ¡å™¨åç§°æŒ‡ç¤ºå™¨ï¼‰edition.cnn.com å…è®¸443ç«¯å£</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡çš„meshç½‘å…³ç›®æ ‡è§„åˆ™å…è®¸ä¸»æœºåˆ—è¡¨istio-egressgateway.istio-system.svc.cluster.localå¹¶ä¸”å…è®¸443ç«¯å£</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡çš„istio-egressgatewayç½‘å…³è¦åŒ¹é…çš„SNIï¼ˆæœåŠ¡å™¨åç§°æŒ‡ç¤ºå™¨ï¼‰edition.cnn.com å…è®¸443ç«¯å£</code></li><li><code>é…ç½®è™šæ‹ŸæœåŠ¡çš„istio-egressgatewayç½‘å…³ç›®æ ‡è§„åˆ™å…è®¸ä¸»æœºåˆ—è¡¨edition.cnn.comå¹¶ä¸”å…è®¸443ç«¯å£ã€æƒé‡ä¸º100</code></li></ul></li></ol><blockquote><p>è¦é€šè¿‡å‡ºå£ç½‘å…³å¼•å¯¼å¤šä¸ªä¸»æœºï¼Œæ‚¨å¯ä»¥<code>*</code>åœ¨<code>Gateway</code>. åº”å°† ä¸­çš„<code>subset</code>å­—æ®µé‡æ–°ç”¨äºå…¶ä»–ä¸»æœºã€‚<code>DestinationRule</code></p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> PASSTHROUGH
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mesh
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">å‘https://edition.cnn.com/politics<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>å‘é€ HTTPS è¯·æ±‚ã€‚è¾“å‡ºåº”è¯¥å’Œä»¥å‰ä¸€æ ·ã€‚</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>æŸ¥çœ‹å‡ºå£ç½‘å…³ä»£ç†çš„æ—¥å¿—ã€‚å¦‚æœ Istio éƒ¨ç½²åœ¨<code>istio-system</code>å‘½åç©ºé—´ä¸­ï¼Œæ‰“å°æ—¥å¿—çš„å‘½ä»¤æ˜¯ï¼š</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -n istio-system</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
<span class="token number">2022</span>-03-21T13:15:59.020699Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T13:40:14.303559Z     info    ads     XDS: Incremental Pushing:0 ConnectedEndpoints:2 Version:
<span class="token number">2022</span>-03-21T13:40:14.597921Z     info    cache   generated new workload certificate   <span class="token assign-left variable">latency</span><span class="token operator">=</span><span class="token number">294</span>.218007ms <span class="token assign-left variable">ttl</span><span class="token operator">=</span>23h59m59.402089572s
<span class="token number">2022</span>-03-21T13:40:14.598006Z     info    ads     SDS: PUSH <span class="token keyword">for</span> node:istio-egressgateway-7f4864f59c-q5cdv.istio-system resources:1 size:4.0kB resource:default
<span class="token number">2022</span>-03-21T13:47:00.985263Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T14:18:49.713637Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†httpsç½‘å…³" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†httpsç½‘å…³" aria-hidden="true">#</a> æ¸…ç†HTTPSç½‘å…³</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ kubectl delete serviceentry cnn
$ kubectl delete gateway istio-egressgateway
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/theme-docs/src/zh/pip/istio/3.Istioçš„æ·±å…¥æµ….md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: isicman@163.com">yyz</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/cicd/zh/pip/istio/2.Istio%E5%AE%89%E8%A3%85.html" class="nav-link prev" aria-label="Istioå®‰è£…"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Istioå®‰è£…</div></a><a href="/cicd/zh/pip/istio/4.Istio%E7%BB%83%E4%B9%A0%E9%A2%98.html" class="nav-link next" aria-label="Istioç»ƒä¹ é¢˜"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">Istioç»ƒä¹ é¢˜<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2022 isKcount</div></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/cicd/assets/app.4cf02e25.js" defer></script>
  </body>
</html>
